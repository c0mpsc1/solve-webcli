

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>gateone &mdash; Gate One 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/ansi.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="top" title="Gate One 1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Gate One Documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for gateone</h1><div class="highlight"><pre>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c">#       Copyright 2011 Liftoff Software Corporation</span>
<span class="c">#</span>
<span class="c"># For license information see LICENSE.txt</span>

<span class="c"># 1.0 TODO:</span>
<span class="c"># * DOCUMENTATION!</span>
<span class="c"># * Write init scripts to stop/start/restart Gate One safely.  Also make sure that .deb and .rpm packages safely restart Gate One without impacting running sessions.  The setup.py should also attempt to minify the .css and .js files.</span>

<span class="c"># Meta</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;0.9&#39;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s">&quot;AGPLv3 or Proprietary (see LICENSE.txt)&quot;</span>
<span class="n">__version_info__</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Dan McDougall &lt;daniel.mcdougall@liftoffsoftware.com&gt;&#39;</span>

<span class="c"># NOTE: Docstring includes reStructuredText markup for use with Sphinx.</span>
<span class="n">__doc__</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;</span><span class="se">\</span>
<span class="s">.. _gateone.py:</span>

<span class="s">Gate One</span>
<span class="s">========</span>
<span class="s">Gate One is a web-based terminal emulator written in Python using the Tornado</span>
<span class="s">web framework.  This module runs the primary daemon process and acts as a</span>
<span class="s">central controller for all running terminals and terminal programs.  It supports</span>
<span class="s">numerous configuration options and can also be called with the --kill switch</span>
<span class="s">to kill all running terminal programs (if using dtach--otherwise they die on</span>
<span class="s">their own when gateone.py is stopped).</span>

<span class="s">Dependencies</span>
<span class="s">------------</span>
<span class="s">Gate One requires Python 2.6+ but runs best with Python 2.7+.  It also depends</span>
<span class="s">on the following 3rd party Python modules:</span>

<span class="s"> * `Tornado &lt;http://www.tornadoweb.org/&gt;`_ 2.2+ - A non-blocking web server framework that powers FriendFeed.</span>

<span class="s">The following modules are optional and can provide Gate One with additional</span>
<span class="s">functionality:</span>

<span class="s"> * `pyOpenSSL &lt;https://launchpad.net/pyopenssl&gt;`_ 0.10+ - An OpenSSL module/wrapper for Python.  Only used to generate self-signed SSL keys and certificates.  If pyOpenSSL isn&#39;t available Gate One will fall back to using the &#39;openssl&#39; command to generate self-signed certificates.</span>
<span class="s"> * `kerberos &lt;http://pypi.python.org/pypi/kerberos&gt;`_ 1.0+ - A high-level Kerberos interface for Python.  Only necessary if you plan to use the Kerberos authentication module.</span>
<span class="s"> * `python-pam &lt;http://packages.debian.org/lenny/python-pam&gt;`_ 0.4.2+ - A Python module for interacting with PAM (the Pluggable Authentication Module present on nearly every Unix).  Only necessary if you plan to use PAM authentication.</span>

<span class="s">With the exception of python-pam, both the required and optional modules can usually be installed via one of these commands:</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@modern-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo pip install tornado pyopenssl kerberos</span>

<span class="s">...or:</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@legacy-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo easy_install tornado pyopenssl kerberos</span>

<span class="s">.. note:: The use of pip is recommended.  See http://www.pip-installer.org/en/latest/installing.html if you don&#39;t have it.</span>

<span class="s">The python-pam module is available in most Linux distribution repositories.  Simply executing one of the following should take care of it:</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@debian-or-ubuntu-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo apt-get install python-pam</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@redhat-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo yum install python-pam</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@gentoo-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo emerge python-pam</span>

<span class="s">    .. ansi-block::</span>

<span class="s">        </span><span class="se">\x1b</span><span class="s">[1;34muser</span><span class="se">\x1b</span><span class="s">[0m@suse-host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m sudo yast -i python-pam</span>

<span class="s">Settings</span>
<span class="s">--------</span>
<span class="s">All of Gate One&#39;s configurable options can be controlled either via command line</span>
<span class="s">switches or by settings in the server.conf file (they match up 1-to-1).  If no</span>
<span class="s">server.conf exists one will be created using defaults (i.e. when Gate One is run</span>
<span class="s">for the first time).  Settings in the server.conf file use the following format::</span>

<span class="s">    &lt;setting&gt; = &lt;value&gt;</span>

<span class="s">Here&#39;s an example::</span>

<span class="s">    address = &quot;127.0.0.1;::1;10.1.1.4&quot; # Strings are surrounded by quotes</span>
<span class="s">    port = 443 # Numbers don&#39;t need quotes</span>

<span class="s">There are a few important differences between the configuration file and</span>
<span class="s">command line switches in regards to boolean values (True/False).  A switch such</span>
<span class="s">as --debug evaluates to &quot;debug = True&quot; and this is exactly how it would be</span>
<span class="s">configured in server.conf::</span>

<span class="s">    debug = True # Booleans don&#39;t need quotes either</span>

<span class="s">.. note:: The following values in server.conf are case sensitive: True, False and None (and should not be placed in quotes).</span>

<span class="s">Running gateone.py with the --help switch will print the usage information as</span>
<span class="s">well as descriptions of what each configurable option does:</span>

<span class="s">.. ansi-block::</span>

<span class="s">    </span><span class="se">\x1b</span><span class="s">[1;31mroot</span><span class="se">\x1b</span><span class="s">[0m@host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m ./gateone.py --help</span>
<span class="s">    Usage: ./gateone.py [OPTIONS]</span>

<span class="s">    Options:</span>
<span class="s">      --help                           show this help information</span>
<span class="s">      --log_file_max_size              max size of log files before rollover</span>
<span class="s">      --log_file_num_backups           number of log files to keep</span>
<span class="s">      --log_file_prefix=PATH           Path prefix for log files. Note that if you are running multiple tornado processes, log_file_prefix must be different for each of them (e.g. include the port number)</span>
<span class="s">      --log_to_stderr                  Send log output to stderr (colorized if possible). By default use stderr if --log_file_prefix is not set and no other logging is configured.</span>
<span class="s">      --logging=debug|info|warning|error|none Set the Python log level. If &#39;none&#39;, tornado won&#39;t touch the logging configuration.</span>
<span class="s">    ./gateone.py</span>
<span class="s">      --address                        Run on the given address.  Default is all addresses (IPv6 included).  Multiple address can be specified using a semicolon as a separator (e.g. &#39;127.0.0.1;::1;10.1.1.100&#39;).</span>
<span class="s">      --auth                           Authentication method to use.  Valid options are: none, api, google, kerberos, pam</span>
<span class="s">      --certificate                    Path to the SSL certificate.  Will be auto-generated if none is provided.</span>
<span class="s">      --command                        Run the given command when a user connects (e.g. &#39;/bin/login&#39;).</span>
<span class="s">      --config                         Path to the config file.  Default: /opt/gateone/server.conf</span>
<span class="s">      --cookie_secret                  Use the given 45-character string for cookie encryption.</span>
<span class="s">      --debug                          Enable debugging features such as auto-restarting when files are modified.</span>
<span class="s">      --disable_ssl                    If enabled, Gate One will run without SSL (generally not a good idea).</span>
<span class="s">      --dtach                          Wrap terminals with dtach. Allows sessions to be resumed even if Gate One is stopped and started (which is a sweet feature).</span>
<span class="s">      --embedded                       Run Gate One in Embedded Mode (no toolbar, only one terminal allowed, etc.  See docs).</span>
<span class="s">      --https_redirect                 If enabled, a separate listener will be started on port 80 that redirects users to the configured port using HTTPS.</span>
<span class="s">      --js_init                        A JavaScript object (string) that will be used when running GateOne.init() inside index.html.  Example: --js_init=&quot;{scheme: &#39;white&#39;}&quot; would result in GateOne.init({scheme: &#39;white&#39;})</span>
<span class="s">      --keyfile                        Path to the SSL keyfile.  Will be auto-generated if none is provided.</span>
<span class="s">      --kill                           Kill any running Gate One terminal processes including dtach&#39;d processes.</span>
<span class="s">      --locale                         The locale (e.g. pt_PT) Gate One should use for translations.  If not provided, will default to $LANG (which is &#39;en_US&#39; in your current shell), or en_US if not set.</span>
<span class="s">      --new_api_key                    Generate a new API key that an external application can use toembed Gate One.</span>
<span class="s">      --pam_realm                      Basic auth REALM to display when authenticating clients.  Default: hostname.  Only relevant if PAM authentication is enabled.</span>
<span class="s">      --pam_service                    PAM service to use.  Defaults to &#39;login&#39;. Only relevant if PAM authentication is enabled.</span>
<span class="s">      --port                           Run on the given port.</span>
<span class="s">      --session_dir                    Path to the location where session information will be stored.</span>
<span class="s">      --session_logging                If enabled, logs of user sessions will be saved in &lt;user_dir&gt;/&lt;user&gt;/logs.  Default: Enabled</span>
<span class="s">      --session_timeout                Amount of time that a session should be kept alive after the client has logged out.  Accepts &lt;num&gt;X where X could be one of s, m, h, or d for seconds, minutes, hours, and days.  Default is &#39;5d&#39; (5 days).</span>
<span class="s">      --sso_realm                      Kerberos REALM (aka DOMAIN) to use when authenticating clients. Only relevant if Kerberos authentication is enabled.</span>
<span class="s">      --sso_service                    Kerberos service (aka application) to use. Defaults to HTTP. Only relevant if Kerberos authentication is enabled.</span>
<span class="s">      --syslog_facility                Syslog facility to use when logging to syslog (if syslog_session_logging is enabled).  Must be one of: auth, cron, daemon, kern, local0, local1, local2, local3, local4, local5, local6, local7, lpr, mail, news, syslog, user, uucp.  Default: daemon</span>
<span class="s">      --syslog_host                    Remote host to send syslog messages to if syslog_logging is enabled.  Default: None (log to the local syslog daemon directly).  NOTE:  This setting is required on platforms that don&#39;t include Python&#39;s syslog module.</span>
<span class="s">      --syslog_session_logging         If enabled, logs of user sessions will be written to syslog.</span>
<span class="s">      --user_dir                       Path to the location where user files will be stored.</span>

<span class="s">.. note:: Some of these options (e.g. log_file_prefix) are inherent to the Tornado framework.  You won&#39;t find them anywhere in gateone.py.</span>

<span class="s">File Paths</span>
<span class="s">----------</span>
<span class="s">Gate One stores its files, temporary session information, and persistent user</span>
<span class="s">data in the following locations (Note: Many of these are configurable):</span>

<span class="s">================= ==================================================================================</span>
<span class="s">File/Directory      Description</span>
<span class="s">================= ==================================================================================</span>
<span class="s">authpam.py        Contains the PAM authentication Mixin used by auth.py.</span>
<span class="s">auth.py           Authentication classes.</span>
<span class="s">certificate.pem   The default certificate Gate One will use in SSL communications.</span>
<span class="s">docs/             Gate One&#39;s documentation.</span>
<span class="s">gateone.py        Gate One&#39;s primary executable/script. Also, the file containing this documentation</span>
<span class="s">i18n/             Gate One&#39;s internationalization (i18n) support and locale/translation files.</span>
<span class="s">keyfile.pem       The default private key used with SSL communications.</span>
<span class="s">logviewer.py      A utility to view Gate One session logs.</span>
<span class="s">plugins/          Plugins go here in the form of ./plugins/&lt;plugin name&gt;/&lt;plugin files|directories&gt;</span>
<span class="s">remote_syslog.py  A module that supports sending syslog messages over UDP to a remote syslog host.</span>
<span class="s">server.conf       Gate One&#39;s configuration file.</span>
<span class="s">sso.py            A Kerberos Single Sign-on module for Tornado (used by auth.py)</span>
<span class="s">static/           Non-dynamic files that get served to clients (e.g. gateone.js, gateone.css, etc).</span>
<span class="s">templates/        Tornado template files such as index.html.</span>
<span class="s">terminal.py       A Pure Python terminal emulator module.</span>
<span class="s">termio.py         Terminal input/output control module.</span>
<span class="s">tests/            Various scripts and tools to test Gate One&#39;s functionality.</span>
<span class="s">utils.py          Various supporting functions.</span>
<span class="s">users/            Persistent user data in the form of ./users/&lt;username&gt;/&lt;user-specific files&gt;</span>
<span class="s">users/&lt;user&gt;/logs This is where session logs get stored if session_logging is set.</span>
<span class="s">/tmp/gateone      Temporary session data in the form of /tmp/gateone/&lt;session ID&gt;/&lt;files&gt;</span>
<span class="s">================= ==================================================================================</span>

<span class="s">Running</span>
<span class="s">-------</span>
<span class="s">Executing Gate One is as simple as:</span>

<span class="s">.. ansi-block::</span>

<span class="s">    </span><span class="se">\x1b</span><span class="s">[1;31mroot</span><span class="se">\x1b</span><span class="s">[0m@host</span><span class="se">\x1b</span><span class="s">[1;34m:~ $</span><span class="se">\x1b</span><span class="s">[0m ./gateone.py</span>

<span class="s">.. note:: By default Gate One will run on port 443 which requires root on most systems.  Use `--port=(something higher than 1024)` for non-root users.</span>

<span class="s">Plugins</span>
<span class="s">-------</span>
<span class="s">Gate One includes support for any combination of the following types of plugins:</span>

<span class="s"> * Python</span>
<span class="s"> * JavaScript</span>
<span class="s"> * CSS</span>

<span class="s">Python plugins can integrate with Gate One in three ways:</span>

<span class="s"> * Adding or overriding tornado.web.RequestHandlers (with a given regex).</span>
<span class="s"> * Adding or overriding methods (aka &quot;commands&quot;) in TerminalWebSocket.</span>
<span class="s"> * Adding special plugin-specific escape sequence handlers (see the plugin development documentation for details on what/how these are/work).</span>

<span class="s">JavaScript plugins will be added to the &lt;body&gt; tag of Gate One&#39;s base index.html</span>
<span class="s">template by way of a single file (`{{gateone_js}}` below) that is the</span>
<span class="s">concatenation of all plugins&#39; JS templates:</span>

<span class="s">.. code-block:: html</span>

<span class="s">    &lt;script type=&quot;text/javascript&quot; src=&quot;{{gateone_js}}&quot;&gt;&lt;/script&gt;</span>

<span class="s">CSS plugins are similar to JavaScript but instead of being appended to the</span>
<span class="s">&lt;body&gt; they are added to the &lt;head&gt; by way of a WebSocket download and some</span>
<span class="s">fancy JavaScript inside of gateone.js:</span>

<span class="s">.. code-block:: javascript</span>

<span class="s">    CSSPluginAction: function(url) {</span>
<span class="s">        // Loads the CSS for a given plugin by adding a &lt;link&gt; tag to the &lt;head&gt;</span>
<span class="s">        var queries = url.split(&#39;?&#39;)[1].split(&#39;&amp;&#39;), // So we can parse out the plugin name and the template</span>
<span class="s">            plugin = queries[0].split(&#39;=&#39;)[1],</span>
<span class="s">            file = queries[1].split(&#39;=&#39;)[1].split(&#39;.&#39;)[0];</span>
<span class="s">        // The /cssrender method needs the prefix and the container</span>
<span class="s">        url = url + &#39;&amp;container=&#39; + GateOne.prefs.goDiv.substring(1);</span>
<span class="s">        url = url + &#39;&amp;prefix=&#39; + GateOne.prefs.prefix;</span>
<span class="s">        url = GateOne.prefs.url + url.substring(1);</span>
<span class="s">        GateOne.Utils.loadCSS(url, plugin+&#39;_&#39;+file);</span>
<span class="s">    }</span>

<span class="s">There are also hooks throughout Gate One&#39;s code for plugins to add or override</span>
<span class="s">Gate One&#39;s functionality.  Documentation on how to write plugins can be found in</span>
<span class="s">the Plugin Development docs.  From the perspective of gateone.py, it performs</span>
<span class="s">the following tasks in relation to plugins:</span>

<span class="s"> * Imports Python plugins and connects their hooks.</span>
<span class="s"> * Creates symbolic links inside ./static/ that point to each plugin&#39;s respective /static/ directory and serves them to clients.</span>
<span class="s"> * Serves the index.html that includes plugins&#39; respective .js and .css files.</span>

<span class="s">Class Docstrings</span>
<span class="s">================</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="c"># Standard library modules</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>

<span class="c"># Tornado modules (yeah, we use all this stuff)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">tornado.httpserver</span>
    <span class="kn">import</span> <span class="nn">tornado.ioloop</span>
    <span class="kn">import</span> <span class="nn">tornado.options</span>
    <span class="kn">import</span> <span class="nn">tornado.web</span>
    <span class="kn">import</span> <span class="nn">tornado.auth</span>
    <span class="kn">import</span> <span class="nn">tornado.template</span>
    <span class="kn">from</span> <span class="nn">tornado.websocket</span> <span class="kn">import</span> <span class="n">WebSocketHandler</span>
    <span class="kn">from</span> <span class="nn">tornado.escape</span> <span class="kn">import</span> <span class="n">json_decode</span>
    <span class="kn">from</span> <span class="nn">tornado.options</span> <span class="kn">import</span> <span class="n">define</span><span class="p">,</span> <span class="n">options</span>
    <span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">locale</span>
    <span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">version</span> <span class="k">as</span> <span class="n">tornado_version</span>
    <span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">version_info</span> <span class="k">as</span> <span class="n">tornado_version_info</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x1b</span><span class="s">[31;1mERROR:</span><span class="se">\x1b</span><span class="s">[0m Gate One requires the Tornado framework.  &quot;</span>
          <span class="s">&quot;You probably want to run something like, </span><span class="se">\x1b</span><span class="s">[1m&#39;pip install &quot;</span>
          <span class="s">&quot;--upgrade tornado&#39;</span><span class="se">\x1b</span><span class="s">[0m.&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">tornado_version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">tornado_version_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x1b</span><span class="s">[31;1mERROR:</span><span class="se">\x1b</span><span class="s">[0m Gate One requires version 2.2+ of the &quot;</span>
            <span class="s">&quot;Tornado framework.  The installed version of Tornado is version &quot;</span>
            <span class="s">&quot;</span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="n">tornado_version</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># We want this turned on right away</span>
<span class="n">tornado</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">enable_pretty_logging</span><span class="p">()</span>

<span class="c"># Our own modules</span>
<span class="kn">import</span> <span class="nn">termio</span><span class="o">,</span> <span class="nn">terminal</span>
<span class="kn">from</span> <span class="nn">auth</span> <span class="kn">import</span> <span class="n">NullAuthHandler</span><span class="p">,</span> <span class="n">KerberosAuthHandler</span><span class="p">,</span> <span class="n">GoogleAuthHandler</span>
<span class="kn">from</span> <span class="nn">auth</span> <span class="kn">import</span> <span class="n">PAMAuthHandler</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">str2bool</span><span class="p">,</span> <span class="n">generate_session_id</span><span class="p">,</span> <span class="n">cmd_var_swap</span><span class="p">,</span> <span class="n">mkdir_p</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">gen_self_signed_ssl</span><span class="p">,</span> <span class="n">killall</span><span class="p">,</span> <span class="n">get_plugins</span><span class="p">,</span> <span class="n">load_plugins</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">create_plugin_links</span><span class="p">,</span> <span class="n">merge_handlers</span><span class="p">,</span> <span class="n">none_fix</span><span class="p">,</span> <span class="n">short_hash</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">convert_to_timedelta</span><span class="p">,</span> <span class="n">kill_dtached_proc</span><span class="p">,</span> <span class="n">FACILITIES</span><span class="p">,</span> <span class="n">which</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">process_opt_esc_sequence</span><span class="p">,</span> <span class="n">create_data_uri</span><span class="p">,</span> <span class="n">MimeTypeFail</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">string_to_syslog_facility</span><span class="p">,</span> <span class="n">fallback_bell</span><span class="p">,</span> <span class="n">json_encode</span>

<span class="c"># Setup the locale functions before anything else</span>
<span class="n">locale</span><span class="o">.</span><span class="n">set_default_locale</span><span class="p">(</span><span class="s">&#39;en_US&#39;</span><span class="p">)</span>
<span class="n">user_locale</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Replaced with the actual user locale object in __main__</span>
<div class="viewcode-block" id="_"><a class="viewcode-back" href="../Developer/gateone.html#gateone._">[docs]</a><span class="k">def</span> <span class="nf">_</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wraps user_locale.translate so we can .encode(&#39;UTF-8&#39;) when writing to</span>
<span class="sd">    stdout.  This function will get overridden by the regular translate()</span>
<span class="sd">    function in __main__</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">user_locale</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">string</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">)</span>

<span class="c"># Globals</span></div>
<span class="n">SESSIONS</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># We store the crux of most session info here</span>
<span class="n">CMD</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Will be overwritten by options.command</span>
<span class="n">TIMEOUT</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span> <span class="c"># Gets overridden by options.session_timeout</span>
<span class="n">GATEONE_DIR</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span>
<span class="n">PLUGINS</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;plugins&#39;</span><span class="p">))</span>
<span class="n">PLUGIN_WS_CMDS</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Gives plugins the ability to extend/enhance TerminalWebSocket</span>
<span class="n">PLUGIN_HOOKS</span> <span class="o">=</span> <span class="p">{}</span> <span class="c"># Gives plugins the ability to hook into various things.</span>
<span class="n">PLUGIN_AUTH_HOOKS</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># For plugins to register functions to be called after a</span>
                       <span class="c"># user successfully authenticates</span>
<span class="c"># Gate One registers a handler for for terminal.py&#39;s CALLBACK_OPT special escape</span>
<span class="c"># sequence callback.  Whenever this escape sequence is encountered, Gate One</span>
<span class="c"># will parse the sequence&#39;s contained characters looking for the following</span>
<span class="c"># format:</span>
<span class="c">#   &lt;plugin name&gt;|&lt;whatever&gt;</span>
<span class="c"># The &lt;whatever&gt; part will be passed to any plugin matching &lt;plugin name&gt; if the</span>
<span class="c"># plugin has &#39;Escape&#39;: &lt;function&gt; registered in its hooks.</span>
<span class="n">PLUGIN_ESC_HANDLERS</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c"># Secondary locale setup</span>
<span class="n">locale_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;i18n&#39;</span><span class="p">)</span>
<span class="n">locale</span><span class="o">.</span><span class="n">load_gettext_translations</span><span class="p">(</span><span class="n">locale_dir</span><span class="p">,</span> <span class="s">&#39;gateone&#39;</span><span class="p">)</span>
<span class="c"># NOTE: The locale gets set in __main__</span>

<span class="c"># A HUGE thank you to Micah Elliott (http://MicahElliott.com) for posting these</span>
<span class="c"># values here: https://gist.github.com/719710</span>
<span class="c"># This gets used by StyleHandler to generate the CSS that supports 256-colors:</span>
<span class="n">COLORS_256</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c"># 8-color equivalents:</span>
     <span class="mi">0</span><span class="p">:</span> <span class="s">&quot;000000&quot;</span><span class="p">,</span>
     <span class="mi">1</span><span class="p">:</span> <span class="s">&quot;800000&quot;</span><span class="p">,</span>
     <span class="mi">2</span><span class="p">:</span> <span class="s">&quot;008000&quot;</span><span class="p">,</span>
     <span class="mi">3</span><span class="p">:</span> <span class="s">&quot;808000&quot;</span><span class="p">,</span>
     <span class="mi">4</span><span class="p">:</span> <span class="s">&quot;000080&quot;</span><span class="p">,</span>
     <span class="mi">5</span><span class="p">:</span> <span class="s">&quot;800080&quot;</span><span class="p">,</span>
     <span class="mi">6</span><span class="p">:</span> <span class="s">&quot;008080&quot;</span><span class="p">,</span>
     <span class="mi">7</span><span class="p">:</span> <span class="s">&quot;c0c0c0&quot;</span><span class="p">,</span>
    <span class="c"># &quot;Bright&quot; (16-color) equivalents:</span>
     <span class="mi">8</span><span class="p">:</span> <span class="s">&quot;808080&quot;</span><span class="p">,</span>
     <span class="mi">9</span><span class="p">:</span> <span class="s">&quot;ff0000&quot;</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">:</span> <span class="s">&quot;00ff00&quot;</span><span class="p">,</span>
    <span class="mi">11</span><span class="p">:</span> <span class="s">&quot;ffff00&quot;</span><span class="p">,</span>
    <span class="mi">12</span><span class="p">:</span> <span class="s">&quot;0000ff&quot;</span><span class="p">,</span>
    <span class="mi">13</span><span class="p">:</span> <span class="s">&quot;ff00ff&quot;</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">:</span> <span class="s">&quot;00ffff&quot;</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">:</span> <span class="s">&quot;ffffff&quot;</span><span class="p">,</span>
    <span class="c"># The rest of the 256-colors:</span>
    <span class="mi">16</span><span class="p">:</span> <span class="s">&quot;000000&quot;</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">:</span> <span class="s">&quot;00005f&quot;</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">:</span> <span class="s">&quot;000087&quot;</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">:</span> <span class="s">&quot;0000af&quot;</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">:</span> <span class="s">&quot;0000d7&quot;</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">:</span> <span class="s">&quot;0000ff&quot;</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">:</span> <span class="s">&quot;005f00&quot;</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">:</span> <span class="s">&quot;005f5f&quot;</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">:</span> <span class="s">&quot;005f87&quot;</span><span class="p">,</span>
    <span class="mi">25</span><span class="p">:</span> <span class="s">&quot;005faf&quot;</span><span class="p">,</span>
    <span class="mi">26</span><span class="p">:</span> <span class="s">&quot;005fd7&quot;</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">:</span> <span class="s">&quot;005fff&quot;</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">:</span> <span class="s">&quot;008700&quot;</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">:</span> <span class="s">&quot;00875f&quot;</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">:</span> <span class="s">&quot;008787&quot;</span><span class="p">,</span>
    <span class="mi">31</span><span class="p">:</span> <span class="s">&quot;0087af&quot;</span><span class="p">,</span>
    <span class="mi">32</span><span class="p">:</span> <span class="s">&quot;0087d7&quot;</span><span class="p">,</span>
    <span class="mi">33</span><span class="p">:</span> <span class="s">&quot;0087ff&quot;</span><span class="p">,</span>
    <span class="mi">34</span><span class="p">:</span> <span class="s">&quot;00af00&quot;</span><span class="p">,</span>
    <span class="mi">35</span><span class="p">:</span> <span class="s">&quot;00af5f&quot;</span><span class="p">,</span>
    <span class="mi">36</span><span class="p">:</span> <span class="s">&quot;00af87&quot;</span><span class="p">,</span>
    <span class="mi">37</span><span class="p">:</span> <span class="s">&quot;00afaf&quot;</span><span class="p">,</span>
    <span class="mi">38</span><span class="p">:</span> <span class="s">&quot;00afd7&quot;</span><span class="p">,</span>
    <span class="mi">39</span><span class="p">:</span> <span class="s">&quot;00afff&quot;</span><span class="p">,</span>
    <span class="mi">40</span><span class="p">:</span> <span class="s">&quot;00d700&quot;</span><span class="p">,</span>
    <span class="mi">41</span><span class="p">:</span> <span class="s">&quot;00d75f&quot;</span><span class="p">,</span>
    <span class="mi">42</span><span class="p">:</span> <span class="s">&quot;00d787&quot;</span><span class="p">,</span>
    <span class="mi">43</span><span class="p">:</span> <span class="s">&quot;00d7af&quot;</span><span class="p">,</span>
    <span class="mi">44</span><span class="p">:</span> <span class="s">&quot;00d7d7&quot;</span><span class="p">,</span>
    <span class="mi">45</span><span class="p">:</span> <span class="s">&quot;00d7ff&quot;</span><span class="p">,</span>
    <span class="mi">46</span><span class="p">:</span> <span class="s">&quot;00ff00&quot;</span><span class="p">,</span>
    <span class="mi">47</span><span class="p">:</span> <span class="s">&quot;00ff5f&quot;</span><span class="p">,</span>
    <span class="mi">48</span><span class="p">:</span> <span class="s">&quot;00ff87&quot;</span><span class="p">,</span>
    <span class="mi">49</span><span class="p">:</span> <span class="s">&quot;00ffaf&quot;</span><span class="p">,</span>
    <span class="mi">50</span><span class="p">:</span> <span class="s">&quot;00ffd7&quot;</span><span class="p">,</span>
    <span class="mi">51</span><span class="p">:</span> <span class="s">&quot;00ffff&quot;</span><span class="p">,</span>
    <span class="mi">52</span><span class="p">:</span> <span class="s">&quot;5f0000&quot;</span><span class="p">,</span>
    <span class="mi">53</span><span class="p">:</span> <span class="s">&quot;5f005f&quot;</span><span class="p">,</span>
    <span class="mi">54</span><span class="p">:</span> <span class="s">&quot;5f0087&quot;</span><span class="p">,</span>
    <span class="mi">55</span><span class="p">:</span> <span class="s">&quot;5f00af&quot;</span><span class="p">,</span>
    <span class="mi">56</span><span class="p">:</span> <span class="s">&quot;5f00d7&quot;</span><span class="p">,</span>
    <span class="mi">57</span><span class="p">:</span> <span class="s">&quot;5f00ff&quot;</span><span class="p">,</span>
    <span class="mi">58</span><span class="p">:</span> <span class="s">&quot;5f5f00&quot;</span><span class="p">,</span>
    <span class="mi">59</span><span class="p">:</span> <span class="s">&quot;5f5f5f&quot;</span><span class="p">,</span>
    <span class="mi">60</span><span class="p">:</span> <span class="s">&quot;5f5f87&quot;</span><span class="p">,</span>
    <span class="mi">61</span><span class="p">:</span> <span class="s">&quot;5f5faf&quot;</span><span class="p">,</span>
    <span class="mi">62</span><span class="p">:</span> <span class="s">&quot;5f5fd7&quot;</span><span class="p">,</span>
    <span class="mi">63</span><span class="p">:</span> <span class="s">&quot;5f5fff&quot;</span><span class="p">,</span>
    <span class="mi">64</span><span class="p">:</span> <span class="s">&quot;5f8700&quot;</span><span class="p">,</span>
    <span class="mi">65</span><span class="p">:</span> <span class="s">&quot;5f875f&quot;</span><span class="p">,</span>
    <span class="mi">66</span><span class="p">:</span> <span class="s">&quot;5f8787&quot;</span><span class="p">,</span>
    <span class="mi">67</span><span class="p">:</span> <span class="s">&quot;5f87af&quot;</span><span class="p">,</span>
    <span class="mi">68</span><span class="p">:</span> <span class="s">&quot;5f87d7&quot;</span><span class="p">,</span>
    <span class="mi">69</span><span class="p">:</span> <span class="s">&quot;5f87ff&quot;</span><span class="p">,</span>
    <span class="mi">70</span><span class="p">:</span> <span class="s">&quot;5faf00&quot;</span><span class="p">,</span>
    <span class="mi">71</span><span class="p">:</span> <span class="s">&quot;5faf5f&quot;</span><span class="p">,</span>
    <span class="mi">72</span><span class="p">:</span> <span class="s">&quot;5faf87&quot;</span><span class="p">,</span>
    <span class="mi">73</span><span class="p">:</span> <span class="s">&quot;5fafaf&quot;</span><span class="p">,</span>
    <span class="mi">74</span><span class="p">:</span> <span class="s">&quot;5fafd7&quot;</span><span class="p">,</span>
    <span class="mi">75</span><span class="p">:</span> <span class="s">&quot;5fafff&quot;</span><span class="p">,</span>
    <span class="mi">76</span><span class="p">:</span> <span class="s">&quot;5fd700&quot;</span><span class="p">,</span>
    <span class="mi">77</span><span class="p">:</span> <span class="s">&quot;5fd75f&quot;</span><span class="p">,</span>
    <span class="mi">78</span><span class="p">:</span> <span class="s">&quot;5fd787&quot;</span><span class="p">,</span>
    <span class="mi">79</span><span class="p">:</span> <span class="s">&quot;5fd7af&quot;</span><span class="p">,</span>
    <span class="mi">80</span><span class="p">:</span> <span class="s">&quot;5fd7d7&quot;</span><span class="p">,</span>
    <span class="mi">81</span><span class="p">:</span> <span class="s">&quot;5fd7ff&quot;</span><span class="p">,</span>
    <span class="mi">82</span><span class="p">:</span> <span class="s">&quot;5fff00&quot;</span><span class="p">,</span>
    <span class="mi">83</span><span class="p">:</span> <span class="s">&quot;5fff5f&quot;</span><span class="p">,</span>
    <span class="mi">84</span><span class="p">:</span> <span class="s">&quot;5fff87&quot;</span><span class="p">,</span>
    <span class="mi">85</span><span class="p">:</span> <span class="s">&quot;5fffaf&quot;</span><span class="p">,</span>
    <span class="mi">86</span><span class="p">:</span> <span class="s">&quot;5fffd7&quot;</span><span class="p">,</span>
    <span class="mi">87</span><span class="p">:</span> <span class="s">&quot;5fffff&quot;</span><span class="p">,</span>
    <span class="mi">88</span><span class="p">:</span> <span class="s">&quot;870000&quot;</span><span class="p">,</span>
    <span class="mi">89</span><span class="p">:</span> <span class="s">&quot;87005f&quot;</span><span class="p">,</span>
    <span class="mi">90</span><span class="p">:</span> <span class="s">&quot;870087&quot;</span><span class="p">,</span>
    <span class="mi">91</span><span class="p">:</span> <span class="s">&quot;8700af&quot;</span><span class="p">,</span>
    <span class="mi">92</span><span class="p">:</span> <span class="s">&quot;8700d7&quot;</span><span class="p">,</span>
    <span class="mi">93</span><span class="p">:</span> <span class="s">&quot;8700ff&quot;</span><span class="p">,</span>
    <span class="mi">94</span><span class="p">:</span> <span class="s">&quot;875f00&quot;</span><span class="p">,</span>
    <span class="mi">95</span><span class="p">:</span> <span class="s">&quot;875f5f&quot;</span><span class="p">,</span>
    <span class="mi">96</span><span class="p">:</span> <span class="s">&quot;875f87&quot;</span><span class="p">,</span>
    <span class="mi">97</span><span class="p">:</span> <span class="s">&quot;875faf&quot;</span><span class="p">,</span>
    <span class="mi">98</span><span class="p">:</span> <span class="s">&quot;875fd7&quot;</span><span class="p">,</span>
    <span class="mi">99</span><span class="p">:</span> <span class="s">&quot;875fff&quot;</span><span class="p">,</span>
    <span class="mi">100</span><span class="p">:</span> <span class="s">&quot;878700&quot;</span><span class="p">,</span>
    <span class="mi">101</span><span class="p">:</span> <span class="s">&quot;87875f&quot;</span><span class="p">,</span>
    <span class="mi">102</span><span class="p">:</span> <span class="s">&quot;878787&quot;</span><span class="p">,</span>
    <span class="mi">103</span><span class="p">:</span> <span class="s">&quot;8787af&quot;</span><span class="p">,</span>
    <span class="mi">104</span><span class="p">:</span> <span class="s">&quot;8787d7&quot;</span><span class="p">,</span>
    <span class="mi">105</span><span class="p">:</span> <span class="s">&quot;8787ff&quot;</span><span class="p">,</span>
    <span class="mi">106</span><span class="p">:</span> <span class="s">&quot;87af00&quot;</span><span class="p">,</span>
    <span class="mi">107</span><span class="p">:</span> <span class="s">&quot;87af5f&quot;</span><span class="p">,</span>
    <span class="mi">108</span><span class="p">:</span> <span class="s">&quot;87af87&quot;</span><span class="p">,</span>
    <span class="mi">109</span><span class="p">:</span> <span class="s">&quot;87afaf&quot;</span><span class="p">,</span>
    <span class="mi">110</span><span class="p">:</span> <span class="s">&quot;87afd7&quot;</span><span class="p">,</span>
    <span class="mi">111</span><span class="p">:</span> <span class="s">&quot;87afff&quot;</span><span class="p">,</span>
    <span class="mi">112</span><span class="p">:</span> <span class="s">&quot;87d700&quot;</span><span class="p">,</span>
    <span class="mi">113</span><span class="p">:</span> <span class="s">&quot;87d75f&quot;</span><span class="p">,</span>
    <span class="mi">114</span><span class="p">:</span> <span class="s">&quot;87d787&quot;</span><span class="p">,</span>
    <span class="mi">115</span><span class="p">:</span> <span class="s">&quot;87d7af&quot;</span><span class="p">,</span>
    <span class="mi">116</span><span class="p">:</span> <span class="s">&quot;87d7d7&quot;</span><span class="p">,</span>
    <span class="mi">117</span><span class="p">:</span> <span class="s">&quot;87d7ff&quot;</span><span class="p">,</span>
    <span class="mi">118</span><span class="p">:</span> <span class="s">&quot;87ff00&quot;</span><span class="p">,</span>
    <span class="mi">119</span><span class="p">:</span> <span class="s">&quot;87ff5f&quot;</span><span class="p">,</span>
    <span class="mi">120</span><span class="p">:</span> <span class="s">&quot;87ff87&quot;</span><span class="p">,</span>
    <span class="mi">121</span><span class="p">:</span> <span class="s">&quot;87ffaf&quot;</span><span class="p">,</span>
    <span class="mi">122</span><span class="p">:</span> <span class="s">&quot;87ffd7&quot;</span><span class="p">,</span>
    <span class="mi">123</span><span class="p">:</span> <span class="s">&quot;87ffff&quot;</span><span class="p">,</span>
    <span class="mi">124</span><span class="p">:</span> <span class="s">&quot;af0000&quot;</span><span class="p">,</span>
    <span class="mi">125</span><span class="p">:</span> <span class="s">&quot;af005f&quot;</span><span class="p">,</span>
    <span class="mi">126</span><span class="p">:</span> <span class="s">&quot;af0087&quot;</span><span class="p">,</span>
    <span class="mi">127</span><span class="p">:</span> <span class="s">&quot;af00af&quot;</span><span class="p">,</span>
    <span class="mi">128</span><span class="p">:</span> <span class="s">&quot;af00d7&quot;</span><span class="p">,</span>
    <span class="mi">129</span><span class="p">:</span> <span class="s">&quot;af00ff&quot;</span><span class="p">,</span>
    <span class="mi">130</span><span class="p">:</span> <span class="s">&quot;af5f00&quot;</span><span class="p">,</span>
    <span class="mi">131</span><span class="p">:</span> <span class="s">&quot;af5f5f&quot;</span><span class="p">,</span>
    <span class="mi">132</span><span class="p">:</span> <span class="s">&quot;af5f87&quot;</span><span class="p">,</span>
    <span class="mi">133</span><span class="p">:</span> <span class="s">&quot;af5faf&quot;</span><span class="p">,</span>
    <span class="mi">134</span><span class="p">:</span> <span class="s">&quot;af5fd7&quot;</span><span class="p">,</span>
    <span class="mi">135</span><span class="p">:</span> <span class="s">&quot;af5fff&quot;</span><span class="p">,</span>
    <span class="mi">136</span><span class="p">:</span> <span class="s">&quot;af8700&quot;</span><span class="p">,</span>
    <span class="mi">137</span><span class="p">:</span> <span class="s">&quot;af875f&quot;</span><span class="p">,</span>
    <span class="mi">138</span><span class="p">:</span> <span class="s">&quot;af8787&quot;</span><span class="p">,</span>
    <span class="mi">139</span><span class="p">:</span> <span class="s">&quot;af87af&quot;</span><span class="p">,</span>
    <span class="mi">140</span><span class="p">:</span> <span class="s">&quot;af87d7&quot;</span><span class="p">,</span>
    <span class="mi">141</span><span class="p">:</span> <span class="s">&quot;af87ff&quot;</span><span class="p">,</span>
    <span class="mi">142</span><span class="p">:</span> <span class="s">&quot;afaf00&quot;</span><span class="p">,</span>
    <span class="mi">143</span><span class="p">:</span> <span class="s">&quot;afaf5f&quot;</span><span class="p">,</span>
    <span class="mi">144</span><span class="p">:</span> <span class="s">&quot;afaf87&quot;</span><span class="p">,</span>
    <span class="mi">145</span><span class="p">:</span> <span class="s">&quot;afafaf&quot;</span><span class="p">,</span>
    <span class="mi">146</span><span class="p">:</span> <span class="s">&quot;afafd7&quot;</span><span class="p">,</span>
    <span class="mi">147</span><span class="p">:</span> <span class="s">&quot;afafff&quot;</span><span class="p">,</span>
    <span class="mi">148</span><span class="p">:</span> <span class="s">&quot;afd700&quot;</span><span class="p">,</span>
    <span class="mi">149</span><span class="p">:</span> <span class="s">&quot;afd75f&quot;</span><span class="p">,</span>
    <span class="mi">150</span><span class="p">:</span> <span class="s">&quot;afd787&quot;</span><span class="p">,</span>
    <span class="mi">151</span><span class="p">:</span> <span class="s">&quot;afd7af&quot;</span><span class="p">,</span>
    <span class="mi">152</span><span class="p">:</span> <span class="s">&quot;afd7d7&quot;</span><span class="p">,</span>
    <span class="mi">153</span><span class="p">:</span> <span class="s">&quot;afd7ff&quot;</span><span class="p">,</span>
    <span class="mi">154</span><span class="p">:</span> <span class="s">&quot;afff00&quot;</span><span class="p">,</span>
    <span class="mi">155</span><span class="p">:</span> <span class="s">&quot;afff5f&quot;</span><span class="p">,</span>
    <span class="mi">156</span><span class="p">:</span> <span class="s">&quot;afff87&quot;</span><span class="p">,</span>
    <span class="mi">157</span><span class="p">:</span> <span class="s">&quot;afffaf&quot;</span><span class="p">,</span>
    <span class="mi">158</span><span class="p">:</span> <span class="s">&quot;afffd7&quot;</span><span class="p">,</span>
    <span class="mi">159</span><span class="p">:</span> <span class="s">&quot;afffff&quot;</span><span class="p">,</span>
    <span class="mi">160</span><span class="p">:</span> <span class="s">&quot;d70000&quot;</span><span class="p">,</span>
    <span class="mi">161</span><span class="p">:</span> <span class="s">&quot;d7005f&quot;</span><span class="p">,</span>
    <span class="mi">162</span><span class="p">:</span> <span class="s">&quot;d70087&quot;</span><span class="p">,</span>
    <span class="mi">163</span><span class="p">:</span> <span class="s">&quot;d700af&quot;</span><span class="p">,</span>
    <span class="mi">164</span><span class="p">:</span> <span class="s">&quot;d700d7&quot;</span><span class="p">,</span>
    <span class="mi">165</span><span class="p">:</span> <span class="s">&quot;d700ff&quot;</span><span class="p">,</span>
    <span class="mi">166</span><span class="p">:</span> <span class="s">&quot;d75f00&quot;</span><span class="p">,</span>
    <span class="mi">167</span><span class="p">:</span> <span class="s">&quot;d75f5f&quot;</span><span class="p">,</span>
    <span class="mi">168</span><span class="p">:</span> <span class="s">&quot;d75f87&quot;</span><span class="p">,</span>
    <span class="mi">169</span><span class="p">:</span> <span class="s">&quot;d75faf&quot;</span><span class="p">,</span>
    <span class="mi">170</span><span class="p">:</span> <span class="s">&quot;d75fd7&quot;</span><span class="p">,</span>
    <span class="mi">171</span><span class="p">:</span> <span class="s">&quot;d75fff&quot;</span><span class="p">,</span>
    <span class="mi">172</span><span class="p">:</span> <span class="s">&quot;d78700&quot;</span><span class="p">,</span>
    <span class="mi">173</span><span class="p">:</span> <span class="s">&quot;d7875f&quot;</span><span class="p">,</span>
    <span class="mi">174</span><span class="p">:</span> <span class="s">&quot;d78787&quot;</span><span class="p">,</span>
    <span class="mi">175</span><span class="p">:</span> <span class="s">&quot;d787af&quot;</span><span class="p">,</span>
    <span class="mi">176</span><span class="p">:</span> <span class="s">&quot;d787d7&quot;</span><span class="p">,</span>
    <span class="mi">177</span><span class="p">:</span> <span class="s">&quot;d787ff&quot;</span><span class="p">,</span>
    <span class="mi">178</span><span class="p">:</span> <span class="s">&quot;d7af00&quot;</span><span class="p">,</span>
    <span class="mi">179</span><span class="p">:</span> <span class="s">&quot;d7af5f&quot;</span><span class="p">,</span>
    <span class="mi">180</span><span class="p">:</span> <span class="s">&quot;d7af87&quot;</span><span class="p">,</span>
    <span class="mi">181</span><span class="p">:</span> <span class="s">&quot;d7afaf&quot;</span><span class="p">,</span>
    <span class="mi">182</span><span class="p">:</span> <span class="s">&quot;d7afd7&quot;</span><span class="p">,</span>
    <span class="mi">183</span><span class="p">:</span> <span class="s">&quot;d7afff&quot;</span><span class="p">,</span>
    <span class="mi">184</span><span class="p">:</span> <span class="s">&quot;d7d700&quot;</span><span class="p">,</span>
    <span class="mi">185</span><span class="p">:</span> <span class="s">&quot;d7d75f&quot;</span><span class="p">,</span>
    <span class="mi">186</span><span class="p">:</span> <span class="s">&quot;d7d787&quot;</span><span class="p">,</span>
    <span class="mi">187</span><span class="p">:</span> <span class="s">&quot;d7d7af&quot;</span><span class="p">,</span>
    <span class="mi">188</span><span class="p">:</span> <span class="s">&quot;d7d7d7&quot;</span><span class="p">,</span>
    <span class="mi">189</span><span class="p">:</span> <span class="s">&quot;d7d7ff&quot;</span><span class="p">,</span>
    <span class="mi">190</span><span class="p">:</span> <span class="s">&quot;d7ff00&quot;</span><span class="p">,</span>
    <span class="mi">191</span><span class="p">:</span> <span class="s">&quot;d7ff5f&quot;</span><span class="p">,</span>
    <span class="mi">192</span><span class="p">:</span> <span class="s">&quot;d7ff87&quot;</span><span class="p">,</span>
    <span class="mi">193</span><span class="p">:</span> <span class="s">&quot;d7ffaf&quot;</span><span class="p">,</span>
    <span class="mi">194</span><span class="p">:</span> <span class="s">&quot;d7ffd7&quot;</span><span class="p">,</span>
    <span class="mi">195</span><span class="p">:</span> <span class="s">&quot;d7ffff&quot;</span><span class="p">,</span>
    <span class="mi">196</span><span class="p">:</span> <span class="s">&quot;ff0000&quot;</span><span class="p">,</span>
    <span class="mi">197</span><span class="p">:</span> <span class="s">&quot;ff005f&quot;</span><span class="p">,</span>
    <span class="mi">198</span><span class="p">:</span> <span class="s">&quot;ff0087&quot;</span><span class="p">,</span>
    <span class="mi">199</span><span class="p">:</span> <span class="s">&quot;ff00af&quot;</span><span class="p">,</span>
    <span class="mi">200</span><span class="p">:</span> <span class="s">&quot;ff00d7&quot;</span><span class="p">,</span>
    <span class="mi">201</span><span class="p">:</span> <span class="s">&quot;ff00ff&quot;</span><span class="p">,</span>
    <span class="mi">202</span><span class="p">:</span> <span class="s">&quot;ff5f00&quot;</span><span class="p">,</span>
    <span class="mi">203</span><span class="p">:</span> <span class="s">&quot;ff5f5f&quot;</span><span class="p">,</span>
    <span class="mi">204</span><span class="p">:</span> <span class="s">&quot;ff5f87&quot;</span><span class="p">,</span>
    <span class="mi">205</span><span class="p">:</span> <span class="s">&quot;ff5faf&quot;</span><span class="p">,</span>
    <span class="mi">206</span><span class="p">:</span> <span class="s">&quot;ff5fd7&quot;</span><span class="p">,</span>
    <span class="mi">207</span><span class="p">:</span> <span class="s">&quot;ff5fff&quot;</span><span class="p">,</span>
    <span class="mi">208</span><span class="p">:</span> <span class="s">&quot;ff8700&quot;</span><span class="p">,</span>
    <span class="mi">209</span><span class="p">:</span> <span class="s">&quot;ff875f&quot;</span><span class="p">,</span>
    <span class="mi">210</span><span class="p">:</span> <span class="s">&quot;ff8787&quot;</span><span class="p">,</span>
    <span class="mi">211</span><span class="p">:</span> <span class="s">&quot;ff87af&quot;</span><span class="p">,</span>
    <span class="mi">212</span><span class="p">:</span> <span class="s">&quot;ff87d7&quot;</span><span class="p">,</span>
    <span class="mi">213</span><span class="p">:</span> <span class="s">&quot;ff87ff&quot;</span><span class="p">,</span>
    <span class="mi">214</span><span class="p">:</span> <span class="s">&quot;ffaf00&quot;</span><span class="p">,</span>
    <span class="mi">215</span><span class="p">:</span> <span class="s">&quot;ffaf5f&quot;</span><span class="p">,</span>
    <span class="mi">216</span><span class="p">:</span> <span class="s">&quot;ffaf87&quot;</span><span class="p">,</span>
    <span class="mi">217</span><span class="p">:</span> <span class="s">&quot;ffafaf&quot;</span><span class="p">,</span>
    <span class="mi">218</span><span class="p">:</span> <span class="s">&quot;ffafd7&quot;</span><span class="p">,</span>
    <span class="mi">219</span><span class="p">:</span> <span class="s">&quot;ffafff&quot;</span><span class="p">,</span>
    <span class="mi">220</span><span class="p">:</span> <span class="s">&quot;ffd700&quot;</span><span class="p">,</span>
    <span class="mi">221</span><span class="p">:</span> <span class="s">&quot;ffd75f&quot;</span><span class="p">,</span>
    <span class="mi">222</span><span class="p">:</span> <span class="s">&quot;ffd787&quot;</span><span class="p">,</span>
    <span class="mi">223</span><span class="p">:</span> <span class="s">&quot;ffd7af&quot;</span><span class="p">,</span>
    <span class="mi">224</span><span class="p">:</span> <span class="s">&quot;ffd7d7&quot;</span><span class="p">,</span>
    <span class="mi">225</span><span class="p">:</span> <span class="s">&quot;ffd7ff&quot;</span><span class="p">,</span>
    <span class="mi">226</span><span class="p">:</span> <span class="s">&quot;ffff00&quot;</span><span class="p">,</span>
    <span class="mi">227</span><span class="p">:</span> <span class="s">&quot;ffff5f&quot;</span><span class="p">,</span>
    <span class="mi">228</span><span class="p">:</span> <span class="s">&quot;ffff87&quot;</span><span class="p">,</span>
    <span class="mi">229</span><span class="p">:</span> <span class="s">&quot;ffffaf&quot;</span><span class="p">,</span>
    <span class="mi">230</span><span class="p">:</span> <span class="s">&quot;ffffd7&quot;</span><span class="p">,</span>
    <span class="mi">231</span><span class="p">:</span> <span class="s">&quot;ffffff&quot;</span><span class="p">,</span>
    <span class="c"># Grayscale:</span>
    <span class="mi">232</span><span class="p">:</span> <span class="s">&quot;080808&quot;</span><span class="p">,</span>
    <span class="mi">233</span><span class="p">:</span> <span class="s">&quot;121212&quot;</span><span class="p">,</span>
    <span class="mi">234</span><span class="p">:</span> <span class="s">&quot;1c1c1c&quot;</span><span class="p">,</span>
    <span class="mi">235</span><span class="p">:</span> <span class="s">&quot;262626&quot;</span><span class="p">,</span>
    <span class="mi">236</span><span class="p">:</span> <span class="s">&quot;303030&quot;</span><span class="p">,</span>
    <span class="mi">237</span><span class="p">:</span> <span class="s">&quot;3a3a3a&quot;</span><span class="p">,</span>
    <span class="mi">238</span><span class="p">:</span> <span class="s">&quot;444444&quot;</span><span class="p">,</span>
    <span class="mi">239</span><span class="p">:</span> <span class="s">&quot;4e4e4e&quot;</span><span class="p">,</span>
    <span class="mi">240</span><span class="p">:</span> <span class="s">&quot;585858&quot;</span><span class="p">,</span>
    <span class="mi">241</span><span class="p">:</span> <span class="s">&quot;626262&quot;</span><span class="p">,</span>
    <span class="mi">242</span><span class="p">:</span> <span class="s">&quot;6c6c6c&quot;</span><span class="p">,</span>
    <span class="mi">243</span><span class="p">:</span> <span class="s">&quot;767676&quot;</span><span class="p">,</span>
    <span class="mi">244</span><span class="p">:</span> <span class="s">&quot;808080&quot;</span><span class="p">,</span>
    <span class="mi">245</span><span class="p">:</span> <span class="s">&quot;8a8a8a&quot;</span><span class="p">,</span>
    <span class="mi">246</span><span class="p">:</span> <span class="s">&quot;949494&quot;</span><span class="p">,</span>
    <span class="mi">247</span><span class="p">:</span> <span class="s">&quot;9e9e9e&quot;</span><span class="p">,</span>
    <span class="mi">248</span><span class="p">:</span> <span class="s">&quot;a8a8a8&quot;</span><span class="p">,</span>
    <span class="mi">249</span><span class="p">:</span> <span class="s">&quot;b2b2b2&quot;</span><span class="p">,</span>
    <span class="mi">250</span><span class="p">:</span> <span class="s">&quot;bcbcbc&quot;</span><span class="p">,</span>
    <span class="mi">251</span><span class="p">:</span> <span class="s">&quot;c6c6c6&quot;</span><span class="p">,</span>
    <span class="mi">252</span><span class="p">:</span> <span class="s">&quot;d0d0d0&quot;</span><span class="p">,</span>
    <span class="mi">253</span><span class="p">:</span> <span class="s">&quot;dadada&quot;</span><span class="p">,</span>
    <span class="mi">254</span><span class="p">:</span> <span class="s">&quot;e4e4e4&quot;</span><span class="p">,</span>
    <span class="mi">255</span><span class="p">:</span> <span class="s">&quot;eeeeee&quot;</span>
<span class="p">}</span>

<span class="c"># Helper functions</span>
<div class="viewcode-block" id="require_auth"><a class="viewcode-back" href="../Developer/gateone.html#gateone.require_auth">[docs]</a><span class="k">def</span> <span class="nf">require_auth</span><span class="p">(</span><span class="n">method</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An equivalent to tornado.web.authenticated for WebSockets</span>
<span class="sd">    (TerminalWebSocket, specifically).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Only valid users please.  Thanks!&quot;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the WebSocket</span>
        <span class="k">return</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="c"># Classes</span></div>
<div class="viewcode-block" id="HTTPSRedirectHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.HTTPSRedirectHandler">[docs]</a><span class="k">class</span> <span class="nc">HTTPSRedirectHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A handler to redirect clients from HTTP to HTTPS.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="HTTPSRedirectHandler.get"><a class="viewcode-back" href="../Developer/gateone.html#gateone.HTTPSRedirectHandler.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Just redirects the client from HTTP to HTTPS&quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;port&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redirect</span><span class="p">(</span><span class="s">&#39;https://</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">/&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s">&#39;Host&#39;</span><span class="p">],</span> <span class="n">port</span><span class="p">)</span>
</div></div>
<div class="viewcode-block" id="BaseHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.BaseHandler">[docs]</a><span class="k">class</span> <span class="nc">BaseHandler</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A base handler that all Gate One RequestHandlers will inherit methods from.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Right now it&#39;s just the one function...</span>
<div class="viewcode-block" id="BaseHandler.get_current_user"><a class="viewcode-back" href="../Developer/gateone.html#gateone.BaseHandler.get_current_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tornado standard method--implemented our way.&quot;&quot;&quot;</span>
        <span class="n">user_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secure_cookie</span><span class="p">(</span><span class="s">&quot;gateone_user&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user_json</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">user_json</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;upn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="k">return</span> <span class="n">user</span>
    <span class="c"># More may be added in the future</span>
</div></div>
<div class="viewcode-block" id="MainHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.MainHandler">[docs]</a><span class="k">class</span> <span class="nc">MainHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renders index.html which loads Gate One.</span>

<span class="sd">    Will include the minified version of gateone.js if available as</span>
<span class="sd">    gateone.min.js.</span>

<span class="sd">    Will encode GATEONE_DIR/static/bell.ogg as a data:URI and put it as the</span>
<span class="sd">    &lt;source&gt; of the &lt;audio&gt; tag inside the index.html template.  Gate One</span>
<span class="sd">    administrators can replace bell.ogg with whatever they like but the file</span>
<span class="sd">    size should be less than 32k when encoded to Base64.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO: Add the ability for users to define their own individual bells.</span>
    <span class="nd">@tornado.web.authenticated</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hostname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">gateone_js</span> <span class="o">=</span> <span class="s">&quot;/static/gateone.js&quot;</span>
        <span class="n">minified_js_abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">)</span>
        <span class="n">minified_js_abspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">minified_js_abspath</span><span class="p">,</span> <span class="s">&#39;gateone.min.js&#39;</span><span class="p">)</span>
        <span class="n">bell_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;static&#39;</span><span class="p">)</span>
        <span class="n">bell_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">bell_path</span><span class="p">,</span> <span class="s">&#39;bell.ogg&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bell_path</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bell_data_uri</span> <span class="o">=</span> <span class="n">create_data_uri</span><span class="p">(</span><span class="n">bell_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">MimeTypeFail</span><span class="p">:</span>
                <span class="n">bell_data_uri</span> <span class="o">=</span> <span class="n">fallback_bell</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># There&#39;s always the fallback</span>
            <span class="n">bell_data_uri</span> <span class="o">=</span> <span class="n">fallback_bell</span>
        <span class="n">js_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;js_init&#39;</span><span class="p">]</span>
        <span class="c"># Use the minified version if it exists</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">minified_js_abspath</span><span class="p">):</span>
            <span class="n">gateone_js</span> <span class="o">=</span> <span class="s">&quot;/static/gateone.min.js&quot;</span>
        <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)</span>
        <span class="n">index_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">template_path</span><span class="p">,</span> <span class="s">&#39;index.html&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
            <span class="n">index_path</span><span class="p">,</span>
            <span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span>
            <span class="n">gateone_js</span><span class="o">=</span><span class="n">gateone_js</span><span class="p">,</span>
            <span class="n">jsplugins</span><span class="o">=</span><span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;js&#39;</span><span class="p">],</span>
            <span class="n">cssplugins</span><span class="o">=</span><span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;css&#39;</span><span class="p">],</span>
            <span class="n">js_init</span><span class="o">=</span><span class="n">js_init</span><span class="p">,</span>
            <span class="n">bell_data_uri</span><span class="o">=</span><span class="n">bell_data_uri</span>
        <span class="p">)</span>
</div>
<div class="viewcode-block" id="StyleHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.StyleHandler">[docs]</a><span class="k">class</span> <span class="nc">StyleHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Serves up our CSS templates (themes, colors, etc) and enumerates what&#39;s</span>
<span class="sd">    available depending on the given arguments:</span>

<span class="sd">    If &#39;enumerate&#39; is given, returna  JSON-encoded object containing lists of</span>
<span class="sd">    our themes/colors in the form of:</span>

<span class="sd">        {&#39;themes&#39;: themes, &#39;colors&#39;: colors}</span>

<span class="sd">    NOTE: The .css part of filenames will be stripped when sent to the client.</span>

<span class="sd">    If &#39;theme&#39; or &#39;colors&#39; are provided (along with the requisite &#39;container&#39;</span>
<span class="sd">    and &#39;prefix&#39; arguments), returns the content of the requested CSS file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Disabled authentication for this so we could get embedding working without</span>
    <span class="c"># requiring a cookie to be set.  Stylesheet enumeration isn&#39;t exactly a</span>
    <span class="c"># compelling attack vector.</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">enum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;enumerate&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">templates_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)</span>
        <span class="n">themes_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">templates_path</span><span class="p">,</span> <span class="s">&#39;themes&#39;</span><span class="p">)</span>
        <span class="n">colors_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">templates_path</span><span class="p">,</span> <span class="s">&#39;term_colors&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">enum</span><span class="p">:</span>
            <span class="n">themes</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">themes_path</span><span class="p">)</span>
            <span class="n">themes</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.css&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">themes</span><span class="p">]</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">colors_path</span><span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;.css&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">colors</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span> <span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;application/json&#39;</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;themes&#39;</span><span class="p">:</span> <span class="n">themes</span><span class="p">,</span> <span class="s">&#39;colors&#39;</span><span class="p">:</span> <span class="n">colors</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;container&quot;</span><span class="p">)</span>
            <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">)</span>
            <span class="n">theme</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;theme&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;colors&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="c"># Setup our 256-color support CSS:</span>
            <span class="n">colors_256</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
                <span class="n">fg</span> <span class="o">=</span> <span class="s">&quot;#</span><span class="si">%s</span><span class="s"> span.fx</span><span class="si">%s</span><span class="s"> {color: #</span><span class="si">%s</span><span class="s">;}&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">container</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">COLORS_256</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">bg</span> <span class="o">=</span> <span class="s">&quot;#</span><span class="si">%s</span><span class="s"> span.bx</span><span class="si">%s</span><span class="s"> {background-color: #</span><span class="si">%s</span><span class="s">;} &quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">container</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">COLORS_256</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">colors_256</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fg</span><span class="p">,</span> <span class="n">bg</span><span class="p">)</span>
            <span class="n">colors_256</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span> <span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/css&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">theme</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">theme_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">themes_path</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.css&quot;</span> <span class="o">%</span> <span class="n">theme</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                        <span class="n">theme_path</span><span class="p">,</span>
                        <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span>
                        <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span>
                        <span class="n">colors_256</span><span class="o">=</span><span class="n">colors_256</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="c"># Given theme was not found</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> was not found&quot;</span> <span class="o">%</span> <span class="n">theme_path</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">colors</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">color_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colors_path</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.css&quot;</span> <span class="o">%</span> <span class="n">colors</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                        <span class="n">color_path</span><span class="p">,</span>
                        <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span>
                        <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="c"># Given theme was not found</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> was not found&quot;</span> <span class="o">%</span> <span class="n">color_path</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="PluginCSSTemplateHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.PluginCSSTemplateHandler">[docs]</a><span class="k">class</span> <span class="nc">PluginCSSTemplateHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Renders plugin CSS template files, passing them the same *prefix* and</span>
<span class="sd">    *container* variables used by the StyleHandler.  This is so we don&#39;t need a</span>
<span class="sd">    CSS template rendering function in every plugin that needs to use {{prefix}}</span>
<span class="sd">    or {{container}}.</span>

<span class="sd">    gateone.js will automatically load all \*.css files in plugin template</span>
<span class="sd">    directories using this method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Had to disable authentication for this for the embedded stuff to work.</span>
    <span class="c"># Not a big deal...  Just some stylesheets.  To an attacker it&#39;s like</span>
    <span class="c"># peering into a window and seeing the wallpaper.</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;container&quot;</span><span class="p">)</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;prefix&quot;</span><span class="p">)</span>
        <span class="n">plugin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;plugin&quot;</span><span class="p">)</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;template&quot;</span><span class="p">)</span>
        <span class="n">templates_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;templates&#39;</span><span class="p">)</span>
        <span class="n">plugin_templates_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">templates_path</span><span class="p">,</span> <span class="n">plugin</span><span class="p">)</span>
        <span class="n">plugin_template</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_templates_path</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.css&quot;</span> <span class="o">%</span> <span class="n">plugin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span> <span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/css&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">(</span>
                <span class="n">plugin_template</span><span class="p">,</span>
                <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="c"># The provided plugin/template combination was not found</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">.css was not found&quot;</span> <span class="o">%</span> <span class="n">plugin_template</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="JSPluginsHandler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.JSPluginsHandler">[docs]</a><span class="k">class</span> <span class="nc">JSPluginsHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combines all JavaScript plugins into a single file to keep things simple and</span>
<span class="sd">    speedy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># No auth for this...  Not really necessary (just serves up a static file).</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_header</span> <span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;application/javascript&#39;</span><span class="p">)</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;plugins&quot;</span><span class="p">))</span>
        <span class="n">static_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;static&quot;</span><span class="p">)</span>
        <span class="n">combined_plugins</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">static_dir</span><span class="p">,</span> <span class="s">&quot;combined_plugins.js&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">combined_plugins</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">combined_plugins</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">js_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;length of js_data: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">js_data</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">js_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span> <span class="c"># Needs to be created</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_combine_plugins</span><span class="p">())</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span> <span class="c"># It hasn&#39;t changed, send it as-is</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">js_data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># File doesn&#39;t exist, create it and send it to the client</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_combine_plugins</span><span class="p">())</span>

<div class="viewcode-block" id="JSPluginsHandler._combine_plugins"><a class="viewcode-back" href="../Developer/gateone.html#gateone.JSPluginsHandler._combine_plugins">[docs]</a>    <span class="k">def</span> <span class="nf">_combine_plugins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Combines all plugin .js files into one (combined_plugins.js)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;plugins&quot;</span><span class="p">))</span>
        <span class="n">static_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;static&quot;</span><span class="p">)</span>
        <span class="n">combined_plugins</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">static_dir</span><span class="p">,</span> <span class="s">&quot;combined_plugins.js&quot;</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">js_plugin</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">[</span><span class="s">&#39;js&#39;</span><span class="p">]:</span>
            <span class="n">js_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="n">js_plugin</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">js_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">+=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">combined_plugins</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</div></div>
<div class="viewcode-block" id="TerminalWebSocket"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket">[docs]</a><span class="k">class</span> <span class="nc">TerminalWebSocket</span><span class="p">(</span><span class="n">WebSocketHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The main WebSocket interface for Gate One, this class is setup to call</span>
<span class="sd">    &#39;commands&#39; which are methods registered in self.commands.  Methods that are</span>
<span class="sd">    registered this way will be exposed and directly callable over the</span>
<span class="sd">    WebSocket.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">WebSocketHandler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;ping&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pong</span><span class="p">,</span>
            <span class="s">&#39;authenticate&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">authenticate</span><span class="p">,</span>
            <span class="s">&#39;new_terminal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_terminal</span><span class="p">,</span>
            <span class="s">&#39;set_terminal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_terminal</span><span class="p">,</span>
            <span class="s">&#39;kill_terminal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill_terminal</span><span class="p">,</span>
            <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">char_handler</span><span class="p">,</span> <span class="c"># Just &#39;c&#39; to keep the bandwidth down</span>
            <span class="s">&#39;refresh&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">refresh_screen</span><span class="p">,</span>
            <span class="s">&#39;full_refresh&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">full_refresh</span><span class="p">,</span>
            <span class="s">&#39;resize&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resize</span><span class="p">,</span>
            <span class="s">&#39;get_webworker&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_webworker</span><span class="p">,</span>
            <span class="s">&#39;debug_terminal&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_terminal</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># So we can keep track and avoid sending unnecessary messages:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">titles</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_user</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="TerminalWebSocket.get_current_user"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.get_current_user">[docs]</a>    <span class="k">def</span> <span class="nf">get_current_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mostly identical to the function of the same name in MainHandler.  The</span>
<span class="sd">        difference being that when API authentication is enabled the WebSocket</span>
<span class="sd">        will expect and perform its own auth of the client.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;api&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_user</span>
        <span class="n">user_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_secure_cookie</span><span class="p">(</span><span class="s">&quot;gateone_user&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_json</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">user_json</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="TerminalWebSocket.open"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.open">[docs]</a>    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when a new WebSocket is opened.&quot;&quot;&quot;</span>
        <span class="c"># TODO: Make it so that idle WebSockets that haven&#39;t passed authentication tests get auto-closed within N seconds in order to prevent a DoS scenario where the attacker keeps all possible ports open indefinitely.</span>
        <span class="c"># client_id is unique to the browser/client whereas session_id is unique</span>
        <span class="c"># to the user.  It isn&#39;t used much right now but it will be useful in</span>
        <span class="c"># the future once more stuff is running over WebSockets.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;upn&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s">&quot;WebSocket opened (</span><span class="si">%s</span><span class="s">).&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;WebSocket opened (unknown user).&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;upn&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span> <span class="c"># Invalid user info</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Unauthenticated WebSocket attempt.&quot;</span><span class="p">))</span>
            <span class="c"># In case this is a legitimate client that simply had its auth info</span>
            <span class="c"># expire/go bad, tell it to re-auth by calling the appropriate</span>
            <span class="c"># action on the other side.</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the WebSocket</span>
</div>
<div class="viewcode-block" id="TerminalWebSocket.on_message"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.on_message">[docs]</a>    <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Called when we receive a message from the client.&quot;&quot;&quot;</span>
        <span class="c"># This is super useful when debugging:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;message: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="n">message_obj</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">message_obj</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="c"># JSON FTW!</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message_obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;&#39;Error: Message bust be a JSON dict.&#39;&quot;</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c"># We didn&#39;t get JSON</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;&#39;Error: We only accept JSON here.&#39;&quot;</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">message_obj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">message_obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span> <span class="c"># Plugins first so they can override behavior if they wish</span>
                    <span class="n">PLUGIN_WS_CMDS</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">value</span><span class="p">,</span> <span class="n">tws</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span><span class="c"># tws==TerminalWebSocket</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c"># Try, try again</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">[</span><span class="n">key</span><span class="p">]()</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                        <span class="k">pass</span> <span class="c"># Ignore commands we don&#39;t understand</span>
</div>
<div class="viewcode-block" id="TerminalWebSocket.on_close"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.on_close">[docs]</a>    <span class="k">def</span> <span class="nf">on_close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called when the client terminates the connection.</span>

<span class="sd">        .. note:: Normally self.refresh_screen() catches the disconnect first and this method won&#39;t end up being called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;on_close()&quot;</span><span class="p">)</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
        <span class="c"># Remove all attached callbacks so we&#39;re not wasting memory/CPU on</span>
        <span class="c"># disconnected clients</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;session&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;session&#39;</span><span class="p">]]:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="n">multiplex</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">user</span><span class="p">[</span><span class="s">&#39;session&#39;</span><span class="p">]][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span>
                    <span class="n">multiplex</span><span class="o">.</span><span class="n">remove_all_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
                    <span class="n">term_emulator</span> <span class="o">=</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">term</span>
                    <span class="n">term_emulator</span><span class="o">.</span><span class="n">remove_all_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">user</span> <span class="ow">and</span> <span class="s">&#39;upn&#39;</span> <span class="ow">in</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s">&quot;WebSocket closed (</span><span class="si">%s</span><span class="s">).&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;WebSocket closed (unknown user).&quot;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="TerminalWebSocket.pong"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.pong">[docs]</a>    <span class="k">def</span> <span class="nf">pong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Responds to a client &#39;ping&#39; request...  Just returns the given</span>
<span class="sd">        timestamp back to the client so it can measure round-trip time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;pong&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="TerminalWebSocket.authenticate"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.authenticate">[docs]</a>    <span class="k">def</span> <span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Authenticates the client by first trying to use the &#39;gateone_user&#39;</span>
<span class="sd">        cookie or if Gate One is configured to use API authentication it will</span>
<span class="sd">        use *settings[&#39;auth&#39;]*.  Additionally, it will accept</span>
<span class="sd">        *settings[&#39;container&#39;]* and *settings[&#39;prefix&#39;]* to apply those to the</span>
<span class="sd">        equivalent properties (self.container and self.prefix).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;authenticate(): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">)</span>
        <span class="c"># Make sure the client is authenticated if authentication is enabled</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;api&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Unauthenticated WebSocket attempt.&quot;</span><span class="p">))</span>
                    <span class="c"># This usually happens when the cookie_secret gets changed</span>
                    <span class="c"># resulting in &quot;Invalid cookie...&quot; errors.  If we tell the</span>
                    <span class="c"># client to re-auth the problem should correct itself.</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the WebSocket</span>
                <span class="k">elif</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;%anonymous&#39;</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Unauthenticated WebSocket attempt.&quot;</span><span class="p">))</span>
                    <span class="c"># This can happen when a client logs in with no auth type</span>
                    <span class="c"># configured and then later the server is configured to use</span>
                    <span class="c"># authentication.  The client must be told to re-auth:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the WebSocket</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c"># &#39;upn&#39; wasn&#39;t in user</span>
                <span class="c"># Force them to authenticate</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the WebSocket</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;api&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;auth&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c"># &#39;auth&#39; message should look like this:</span>
                <span class="c"># {</span>
                <span class="c">#    &#39;api_key&#39;: &#39;MjkwYzc3MDI2MjhhNGZkNDg1MjJkODgyYjBmN2MyMTM4M&#39;,</span>
                <span class="c">#    &#39;upn&#39;: &#39;joe@company.com&#39;,</span>
                <span class="c">#    &#39;timestamp&#39;: 1323391717238,</span>
                <span class="c">#    &#39;signature&#39;: &lt;gibberish&gt;,</span>
                <span class="c">#    &#39;signature_method&#39;: &#39;HMAC-SHA1&#39;,</span>
                <span class="c">#    &#39;api_version&#39;: &#39;1.0&#39;</span>
                <span class="c"># }</span>
                <span class="c">#</span>
                <span class="c"># *api_key* is the first half of what gets generated when you</span>
                <span class="c">#   run ./gateone --new_api_key.</span>
                <span class="c"># *upn* is the User Principal Name of the user.  This is</span>
                <span class="c">#   typically something like &quot;joe@company.com&quot;.</span>
                <span class="c"># *timestamp* is a JavaScript Date() object converted into an</span>
                <span class="c">#   &quot;time since the epoch&quot;: var timestamp = new Date().getTime()</span>
                <span class="c"># *signature* is an HMAC signature of the previous three</span>
                <span class="c">#   variables that was created using the given API key&#39;s secret.</span>
                <span class="c"># *signature_method* is the HMAC hashing algorithm to use for</span>
                <span class="c">#   the signature.  Only HMAC-SHA1 is supported for now.</span>
                <span class="c"># *api_version* is the auth API version.  Always &quot;1.0&quot; for now.</span>
                <span class="n">auth_obj</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&#39;api_key&#39;</span> <span class="ow">in</span> <span class="n">auth_obj</span><span class="p">:</span>
                    <span class="c"># Assume everything else is present if the api_key is there</span>
                    <span class="n">api_key</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;api_key&#39;</span><span class="p">]</span>
                    <span class="n">upn</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span>
                    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;timestamp&#39;</span><span class="p">]</span>
                    <span class="n">signature</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;signature&#39;</span><span class="p">]</span>
                    <span class="n">signature_method</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;signature_method&#39;</span><span class="p">]</span>
                    <span class="n">api_version</span> <span class="o">=</span> <span class="n">auth_obj</span><span class="p">[</span><span class="s">&#39;api_version&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">signature_method</span> <span class="o">!=</span> <span class="s">&#39;HMAC-SHA1&#39;</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s">&#39;notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                                <span class="s">&#39;AUTHENTICATION ERROR: Unsupported signature &#39;</span>
                                <span class="s">&#39;method: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">signature_method</span><span class="p">)</span>
                        <span class="p">}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                    <span class="n">secret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;api_keys&#39;</span><span class="p">][</span><span class="n">api_key</span><span class="p">]</span>
                    <span class="c"># Check the signature against existing API keys</span>
                    <span class="n">sig_check</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">_create_signature</span><span class="p">(</span>
                        <span class="n">secret</span><span class="p">,</span> <span class="n">api_key</span><span class="p">,</span> <span class="n">upn</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sig_check</span> <span class="o">==</span> <span class="n">signature</span><span class="p">:</span>
                        <span class="c"># Auth success!</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;WebSocket Authentication Successful&quot;</span><span class="p">))</span>
                        <span class="c"># TODO: Add timestamp checking as well</span>
                <span class="c"># Make a directory to store this user&#39;s settings/files/logs/etc</span>
                        <span class="n">user_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">],</span> <span class="n">upn</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">user_dir</span><span class="p">):</span>
                            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="n">_</span><span class="p">(</span><span class="s">&quot;Creating user directory: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">user_dir</span><span class="p">))</span>
                            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">user_dir</span><span class="p">)</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">user_dir</span><span class="p">,</span> <span class="mo">0700</span><span class="p">)</span>
                        <span class="n">session_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_dir</span><span class="p">,</span> <span class="s">&#39;session&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_file</span><span class="p">):</span>
                            <span class="n">session_data</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">session_file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">api_user</span> <span class="o">=</span> <span class="n">json_decode</span><span class="p">(</span><span class="n">session_data</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">session_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="c"># Save it so we can keep track across multiple clients</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">api_user</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s">&#39;upn&#39;</span><span class="p">:</span> <span class="n">upn</span><span class="p">,</span> <span class="c"># FYI: UPN == userPrincipalName</span>
                                    <span class="s">&#39;session&#39;</span><span class="p">:</span> <span class="n">generate_session_id</span><span class="p">()</span>
                                <span class="p">}</span>
                                <span class="n">session_info_json</span> <span class="o">=</span> <span class="n">json_encode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_user</span><span class="p">)</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">session_info_json</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                            <span class="s">&quot;WebSocket auth failed signature check.&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Missing API Key in authentication object&quot;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Double-check there isn&#39;t a user set in the cookie (i.e. we have</span>
            <span class="c"># recently changed Gate One&#39;s settings).  If there is, force it</span>
            <span class="c"># back to %anonymous.</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">user</span> <span class="o">!=</span> <span class="s">&#39;%anonymous&#39;</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reauthenticate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c"># Close the WebSocket</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()[</span><span class="s">&#39;session&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;authenticate session exception: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;AUTHENTICATION ERROR: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Execute any post-authentication hooks that plugins have registered</span>
            <span class="k">if</span> <span class="n">PLUGIN_AUTH_HOOKS</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">auth_hook</span> <span class="ow">in</span> <span class="n">PLUGIN_AUTH_HOOKS</span><span class="p">:</span>
                    <span class="n">auth_hook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Exception in registered Auth hook: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
        <span class="c"># Apply the container/prefix settings (if present)</span>
        <span class="c"># NOTE:  Currently these are only used by the logging plugin</span>
        <span class="k">if</span> <span class="s">&#39;container&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">container</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;container&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&#39;prefix&#39;</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;prefix&#39;</span><span class="p">]</span>
        <span class="c"># This check is to make sure there&#39;s no existing session so we don&#39;t</span>
        <span class="c"># accidentally clobber it.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">:</span>
            <span class="c"># Old session is no good, start a new one:</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">terminals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>  <span class="c"># This skips the TidyThread...</span>
                <span class="n">terminals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="c"># Only terminals are integers in the dict</span>
        <span class="c"># Check for any dtach&#39;d terminals we might have missed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;dtach&#39;</span><span class="p">]:</span>
            <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">]</span>
            <span class="n">session_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_dir</span><span class="p">):</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">session_dir</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="mo">0700</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">session_dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;dtach_&#39;</span><span class="p">):</span>
                    <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">term</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">terminals</span><span class="p">:</span>
                        <span class="n">terminals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="n">terminals</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="c"># Put them in order so folks don&#39;t get confused</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;terminals&#39;</span><span class="p">:</span> <span class="n">terminals</span><span class="p">,</span>
        <span class="c"># This is just so the client has a human-readable point of reference:</span>
            <span class="s">&#39;set_username&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="c"># TODO: Add a hook here for plugins to send their own messages when a</span>
        <span class="c">#       given terminal is reconnected.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="c"># Now we need to tell the client about plugin CSS templates</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="n">get_plugins</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;plugins&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">css_template</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">[</span><span class="s">&#39;css&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">({</span><span class="s">&#39;load_css&#39;</span><span class="p">:</span> <span class="n">css_template</span><span class="p">}))</span>
</div>
<div class="viewcode-block" id="TerminalWebSocket.new_multiplex"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.new_multiplex">[docs]</a>    <span class="k">def</span> <span class="nf">new_multiplex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">term_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a new instance of :py:class:`termio.Multiplex` with the proper global and</span>
<span class="sd">        client-specific settings.</span>

<span class="sd">            * *cmd* - The command to execute inside of Multiplex.</span>
<span class="sd">            * *term_id* - The terminal to associate with this Multiplex or a descriptive identifier (it&#39;s only used for logging purposes).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c"># No auth, use %anonymous (% is there to prevent conflicts)</span>
            <span class="n">user</span> <span class="o">=</span> <span class="s">r&#39;%anonymous&#39;</span> <span class="c"># Don&#39;t get on this guy&#39;s bad side</span>
        <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">]</span>
        <span class="n">session_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
        <span class="n">log_path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;session_logging&#39;</span><span class="p">]:</span>
            <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_dir</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
            <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="s">&#39;logs&#39;</span><span class="p">)</span>
            <span class="c"># Create the log dir if not already present</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>
            <span class="n">log_name</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y%m</span><span class="si">%d</span><span class="s">%H%M%S</span><span class="si">%f</span><span class="s">.golog&#39;</span><span class="p">)</span>
            <span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">log_name</span><span class="p">)</span>
        <span class="n">facility</span> <span class="o">=</span> <span class="n">string_to_syslog_facility</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;syslog_facility&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">termio</span><span class="o">.</span><span class="n">Multiplex</span><span class="p">(</span>
            <span class="n">cmd</span><span class="p">,</span>
            <span class="n">log_path</span><span class="o">=</span><span class="n">log_path</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">term_id</span><span class="o">=</span><span class="n">term_id</span><span class="p">,</span>
            <span class="n">syslog</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;syslog_session_logging&#39;</span><span class="p">],</span>
            <span class="n">syslog_facility</span><span class="o">=</span><span class="n">facility</span><span class="p">,</span>
            <span class="n">syslog_host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;syslog_host&#39;</span><span class="p">]</span>
        <span class="p">)</span>
</div>
    <span class="nd">@require_auth</span>
<div class="viewcode-block" id="TerminalWebSocket.new_terminal"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.new_terminal">[docs]</a>    <span class="k">def</span> <span class="nf">new_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts up a new terminal associated with the user&#39;s session using</span>
<span class="sd">        *settings* as the parameters.  If a terminal already exists with the</span>
<span class="sd">        same number as *settings[term]*, self.set_terminal() will be called</span>
<span class="sd">        instead of starting a new terminal (so clients can resume their session</span>
<span class="sd">        without having to worry about figuring out if a new terminal already</span>
<span class="sd">        exists or not).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> new_terminal(): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()[</span><span class="s">&#39;upn&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_term</span> <span class="o">=</span> <span class="n">term</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;term&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;rows&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;cols&#39;</span><span class="p">]</span>
        <span class="n">user_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;user_dir&#39;</span><span class="p">]</span>
        <span class="n">needs_full_refresh</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">term</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">]:</span>
            <span class="c"># Setup the requisite dict</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">]:</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c"># Used by refresh_screen()</span>
                <span class="s">&#39;refresh_timeout&#39;</span><span class="p">:</span> <span class="bp">None</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="s">&#39;multiplex&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">]:</span>
            <span class="c"># Start up a new terminal</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;created&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="c"># NOTE: Not doing anything with &#39;created&#39;...  yet!</span>
            <span class="n">now</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()[</span><span class="s">&#39;upn&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c"># No auth, use %anonymous (% is there to prevent conflicts)</span>
                <span class="n">user</span> <span class="o">=</span> <span class="s">r&#39;%anonymous&#39;</span> <span class="c"># Don&#39;t get on this guy&#39;s bad side</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd_var_swap</span><span class="p">(</span><span class="n">CMD</span><span class="p">,</span>   <span class="c"># Swap out variables like %USER% in CMD</span>
                <span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="c"># with their real-world values.</span>
                <span class="n">session_hash</span><span class="o">=</span><span class="n">short_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">),</span>
                <span class="n">user_dir</span><span class="o">=</span><span class="n">user_dir</span><span class="p">,</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">time</span><span class="o">=</span><span class="n">now</span>
            <span class="p">)</span>
            <span class="n">resumed_dtach</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">session_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;session_dir&#39;</span><span class="p">]</span>
            <span class="n">session_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
            <span class="c"># Create the session dir if not already present</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">session_dir</span><span class="p">):</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">session_dir</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="mo">0700</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;dtach&#39;</span><span class="p">]:</span> <span class="c"># Wrap in dtach (love this tool!)</span>
                <span class="n">dtach_path</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/dtach_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">session_dir</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dtach_path</span><span class="p">):</span>
                    <span class="c"># Using &#39;none&#39; for the refresh because the EVIL termio</span>
                    <span class="c"># likes to manage things like that on his own...</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;dtach -a </span><span class="si">%s</span><span class="s"> -E -z -r none&quot;</span> <span class="o">%</span> <span class="n">dtach_path</span>
                    <span class="n">resumed_dtach</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span> <span class="c"># No existing dtach session...  Make a new one</span>
                    <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;dtach -c </span><span class="si">%s</span><span class="s"> -E -z -r none </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dtach_path</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_multiplex</span><span class="p">(</span>
                <span class="n">cmd</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
            <span class="c"># Set some environment variables so the programs we execute can use</span>
            <span class="c"># them (very handy).  Allows for &quot;tight integration&quot; and &quot;synergy&quot;!</span>
            <span class="n">env</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;GO_USER_DIR&#39;</span><span class="p">:</span> <span class="n">user_dir</span><span class="p">,</span>
                <span class="s">&#39;GO_USER&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                <span class="s">&#39;GO_TERM&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">term</span><span class="p">),</span>
                <span class="s">&#39;GO_SESSION&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                <span class="s">&#39;GO_SESSION_DIR&#39;</span><span class="p">:</span> <span class="n">session_dir</span>
            <span class="p">}</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span>
                <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Terminal already exists</span>
            <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                <span class="c"># It&#39;s ALIVE!!!</span>
                <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;term_exists&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="c"># This resets the screen diff</span>
                <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">prev_output</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">rows</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Tell the client this terminal is no more</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;term_ended&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="c"># Setup callbacks so that everything gets called when it should</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span> <span class="o">=</span> <span class="n">callback_id</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">;</span><span class="si">%s</span><span class="s">;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span><span class="p">)</span>
        <span class="c"># NOTE: request.host is the FQDN or IP the user entered to open Gate One</span>
        <span class="c"># so if you want to have multiple browsers open to the same user session</span>
        <span class="c"># from the same IP just use an alternate hostname/IP for the URL.</span>
        <span class="c"># Setup the termio callbacks</span>
        <span class="n">refresh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">refresh_screen</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">multiplex</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span>
        <span class="n">multiplex</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">multiplex</span><span class="o">.</span><span class="n">CALLBACK_UPDATE</span><span class="p">,</span> <span class="n">refresh</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">restart</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_terminal</span><span class="p">,</span> <span class="n">settings</span><span class="p">)</span>
        <span class="n">multiplex</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">multiplex</span><span class="o">.</span><span class="n">CALLBACK_EXIT</span><span class="p">,</span> <span class="n">restart</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="c"># Setup the terminal emulator callbacks</span>
        <span class="n">term_emulator</span> <span class="o">=</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">term</span>
        <span class="n">set_title</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_title</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span>
            <span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_TITLE</span><span class="p">,</span> <span class="n">set_title</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">set_title</span><span class="p">()</span> <span class="c"># Set initial title</span>
        <span class="n">bell</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bell</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span>
            <span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_BELL</span><span class="p">,</span> <span class="n">bell</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span>
            <span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_OPT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">esc_opt_handler</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">mode_handler</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mode_handler</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span>
            <span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_MODE</span><span class="p">,</span> <span class="n">mode_handler</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="n">reset_term</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_terminal</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">term_emulator</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span>
            <span class="n">terminal</span><span class="o">.</span><span class="n">CALLBACK_RESET</span><span class="p">,</span> <span class="n">reset_term</span><span class="p">,</span> <span class="n">callback_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;tidy_thread&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">]:</span>
            <span class="c"># Start the keepalive thread so the session will time out if the</span>
            <span class="c"># user disconnects for like a week (by default anyway =)</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s">&#39;tidy_thread&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TidyThread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
            <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s">&#39;tidy_thread&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="c">#if self.settings[&#39;debug&#39;]:</span>
            <span class="c">#tornado.autoreload.add_reload_hook(multiplex.terminate)</span>
        <span class="c"># NOTE: refresh_screen will also take care of cleaning things up if</span>
        <span class="c">#       SESSIONS[self.session][term][&#39;multiplex&#39;].isalive() is False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_screen</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span> <span class="c"># Send a fresh screen to the client</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;logging&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;debug&#39;</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;notice&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                    <span class="s">&quot;WARNING: Logging is set to DEBUG.  All keystrokes will be &quot;</span>
                    <span class="s">&quot;logged!&quot;</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</div>
    <span class="nd">@require_auth</span>
<div class="viewcode-block" id="TerminalWebSocket.kill_terminal"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.kill_terminal">[docs]</a>    <span class="k">def</span> <span class="nf">kill_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Kills *term* and any associated processes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;killing terminal: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;dtach&#39;</span><span class="p">]:</span>
                <span class="n">kill_dtached_proc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># The EVIL termio has killed my child!  Wait, that&#39;s good...</span>
                 <span class="c"># Because now I don&#39;t have to worry about it!</span>
</div>
    <span class="nd">@require_auth</span>
<div class="viewcode-block" id="TerminalWebSocket.set_terminal"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.set_terminal">[docs]</a>    <span class="k">def</span> <span class="nf">set_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets `self.current_term = *term*` so we can determine where to send</span>
<span class="sd">        keystrokes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_term</span> <span class="o">=</span> <span class="n">term</span>
</div>
    <span class="nd">@require_auth</span>
<div class="viewcode-block" id="TerminalWebSocket.reset_terminal"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.reset_terminal">[docs]</a>    <span class="k">def</span> <span class="nf">reset_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tells the client to reset the terminal (clear the screen and remove</span>
<span class="sd">        scrollback).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;reset_terminal&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
</div>
    <span class="nd">@require_auth</span>
<div class="viewcode-block" id="TerminalWebSocket.set_title"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.set_title">[docs]</a>    <span class="k">def</span> <span class="nf">set_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a message to the client telling it to set the window title of</span>
<span class="sd">        *term* to whatever comes out of::</span>

<span class="sd">            SESSIONS[self.session][term][&#39;multiplex&#39;].term.get_title() #(Whew! Say that three times fast!).</span>

<span class="sd">        Example message::</span>

<span class="sd">            {&#39;set_title&#39;: {&#39;term&#39;: 1, &#39;title&#39;: &quot;user@host&quot;}}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;set_title(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span>
        <span class="c"># Only send a title update if it actually changed</span>
        <span class="k">if</span> <span class="n">term</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="p">:</span> <span class="c"># There&#39;s a first time for everything</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="p">[</span><span class="n">term</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">title</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="p">[</span><span class="n">term</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="p">[</span><span class="n">term</span><span class="p">]</span> <span class="o">=</span> <span class="n">title</span>
            <span class="n">title_message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;set_title&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span> <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="p">}}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">title_message</span><span class="p">))</span>
</div>
    <span class="nd">@require_auth</span>
<div class="viewcode-block" id="TerminalWebSocket.bell"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.bell">[docs]</a>    <span class="k">def</span> <span class="nf">bell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a message to the client indicating that a bell was encountered in</span>
<span class="sd">        the given terminal (*term*).  Example message::</span>

<span class="sd">            {&#39;bell&#39;: {&#39;term&#39;: 1}}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bell_message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;bell&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">bell_message</span><span class="p">))</span>
</div>
    <span class="nd">@require_auth</span>
<div class="viewcode-block" id="TerminalWebSocket.mode_handler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.mode_handler">[docs]</a>    <span class="k">def</span> <span class="nf">mode_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">boolean</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles mode settings that require an action on the client by pasing it</span>
<span class="sd">        a message like::</span>

<span class="sd">            {</span>
<span class="sd">                &#39;set_mode&#39;: {</span>
<span class="sd">                    &#39;mode&#39;: setting,</span>
<span class="sd">                    &#39;bool&#39;: True,</span>
<span class="sd">                    &#39;term&#39;: term</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s">&quot;mode_handler() term: </span><span class="si">%s</span><span class="s">, setting: </span><span class="si">%s</span><span class="s">, boolean: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="n">boolean</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">setting</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;1&#39;</span><span class="p">]:</span> <span class="c"># Only support this mode right now</span>
            <span class="k">if</span> <span class="n">boolean</span><span class="p">:</span>
                <span class="c"># Tell client to enable application cursor mode</span>
                <span class="n">mode_message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;set_mode&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;mode&#39;</span><span class="p">:</span> <span class="n">setting</span><span class="p">,</span>
                    <span class="s">&#39;bool&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="s">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span>
                <span class="p">}}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">mode_message</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Tell client to disable application cursor mode</span>
                <span class="n">mode_message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;set_mode&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;mode&#39;</span><span class="p">:</span> <span class="n">setting</span><span class="p">,</span>
                    <span class="s">&#39;bool&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
                    <span class="s">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span>
                <span class="p">}}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">mode_message</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="TerminalWebSocket._send_refresh"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket._send_refresh">[docs]</a>    <span class="k">def</span> <span class="nf">_send_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sends a screen update to the client.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">tidy_thread</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s">&#39;tidy_thread&#39;</span><span class="p">]</span>
            <span class="n">tidy_thread</span><span class="o">.</span><span class="n">keepalive</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">multiplex</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span>
            <span class="n">scrollback</span><span class="p">,</span> <span class="n">screen</span> <span class="o">=</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">dump_html</span><span class="p">(</span>
                <span class="n">full</span><span class="o">=</span><span class="n">full</span><span class="p">,</span> <span class="n">client_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c"># Session died (i.e. command ended).</span>
            <span class="n">scrollback</span><span class="p">,</span> <span class="n">screen</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="p">[</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">screen</span> <span class="k">if</span> <span class="n">a</span><span class="p">]:</span>
            <span class="n">output_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;termupdate&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;term&#39;</span><span class="p">:</span> <span class="n">term</span><span class="p">,</span>
                    <span class="s">&#39;scrollback&#39;</span><span class="p">:</span> <span class="n">scrollback</span><span class="p">,</span>
                    <span class="s">&#39;screen&#39;</span> <span class="p">:</span> <span class="n">screen</span><span class="p">,</span>
                    <span class="s">&#39;ratelimiter&#39;</span><span class="p">:</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">ratelimiter_engaged</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">output_dict</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span> <span class="c"># Socket was just closed, no biggie</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                 <span class="n">_</span><span class="p">(</span><span class="s">&quot;WebSocket closed (</span><span class="si">%s</span><span class="s">)&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()[</span><span class="s">&#39;upn&#39;</span><span class="p">])</span>
                <span class="n">multiplex</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span>
                <span class="n">multiplex</span><span class="o">.</span><span class="n">remove_callback</span><span class="p">(</span> <span class="c"># Stop trying to write</span>
                    <span class="n">multiplex</span><span class="o">.</span><span class="n">CALLBACK_UPDATE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_id</span><span class="p">)</span>
</div>
    <span class="nd">@require_auth</span>
<div class="viewcode-block" id="TerminalWebSocket.refresh_screen"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.refresh_screen">[docs]</a>    <span class="k">def</span> <span class="nf">refresh_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes the state of the given terminal&#39;s screen and scrollback buffer to</span>
<span class="sd">        the client using `_send_refresh()`.  Also ensures that screen updates</span>
<span class="sd">        don&#39;t get sent too fast to the client by instituting a rate limiter that</span>
<span class="sd">        also forces a refresh every 150ms.  This keeps things smooth on the</span>
<span class="sd">        client side and also reduces the bandwidth used by the application (CPU</span>
<span class="sd">        too).</span>

<span class="sd">        If *full*, send the whole screen (not just the difference).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Commented this out because it was getting annoying.</span>
        <span class="c"># Note to self: add more levels of debugging beyond just &quot;debug&quot;.</span>
        <span class="c">#logging.debug(</span>
            <span class="c">#&quot;refresh_screen (full=%s) on %s&quot; % (full, self.callback_id))</span>
        <span class="k">if</span> <span class="n">term</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="c"># This just prevents an exception when the cookie is invalid</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">msec</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span> <span class="c"># Keeps things smooth</span>
            <span class="c"># In testing, 150 milliseconds was about as low as I could go and</span>
            <span class="c"># still remain practical.</span>
            <span class="n">force_refresh_threshold</span> <span class="o">=</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">milliseconds</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
            <span class="n">tidy_thread</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="s">&#39;tidy_thread&#39;</span><span class="p">]</span>
            <span class="n">last_keepalive</span> <span class="o">=</span> <span class="n">tidy_thread</span><span class="o">.</span><span class="n">last_keepalive</span>
            <span class="n">timediff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">last_keepalive</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">]</span>
            <span class="n">client_dict</span> <span class="o">=</span> <span class="n">sess</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">client_id</span><span class="p">]</span>
            <span class="n">multiplex</span> <span class="o">=</span> <span class="n">sess</span><span class="p">[</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span>
            <span class="n">refresh</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_send_refresh</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">full</span><span class="p">)</span>
            <span class="c"># We impose a rate limit of max one screen update every 50ms by</span>
            <span class="c"># wrapping the call to _send_refresh() in an IOLoop timeout that</span>
            <span class="c"># gets cancelled and replaced if screen updates come in faster than</span>
            <span class="c"># once every 50ms.  If screen updates are consistently faster than</span>
            <span class="c"># that (e.g. a key is held down) we also force sending the screen</span>
            <span class="c"># to the client every 150ms.  This ensures that no matter how fast</span>
            <span class="c"># screen updates are happening the user will get at least one</span>
            <span class="c"># update every 150ms.  It works out quite nice, actually.</span>
            <span class="k">if</span> <span class="n">client_dict</span><span class="p">[</span><span class="s">&#39;refresh_timeout&#39;</span><span class="p">]:</span>
                <span class="n">multiplex</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">remove_timeout</span><span class="p">(</span><span class="n">client_dict</span><span class="p">[</span><span class="s">&#39;refresh_timeout&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">timediff</span> <span class="o">&gt;</span> <span class="n">force_refresh_threshold</span><span class="p">:</span>
                <span class="n">refresh</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">client_dict</span><span class="p">[</span><span class="s">&#39;refresh_timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">multiplex</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span>
                    <span class="n">msec</span><span class="p">,</span> <span class="n">refresh</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span> <span class="c"># Session died (i.e. command ended).</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;KeyError in refresh_screen: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">))</span>
</div>
    <span class="nd">@require_auth</span>
<div class="viewcode-block" id="TerminalWebSocket.full_refresh"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.full_refresh">[docs]</a>    <span class="k">def</span> <span class="nf">full_refresh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calls `self.refresh_screen(*term*, full=True)`&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">term</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Invalid terminal number given to full_refresh(): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">term</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refresh_screen</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="nd">@require_auth</span>
<div class="viewcode-block" id="TerminalWebSocket.resize"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.resize">[docs]</a>    <span class="k">def</span> <span class="nf">resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resize_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resize the terminal window to the rows/cols specified in *resize_obj*</span>

<span class="sd">        Example *resize_obj*::</span>

<span class="sd">            {&#39;rows&#39;: 24, &#39;cols&#39;: 80}</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;resize(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">resize_obj</span><span class="p">))</span>
        <span class="n">term</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="s">&#39;term&#39;</span> <span class="ow">in</span> <span class="n">resize_obj</span><span class="p">:</span>
            <span class="n">term</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resize_obj</span><span class="p">[</span><span class="s">&#39;term&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">resize_obj</span><span class="p">[</span><span class="s">&#39;rows&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="n">resize_obj</span><span class="p">[</span><span class="s">&#39;cols&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c"># Fall back to a standard default:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="mi">24</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="mi">80</span>
        <span class="c"># If the user already has a running session, set the new terminal size:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">term</span><span class="p">:</span>
                <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cols</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># Resize them all</span>
                <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span> <span class="c"># Skip the TidyThread</span>
                        <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">cols</span>
                        <span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c"># Session doesn&#39;t exist yet, no biggie</span>
            <span class="k">pass</span>
</div>
    <span class="nd">@require_auth</span>
<div class="viewcode-block" id="TerminalWebSocket.char_handler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.char_handler">[docs]</a>    <span class="k">def</span> <span class="nf">char_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes *chars* (string) to the currently-selected terminal&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">unicode</span><span class="p">:</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
        <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_term</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
        <span class="k">if</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">chars</span><span class="p">:</span>
                    <span class="n">SESSIONS</span><span class="p">[</span> <span class="c"># Force an update</span>
                        <span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">ratelimit</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                    <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
</div>
    <span class="nd">@require_auth</span>
<div class="viewcode-block" id="TerminalWebSocket.esc_opt_handler"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.esc_opt_handler">[docs]</a>    <span class="k">def</span> <span class="nf">esc_opt_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes whatever function is registered matching the tuple returned by</span>
<span class="sd">        process_opt_esc_sequence().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;esc_opt_handler(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">chars</span><span class="p">))</span>
        <span class="n">plugin_name</span><span class="p">,</span> <span class="n">text</span> <span class="o">=</span> <span class="n">process_opt_esc_sequence</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">plugin_name</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">PLUGIN_ESC_HANDLERS</span><span class="p">[</span><span class="n">plugin_name</span><span class="p">](</span><span class="n">text</span><span class="p">,</span> <span class="n">tws</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s">&quot;Got exception trying to execute plugin&#39;s optional ESC &quot;</span>
                    <span class="s">&quot;sequence handler...&quot;</span><span class="p">))</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="TerminalWebSocket.get_webworker"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.get_webworker">[docs]</a>    <span class="k">def</span> <span class="nf">get_webworker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the text of our go_process.js to get around the limitations of</span>
<span class="sd">        loading remote Web Worker URLs (for embedding Gate One into other apps).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">static_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;static&quot;</span><span class="p">)</span>
        <span class="n">webworker_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">static_path</span><span class="p">,</span> <span class="s">&#39;go_process.js&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">webworker_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">go_process</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;load_webworker&#39;</span><span class="p">:</span> <span class="n">go_process</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_message</span><span class="p">(</span><span class="n">json_encode</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
</div>
    <span class="nd">@require_auth</span>
<div class="viewcode-block" id="TerminalWebSocket.debug_terminal"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TerminalWebSocket.debug_terminal">[docs]</a>    <span class="k">def</span> <span class="nf">debug_terminal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">term</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints the terminal&#39;s screen and renditions to stdout so they can be</span>
<span class="sd">        examined more closely.</span>

<span class="sd">        .. note:: Can only be called from a JavaScript console like so...</span>

<span class="sd">        .. code-block:: javascript</span>

<span class="sd">            GateOne.ws.send(JSON.stringify({&#39;debug_terminal&#39;: *term*}));</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">screen</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">screen</span>
        <span class="n">renditions</span> <span class="o">=</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">term</span><span class="o">.</span><span class="n">renditions</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">screen</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)))</span>
            <span class="k">print</span><span class="p">(</span><span class="n">renditions</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="c"># Thread classes</span></div></div>
<div class="viewcode-block" id="TidyThread"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TidyThread">[docs]</a><span class="k">class</span> <span class="nc">TidyThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Kills a user&#39;s termio session if the client hasn&#39;t updated the keepalive</span>
<span class="sd">    within *TIMEOUT* (global).  Also, tidies up sessions, logs, and whatnot based</span>
<span class="sd">    on Gate One&#39;s settings (when the time is right).</span>

<span class="sd">    NOTE: This is necessary to prevent shells from running eternally in the</span>
<span class="sd">    background.</span>

<span class="sd">    *session* - 45-character string containing the user&#39;s session ID</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO: Get this cleaning up logs according to configured settings</span>
    <span class="c"># TODO: Add the aforementioned log cleanup settings :)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&quot;TidyThread-</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">session</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_keepalive</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quitting</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doublecheck</span> <span class="o">=</span> <span class="bp">True</span>

<div class="viewcode-block" id="TidyThread.keepalive"><a class="viewcode-back" href="../Developer/gateone.html#gateone.TidyThread.keepalive">[docs]</a>    <span class="k">def</span> <span class="nf">keepalive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datetime_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets the keepalive timer.  Typically called when the user performs a new action.</span>

<span class="sd">        *datetime_obj* - A datetime object that will be used to measure *TIMEOUT* against.  Will end up defaulting to datetime.now() (if None) which is what you&#39;d want 99% of the time.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">datetime_obj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_keepalive</span> <span class="o">=</span> <span class="n">datetime_obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_keepalive</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quitting</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">quitting</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span>
                <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_keepalive</span> <span class="o">+</span> <span class="n">TIMEOUT</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s">&quot;{session} timeout.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">session</span><span class="o">=</span><span class="n">session</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">quitting</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># This loops through all the open terminals checking if each is alive</span>
                <span class="n">all_dead</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                            <span class="n">all_dead</span> <span class="o">=</span> <span class="bp">False</span>
                            <span class="c"># Added a doublecheck value here because there&#39;s a</span>
                            <span class="c"># gap between when the last terminal is closed and</span>
                            <span class="c"># when a new one starts up.  Occasionally this would</span>
                            <span class="c"># cause the user&#39;s connection to be killed (due to</span>
                            <span class="c"># there being no active terminal associated with it)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">doublecheck</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">all_dead</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">doublecheck</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">quitting</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">doublecheck</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="c"># Keep this low or it will take that long for the process to end</span>
                <span class="c"># when we receive a SIGTERM or Ctrl-c</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                    <span class="s">&quot;Exception encountered: {exception}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
                <span class="p">))</span>
                <span class="kn">import</span> <span class="nn">traceback</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">quitting</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;TidyThread {session} received quit()...  &quot;</span>
            <span class="s">&quot;Killing termio session.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
        <span class="p">))</span>
        <span class="c"># Clean up:</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isalive</span><span class="p">():</span>
                    <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">][</span><span class="n">term</span><span class="p">][</span><span class="s">&#39;multiplex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="c"># Ignore the TidyThread (i.e. ourselves)</span>
                <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c"># Already killed... Great!</span>
                <span class="k">pass</span>
        <span class="k">del</span> <span class="n">SESSIONS</span><span class="p">[</span><span class="n">session</span><span class="p">]</span>
</div>
<span class="k">class</span> <span class="nc">Application</span><span class="p">(</span><span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Setup our Tornado application...  Everything in *settings* will wind up</span>
<span class="sd">        in the Tornado settings dict so as to be accessible under self.settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">global</span> <span class="n">PLUGIN_WS_CMDS</span>
        <span class="k">global</span> <span class="n">PLUGIN_HOOKS</span>
        <span class="k">global</span> <span class="n">PLUGIN_ESC_HANDLERS</span>
        <span class="k">global</span> <span class="n">PLUGIN_AUTH_HOOKS</span>
        <span class="c"># Base settings for our Tornado app</span>
        <span class="n">tornado_settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">cookie_secret</span><span class="o">=</span><span class="n">settings</span><span class="p">[</span><span class="s">&#39;cookie_secret&#39;</span><span class="p">],</span>
            <span class="n">static_path</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;static&quot;</span><span class="p">),</span>
            <span class="n">gzip</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">login_url</span><span class="o">=</span><span class="s">&quot;/auth&quot;</span>
        <span class="p">)</span>
        <span class="c"># Make sure all the provided settings wind up in self.settings</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">tornado_settings</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="c"># Setup the configured authentication type</span>
        <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">NullAuthHandler</span> <span class="c"># Default</span>
        <span class="k">if</span> <span class="s">&#39;auth&#39;</span> <span class="ow">in</span> <span class="n">settings</span> <span class="ow">and</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;kerberos&#39;</span> <span class="ow">and</span> <span class="n">KerberosAuthHandler</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">KerberosAuthHandler</span>
                <span class="n">tornado_settings</span><span class="p">[</span><span class="s">&#39;sso_realm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;sso_realm&quot;</span><span class="p">]</span>
                <span class="n">tornado_settings</span><span class="p">[</span><span class="s">&#39;sso_service&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;sso_service&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;pam&#39;</span> <span class="ow">and</span> <span class="n">PAMAuthHandler</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">PAMAuthHandler</span>
                <span class="n">tornado_settings</span><span class="p">[</span><span class="s">&#39;pam_realm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;pam_realm&quot;</span><span class="p">]</span>
                <span class="n">tornado_settings</span><span class="p">[</span><span class="s">&#39;pam_service&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s">&quot;pam_service&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;google&#39;</span><span class="p">:</span>
                <span class="n">AuthHandler</span> <span class="o">=</span> <span class="n">GoogleAuthHandler</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Using </span><span class="si">%s</span><span class="s"> authentication&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="p">[</span><span class="s">&#39;auth&#39;</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;No authentication method configured. All users will &quot;</span>
                         <span class="s">&quot;be %anonymous&quot;</span><span class="p">))</span>
        <span class="n">docs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;docs&#39;</span><span class="p">)</span>
        <span class="n">docs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docs_path</span><span class="p">,</span> <span class="s">&#39;build&#39;</span><span class="p">)</span>
        <span class="n">docs_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docs_path</span><span class="p">,</span> <span class="s">&#39;html&#39;</span><span class="p">)</span>
        <span class="c"># Setup our URL handlers</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s">r&quot;/&quot;</span><span class="p">,</span> <span class="n">MainHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/ws&quot;</span><span class="p">,</span> <span class="n">TerminalWebSocket</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/auth&quot;</span><span class="p">,</span> <span class="n">AuthHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/style&quot;</span><span class="p">,</span> <span class="n">StyleHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/cssrender&quot;</span><span class="p">,</span> <span class="n">PluginCSSTemplateHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/combined_js&quot;</span><span class="p">,</span> <span class="n">JSPluginsHandler</span><span class="p">),</span>
            <span class="p">(</span><span class="s">r&quot;/docs/(.*)&quot;</span><span class="p">,</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">StaticFileHandler</span><span class="p">,</span> <span class="p">{</span>
                <span class="s">&quot;path&quot;</span><span class="p">:</span> <span class="n">docs_path</span><span class="p">,</span>
                <span class="s">&quot;default_filename&quot;</span><span class="p">:</span> <span class="s">&quot;index.html&quot;</span>
            <span class="p">})</span>
        <span class="p">]</span>
        <span class="c"># Connect the hooks</span>
        <span class="k">for</span> <span class="n">plugin_name</span><span class="p">,</span> <span class="n">hooks</span> <span class="ow">in</span> <span class="n">PLUGIN_HOOKS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s">&#39;Web&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s Web handlers</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">handlers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Web&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;WebSocket&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s WebSocket commands</span>
                <span class="n">PLUGIN_WS_CMDS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;WebSocket&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s">&#39;Escape&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s Escape handler</span>
                <span class="n">PLUGIN_ESC_HANDLERS</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">plugin_name</span><span class="p">:</span> <span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Escape&#39;</span><span class="p">]})</span>
            <span class="k">if</span> <span class="s">&#39;Auth&#39;</span> <span class="ow">in</span> <span class="n">hooks</span><span class="p">:</span>
                <span class="c"># Apply the plugin&#39;s post-authentication functions</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Auth&#39;</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">PLUGIN_AUTH_HOOKS</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Auth&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">PLUGIN_AUTH_HOOKS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hooks</span><span class="p">[</span><span class="s">&#39;Auth&#39;</span><span class="p">])</span>
        <span class="c"># This removes duplicate handlers for the same regex, allowing plugins</span>
        <span class="c"># to override defaults:</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="n">merge_handlers</span><span class="p">(</span><span class="n">handlers</span><span class="p">)</span>
        <span class="c"># Include JS-only and CSS-only plugins (for logging purposes)</span>
        <span class="n">js_plugins</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;js&#39;</span><span class="p">]]</span>
        <span class="n">css_plugins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">css_plugins</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;?&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span> <span class="c"># CSS Template</span>
                <span class="n">css_plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;plugin=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;&amp;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># Static CSS file</span>
                <span class="n">css_plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c">#css_plugins = [a.split(&#39;?&#39;)[1].split(&#39;&amp;&#39;)[0].split(&#39;=&#39;)[1] for a in PLUGINS[&#39;css&#39;]]</span>
        <span class="n">plugin_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;py&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">js_plugins</span> <span class="o">+</span> <span class="n">css_plugins</span><span class="p">))</span>
        <span class="n">plugin_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="c"># So there&#39;s consistent ordering</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Loaded plugins: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">plugin_list</span><span class="p">)))</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handlers</span><span class="p">,</span> <span class="o">**</span><span class="n">tornado_settings</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_</span>
    <span class="k">global</span> <span class="n">user_locale</span>
    <span class="c"># Default to using the shell&#39;s LANG variable as the locale</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">default_locale</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;LANG&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span> <span class="c"># $LANG isn&#39;t set</span>
        <span class="n">default_locale</span> <span class="o">=</span> <span class="s">&quot;en_US&quot;</span>
    <span class="n">user_locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">default_locale</span><span class="p">)</span>
    <span class="c"># NOTE: The locale setting above is only for the --help messages.</span>
    <span class="c"># Simplify the auth option help message</span>
    <span class="n">auths</span> <span class="o">=</span> <span class="s">&quot;none, api, google&quot;</span>
    <span class="k">if</span> <span class="n">KerberosAuthHandler</span><span class="p">:</span>
        <span class="n">auths</span> <span class="o">+=</span> <span class="s">&quot;, kerberos&quot;</span>
    <span class="k">if</span> <span class="n">PAMAuthHandler</span><span class="p">:</span>
        <span class="n">auths</span> <span class="o">+=</span> <span class="s">&quot;, pam&quot;</span>
    <span class="c"># Simplify the syslog_facility option help message</span>
    <span class="n">facilities</span> <span class="o">=</span> <span class="n">FACILITIES</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="n">facilities</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;config&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;server.conf&quot;</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Path to the config file.  Default: </span><span class="si">%s</span><span class="s">/server.conf&quot;</span> <span class="o">%</span> <span class="n">GATEONE_DIR</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;debug&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Enable debugging features such as auto-restarting when files &quot;</span>
               <span class="s">&quot;are modified.&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;cookie_secret&quot;</span><span class="p">,</span> <span class="c"># 45 chars is, &quot;Good enough for me&quot; (cookie joke =)</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Use the given 45-character string for cookie encryption.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;command&quot;</span><span class="p">,</span>
        <span class="c"># The default command assumes the SSH plugin is enabled</span>
        <span class="n">default</span><span class="o">=</span><span class="n">GATEONE_DIR</span> <span class="o">+</span> <span class="s">&quot;/plugins/ssh/scripts/ssh_connect.py -S &quot;</span>
                <span class="s">r&quot;&#39;/tmp/gateone/%SESSION%/%SHORT_SOCKET%&#39; --sshfp &quot;</span>
                <span class="s">&quot;-a &#39;-oUserKnownHostsFile=%USERDIR%/%USER%/ssh/known_hosts&#39;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Run the given command when a user connects (e.g. &#39;/bin/login&#39;).&quot;</span>
               <span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;address&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Run on the given address.  Default is all addresses (IPv6 &quot;</span>
               <span class="s">&quot;included).  Multiple address can be specified using a semicolon&quot;</span>
               <span class="s">&quot; as a separator (e.g. &#39;127.0.0.1;::1;10.1.1.100&#39;).&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;port&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">443</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Run on the given port.&quot;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="c"># Please only use this if Gate One is running behind something with SSL:</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;disable_ssl&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;If enabled, Gate One will run without SSL (generally not a &quot;</span>
               <span class="s">&quot;good idea).&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;certificate&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;certificate.pem&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Path to the SSL certificate.  Will be auto-generated if none is&quot;</span>
               <span class="s">&quot; provided.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;keyfile&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;keyfile.pem&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Path to the SSL keyfile.  Will be auto-generated if none is&quot;</span>
               <span class="s">&quot; provided.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;user_dir&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;users&quot;</span><span class="p">),</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Path to the location where user files will be stored.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;session_dir&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;/tmp/gateone&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Path to the location where session information will be stored.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;session_logging&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;If enabled, logs of user sessions will be saved in &quot;</span>
               <span class="s">&quot;&lt;user_dir&gt;/&lt;user&gt;/logs.  Default: Enabled&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span> <span class="c"># This is an easy way to support cetralized logging</span>
        <span class="s">&quot;syslog_session_logging&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;If enabled, logs of user sessions will be written to syslog.&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;syslog_facility&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;daemon&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Syslog facility to use when logging to syslog (if &quot;</span>
               <span class="s">&quot;syslog_session_logging is enabled).  Must be one of: </span><span class="si">%s</span><span class="s">.&quot;</span>
               <span class="s">&quot;  Default: daemon&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">facilities</span><span class="p">)),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;syslog_host&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Remote host to send syslog messages to if syslog_logging is &quot;</span>
               <span class="s">&quot;enabled.  Default: None (log to the local syslog daemon &quot;</span>
               <span class="s">&quot;directly).  NOTE:  This setting is required on platforms that &quot;</span>
               <span class="s">&quot;don&#39;t include Python&#39;s syslog module.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;session_timeout&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;5d&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Amount of time that a session should be kept alive after the &quot;</span>
        <span class="s">&quot;client has logged out.  Accepts &lt;num&gt;X where X could be one of s, m, h&quot;</span>
        <span class="s">&quot;, or d for seconds, minutes, hours, and days.  Default is &#39;5d&#39; (5 days&quot;</span>
        <span class="s">&quot;).&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;new_api_key&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Generate a new API key that an external application can use to&quot;</span>
               <span class="s">&quot;embed Gate One.&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;auth&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Authentication method to use.  Valid options are: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">auths</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;sso_realm&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Kerberos REALM (aka DOMAIN) to use when authenticating clients.&quot;</span>
               <span class="s">&quot; Only relevant if Kerberos authentication is enabled.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;sso_service&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&#39;HTTP&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Kerberos service (aka application) to use. Defaults to HTTP. &quot;</span>
               <span class="s">&quot;Only relevant if Kerberos authentication is enabled.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;pam_realm&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">uname</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Basic auth REALM to display when authenticating clients.  &quot;</span>
        <span class="s">&quot;Default: hostname.  &quot;</span>
        <span class="s">&quot;Only relevant if PAM authentication is enabled.&quot;</span><span class="p">),</span>
        <span class="c"># NOTE: This is only used to show the user a REALM at the basic auth</span>
        <span class="c">#       prompt and as the name in the GATEONE_DIR+&#39;/users&#39; directory</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;pam_service&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&#39;login&#39;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;PAM service to use.  Defaults to &#39;login&#39;. &quot;</span>
               <span class="s">&quot;Only relevant if PAM authentication is enabled.&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;embedded&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Run Gate One in Embedded Mode (no toolbar, only one terminal &quot;</span>
               <span class="s">&quot;allowed, etc.  See docs).&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;dtach&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Wrap terminals with dtach. Allows sessions to be resumed even &quot;</span>
               <span class="s">&quot;if Gate One is stopped and started (which is a sweet feature).&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;kill&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Kill any running Gate One terminal processes including dtach&#39;d &quot;</span>
               <span class="s">&quot;processes.&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;locale&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">default_locale</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;The locale (e.g. pt_PT) Gate One should use for translations.&quot;</span>
             <span class="s">&quot;  If not provided, will default to $LANG (which is &#39;</span><span class="si">%s</span><span class="s">&#39; in your &quot;</span>
             <span class="s">&quot;current shell), or en_US if not set.&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;LANG&#39;</span><span class="p">,</span> <span class="s">&#39;not set&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span><span class="s">&quot;js_init&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;A JavaScript object (string) that will be used when running &quot;</span>
               <span class="s">&quot;GateOne.init() inside index.html.  &quot;</span>
               <span class="s">&quot;Example: --js_init=</span><span class="se">\&quot;</span><span class="s">{scheme: &#39;white&#39;}</span><span class="se">\&quot;</span><span class="s"> would result in &quot;</span>
               <span class="s">&quot;GateOne.init({scheme: &#39;white&#39;})&quot;</span><span class="p">),</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span>
    <span class="p">)</span>
    <span class="n">define</span><span class="p">(</span>
        <span class="s">&quot;https_redirect&quot;</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;If enabled, a separate listener will be started on port 80 that&quot;</span>
               <span class="s">&quot; redirects users to the configured port using HTTPS.&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="c"># Before we do anythong else, load plugins and assign their hooks.  This</span>
    <span class="c"># allows plugins to add their own define() statements/options.</span>
    <span class="n">imported</span> <span class="o">=</span> <span class="n">load_plugins</span><span class="p">(</span><span class="n">PLUGINS</span><span class="p">[</span><span class="s">&#39;py&#39;</span><span class="p">])</span>
    <span class="n">new_conf</span> <span class="o">=</span> <span class="bp">False</span> <span class="c"># Used below to tell the user that a server.conf was</span>
                     <span class="c"># generated in their chosen language.</span>
    <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">imported</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">PLUGIN_HOOKS</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">plugin</span><span class="o">.</span><span class="n">__name__</span><span class="p">:</span> <span class="n">plugin</span><span class="o">.</span><span class="n">hooks</span><span class="p">})</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># No hooks--probably just a supporting .py file.</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">):</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parse_config_file</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c"># Generate a default server.conf with a random cookie secret</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
           <span class="s">&quot;</span><span class="si">%s</span><span class="s"> not found.  A new one will be generated with defaults.&quot;</span> <span class="o">%</span>
           <span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">))</span>
        <span class="n">config_defaults</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">config_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">default</span><span class="p">})</span>
        <span class="c"># A few config defaults need special handling</span>
        <span class="k">del</span> <span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;kill&#39;</span><span class="p">]</span> <span class="c"># This shouldn&#39;t be in server.conf</span>
        <span class="k">del</span> <span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;help&#39;</span><span class="p">]</span> <span class="c"># Neither should this</span>
        <span class="k">del</span> <span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;new_api_key&#39;</span><span class="p">]</span> <span class="c"># Ditto</span>
        <span class="k">del</span> <span class="n">config_defaults</span><span class="p">[</span><span class="s">&#39;config&#39;</span><span class="p">]</span> <span class="c"># Re-ditto</span>
        <span class="n">config_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;cookie_secret&#39;</span><span class="p">:</span> <span class="n">generate_session_id</span><span class="p">()})</span>
        <span class="c"># NOTE: The next four options are specific to the Tornado framework</span>
        <span class="n">config_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;log_file_max_size&#39;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">})</span> <span class="c"># 100MB</span>
        <span class="n">config_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;log_file_num_backups&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">})</span>
        <span class="n">config_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s">&#39;log_to_stderr&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">})</span>
        <span class="n">web_log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&#39;logs&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">web_log_path</span><span class="p">):</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">web_log_path</span><span class="p">)</span>
        <span class="n">config_defaults</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s">&#39;log_file_prefix&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">web_log_path</span><span class="p">,</span> <span class="s">&#39;webserver.log&#39;</span><span class="p">)})</span>
        <span class="n">config</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config_defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = &quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="n">config</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parse_config_file</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
    <span class="n">tornado</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">parse_command_line</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">user_dir</span><span class="p">):</span> <span class="c"># Make our user_dir</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">user_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Error: Gate One could not create </span><span class="si">%s</span><span class="s">.  Please ensure that user,&quot;</span>
                <span class="s">&quot; </span><span class="si">%s</span><span class="s"> has permission to create this directory or create it &quot;</span>
                <span class="s">&quot;yourself and make user, </span><span class="si">%s</span><span class="s"> its owner.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">user_dir</span><span class="p">,</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">()),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">()))))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># If we could create it we should be able to adjust its permissions:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">user_dir</span><span class="p">,</span> <span class="mo">0700</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">user_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Error: Gate One does not have permission to write to </span><span class="si">%s</span><span class="s">.  Please&quot;</span>
            <span class="s">&quot; ensure that user, </span><span class="si">%s</span><span class="s"> has write permission to the directory.&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">options</span><span class="o">.</span><span class="n">user_dir</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">()))))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">):</span> <span class="c"># Make our session_dir</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Error: Gate One could not create </span><span class="si">%s</span><span class="s">.  Please ensure that user,&quot;</span>
                <span class="s">&quot; </span><span class="si">%s</span><span class="s"> has permission to create this directory or create it &quot;</span>
                <span class="s">&quot;yourself and make user, </span><span class="si">%s</span><span class="s"> its owner.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">,</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">()),</span> <span class="nb">repr</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">()))))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">,</span> <span class="mo">0700</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Error: Gate One does not have permission to write to </span><span class="si">%s</span><span class="s">.  Please&quot;</span>
            <span class="s">&quot; ensure that user, </span><span class="si">%s</span><span class="s"> has write permission to the directory.&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">())))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c"># Re-do the locale in case the user supplied something as --locale</span>
    <span class="n">user_locale</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">locale</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">user_locale</span><span class="o">.</span><span class="n">translate</span> <span class="c"># Also replaces our wrapper so no more .encode()</span>
    <span class="c"># Create the log dir if not already present (NOTE: Assumes we&#39;re root)</span>
    <span class="n">log_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">log_file_prefix</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">log_dir</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mkdir_p</span><span class="p">(</span><span class="n">log_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x1b</span><span class="s">[1;31mERROR:</span><span class="se">\x1b</span><span class="s">[0m Could not create </span><span class="si">%s</span><span class="s"> for &quot;</span>
                  <span class="s">&quot;log_file_prefix: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">options</span><span class="o">.</span><span class="n">log_file_prefix</span><span class="p">)))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;You probably want to change this option, run Gate &quot;</span>
                  <span class="s">&quot;One as root, or create that directory and give the proper &quot;</span>
                  <span class="s">&quot;user ownership of it.&quot;</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">log_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">W_OK</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Error: Gate One does not have permission to write to </span><span class="si">%s</span><span class="s">.  Please&quot;</span>
            <span class="s">&quot; ensure that user, </span><span class="si">%s</span><span class="s"> has write permission to the directory.&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">log_dir</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">()))))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">kill</span><span class="p">:</span>
        <span class="c"># Kill all running dtach sessions (associated with Gate One anyway)</span>
        <span class="n">killall</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">new_api_key</span><span class="p">:</span>
        <span class="c"># Generate a new API key for an application to use</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
        <span class="c"># Generate a new secret</span>
        <span class="n">secret</span> <span class="o">=</span> <span class="n">generate_session_id</span><span class="p">()</span>
        <span class="c"># Save it</span>
        <span class="n">server_conf</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">existing</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;api_keys&quot;</span><span class="p">):</span>
                    <span class="n">existing</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span>
                    <span class="n">existing</span> <span class="o">+=</span> <span class="s">&quot;,</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="s">&#39;api_keys = &quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">existing</span>
                <span class="n">server_conf</span> <span class="o">+=</span> <span class="n">line</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">existing</span><span class="p">:</span>
                <span class="n">server_conf</span> <span class="o">+=</span> <span class="s">&#39;api_keys = &quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="n">secret</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">server_conf</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;A new API key has been generated: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">api_key</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;This key can now be used to embed Gate One into other &quot;</span>
                <span class="s">&quot;applications.&quot;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c"># Set our CMD variable to tell the multiplexer which command to execute</span>
    <span class="k">global</span> <span class="n">CMD</span>
    <span class="n">CMD</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">command</span>
    <span class="c"># Set our global session timeout</span>
    <span class="k">global</span> <span class="n">TIMEOUT</span>
    <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="n">convert_to_timedelta</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">session_timeout</span><span class="p">)</span>
    <span class="c"># Make sure dtach is available and if not, set dtach=False</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">which</span><span class="p">(</span><span class="s">&#39;dtach&#39;</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="n">_</span><span class="p">(</span><span class="s">&quot;dtach command not found.  dtach support has been disabled.&quot;</span><span class="p">))</span>
        <span class="n">options</span><span class="o">.</span><span class="n">dtach</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c"># Turn our API keys into a dict</span>
    <span class="n">api_keys</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">config</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;api_keys&quot;</span><span class="p">):</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">)</span>
                <span class="n">pairs</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                    <span class="n">api_key</span><span class="p">,</span> <span class="n">secret</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                    <span class="n">api_keys</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">api_key</span><span class="p">:</span> <span class="n">secret</span><span class="p">})</span>
    <span class="c"># Define our Application settings</span>
    <span class="n">app_settings</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;gateone_dir&#39;</span><span class="p">:</span> <span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="c"># Only here so plugins can reference it</span>
        <span class="s">&#39;debug&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span>
        <span class="s">&#39;cookie_secret&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">cookie_secret</span><span class="p">,</span>
        <span class="s">&#39;auth&#39;</span><span class="p">:</span> <span class="n">none_fix</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">auth</span><span class="p">),</span>
        <span class="s">&#39;embedded&#39;</span><span class="p">:</span> <span class="n">str2bool</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">embedded</span><span class="p">),</span>
        <span class="s">&#39;js_init&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">js_init</span><span class="p">,</span>
        <span class="s">&#39;user_dir&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">user_dir</span><span class="p">,</span>
        <span class="s">&#39;logging&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">logging</span><span class="p">,</span> <span class="c"># For reference, really</span>
        <span class="s">&#39;session_dir&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">session_dir</span><span class="p">,</span>
        <span class="s">&#39;session_logging&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">session_logging</span><span class="p">,</span>
        <span class="s">&#39;syslog_session_logging&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">syslog_session_logging</span><span class="p">,</span>
        <span class="s">&#39;syslog_facility&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">syslog_facility</span><span class="p">,</span>
        <span class="s">&#39;syslog_host&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">syslog_host</span><span class="p">,</span>
        <span class="s">&#39;dtach&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">dtach</span><span class="p">,</span>
        <span class="s">&#39;sso_realm&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">sso_realm</span><span class="p">,</span>
        <span class="s">&#39;sso_service&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">sso_service</span><span class="p">,</span>
        <span class="s">&#39;pam_realm&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">pam_realm</span><span class="p">,</span>
        <span class="s">&#39;pam_service&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">pam_service</span><span class="p">,</span>
        <span class="s">&#39;locale&#39;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">locale</span><span class="p">,</span>
        <span class="s">&#39;api_keys&#39;</span><span class="p">:</span> <span class="n">api_keys</span>
    <span class="p">}</span>
    <span class="c"># Check to make sure we have a certificate and keyfile and generate fresh</span>
    <span class="c"># ones if not.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">keyfile</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;No SSL private key found.  One will be generated.&quot;</span><span class="p">))</span>
        <span class="n">gen_self_signed_ssl</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">certificate</span><span class="p">):</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;No SSL certificate found.  One will be generated.&quot;</span><span class="p">))</span>
        <span class="n">gen_self_signed_ssl</span><span class="p">()</span>
    <span class="c"># Setup static file links for plugins (if any)</span>
    <span class="n">static_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;static&quot;</span><span class="p">)</span>
    <span class="n">plugin_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;plugins&quot;</span><span class="p">)</span>
    <span class="n">templates_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">GATEONE_DIR</span><span class="p">,</span> <span class="s">&quot;templates&quot;</span><span class="p">)</span>
    <span class="n">combined_plugins</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">static_dir</span><span class="p">,</span> <span class="s">&quot;combined_plugins.js&quot;</span><span class="p">)</span>
    <span class="c"># Remove the combined_plugins.js (it will get auto-recreated)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">combined_plugins</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">combined_plugins</span><span class="p">)</span>
    <span class="n">create_plugin_links</span><span class="p">(</span><span class="n">static_dir</span><span class="p">,</span> <span class="n">templates_dir</span><span class="p">,</span> <span class="n">plugin_dir</span><span class="p">)</span>
    <span class="c"># When options.logging==&quot;debug&quot; it will display all user&#39;s keystrokes so</span>
    <span class="c"># make sure we warn about this.</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">logging</span> <span class="o">==</span> <span class="s">&quot;debug&quot;</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
            <span class="s">&quot;Logging is set to DEBUG.  Be aware that this will record the &quot;</span>
            <span class="s">&quot;keystrokes of all users.  Don&#39;t be evil!&quot;</span><span class="p">))</span>
    <span class="c"># Instantiate our Tornado web server</span>
    <span class="n">ssl_options</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;certfile&quot;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">certificate</span><span class="p">,</span>
        <span class="s">&quot;keyfile&quot;</span><span class="p">:</span> <span class="n">options</span><span class="o">.</span><span class="n">keyfile</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">disable_ssl</span><span class="p">:</span>
        <span class="n">ssl_options</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">https_server</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">httpserver</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">(</span>
        <span class="n">Application</span><span class="p">(</span><span class="n">settings</span><span class="o">=</span><span class="n">app_settings</span><span class="p">),</span> <span class="n">ssl_options</span><span class="o">=</span><span class="n">ssl_options</span><span class="p">)</span>
    <span class="n">https_redirect</span> <span class="o">=</span> <span class="n">tornado</span><span class="o">.</span><span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">([(</span><span class="s">r&quot;/&quot;</span><span class="p">,</span> <span class="n">HTTPSRedirectHandler</span><span class="p">),])</span>
    <span class="k">try</span><span class="p">:</span> <span class="c"># Start your engines!</span>
        <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">address</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">options</span><span class="o">.</span><span class="n">address</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">addr</span><span class="p">:</span> <span class="c"># Listen on all given addresses</span>
                    <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">https_redirect</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                         <span class="s">&quot;http://{address}:80/ will be redirected to...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">address</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
                        <span class="p">))</span>
                        <span class="n">https_redirect</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                        <span class="s">&quot;Listening on https://{address}:{port}/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">address</span><span class="o">=</span><span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
                    <span class="p">))</span>
                    <span class="n">https_server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="n">addr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># Listen on all addresses (including IPv6)</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">https_redirect</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;http://*:80/ will be redirected to...&quot;</span><span class="p">))</span>
                <span class="n">https_redirect</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Listening on https://*:{port}/&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">port</span><span class="p">)))</span>
            <span class="n">https_server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">port</span><span class="o">=</span><span class="n">options</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">tornado</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">IOLoop</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span> <span class="c"># ctrl-c</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Caught KeyboardInterrupt.  Killing sessions...&quot;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threading</span><span class="o">.</span><span class="n">enumerate</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">getName</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;TidyThread&#39;</span><span class="p">):</span>
                <span class="n">t</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/ls_logo_1inch_300dpi.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Gate One Documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Liftoff Software Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>