

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>terminal &mdash; Gate One 1.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/ansi.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.png"/>
    <link rel="top" title="Gate One 1.0 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Gate One Documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for terminal</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c">#       Copyright 2011 Liftoff Software Corporation</span>
<span class="c">#</span>

<span class="c"># Meta</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;0.9&#39;</span>
<span class="n">__license__</span> <span class="o">=</span> <span class="s">&quot;AGPLv3 or Proprietary (see LICENSE.txt)&quot;</span>
<span class="n">__version_info__</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Dan McDougall &lt;daniel.mcdougall@liftoffsoftware.com&gt;&#39;</span>

<span class="n">__doc__</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">About This Module</span>
<span class="s">=================</span>
<span class="s">This crux of this module is the Terminal class which is a pure-Python</span>
<span class="s">implementation of the quintessential Unix terminal emulator.  It does its best</span>
<span class="s">to emulate an xterm and along with that comes support for the majority of the</span>
<span class="s">relevant portions of ECMA-48.  This includes support for emulating varous VT-*</span>
<span class="s">terminal types as well as the &quot;linux&quot; terminal type.</span>

<span class="s">The Terminal class&#39;s VT-* emulation support is not complete but it should</span>
<span class="s">suffice for most terminal emulation needs (e.g. all your typical command line</span>
<span class="s">programs should work wonderfully).  If something doesn&#39;t look quite right or you</span>
<span class="s">need support for certain modes added please feel free to open a ticket on Gate</span>
<span class="s">One&#39;s issue tracker:  https://github.com/liftoff/GateOne/issues</span>

<span class="s">Note that Terminal was written from scratch in order to be as fast as possible.</span>
<span class="s">It is extensively commented and implements some interesting patterns in order to</span>
<span class="s">maximize execution speed (most notably for things that loop).  Some bits of code</span>
<span class="s">may seem &quot;un-Pythonic&quot; and/or difficult to grok but understand that this is</span>
<span class="s">probably due to optimizations.  If you know &quot;a better way&quot; please feel free to</span>
<span class="s">submit a patch, open a ticket, or send us an email.  There&#39;s a reason why open</span>
<span class="s">source software is a superior development model!</span>

<span class="s">Supported Emulation Types</span>
<span class="s">-------------------------</span>
<span class="s">Without any special mode settings or parameters Terminal should effectively</span>
<span class="s">emulate the following terminal types:</span>

<span class="s"> * xterm (the most important one)</span>
<span class="s"> * ECMA-48/ANSI X3.64</span>
<span class="s"> * Nearly all the VT-* types:  VT-52, VT-100, VT-220, VT-320, VT-420, and VT-520</span>
<span class="s"> * Linux console (&quot;linux&quot;)</span>

<span class="s">If you want Terminal to support something else or it&#39;s missing a feature from</span>
<span class="s">any given terminal type please let us know.  We&#39;ll implement it!</span>

<span class="s">What Terminal Doesn&#39;t Do</span>
<span class="s">------------------------</span>
<span class="s">The Terminal class is meant to emulate the display portion of a given terminal.</span>
<span class="s">It does not translate keystrokes into escape sequences or special control</span>
<span class="s">codes--you&#39;ll have to take care of that in your application (or at the</span>
<span class="s">client-side like Gate One).  It does, however, keep track of many</span>
<span class="s">keystroke-specific modes of operation such as Application Cursor Keys and the G0</span>
<span class="s">and G1 charset modes *with* callbacks that can be used to notify your</span>
<span class="s">application when such things change.</span>

<span class="s">Special Considerations</span>
<span class="s">----------------------</span>
<span class="s">Many methods inside Terminal start with an underscore.  This was done to</span>
<span class="s">indicate that such methods shouldn&#39;t be called directly (from a program that</span>
<span class="s">imported the module).  If it was thought that a situation might arise where a</span>
<span class="s">method could be used externally by a controlling program, the underscore was</span>
<span class="s">omitted.</span>

<span class="s">Asynchronous Use</span>
<span class="s">----------------</span>
<span class="s">To support asynchronous usage (and make everything faster), Terminal was written</span>
<span class="s">to support extensive callbacks that are called when certain events are</span>
<span class="s">encountered.  Here are the events and their callbacks:</span>

<span class="s">============================    ========================================================================</span>
<span class="s">Callback                        Called when...</span>
<span class="s">============================    ========================================================================</span>
<span class="s">CALLBACK_SCROLL_UP              The terminal is scrolled up (back).</span>
<span class="s">CALLBACK_CHANGED                The screen is changed/updated.</span>
<span class="s">CALLBACK_CURSOR_POS             The cursor position changes.</span>
<span class="s">CALLBACK_DSR                    A Device Status Report (DSR) is requested (via the DSR escape sequence).</span>
<span class="s">CALLBACK_TITLE                  The terminal title changes (xterm-style)</span>
<span class="s">CALLBACK_BELL                   The bell character (^G) is encountered.</span>
<span class="s">CALLBACK_OPT                    The special optional escape sequence is encountered.</span>
<span class="s">CALLBACK_MODE                   The terminal mode setting changes (e.g. use alternate screen buffer).</span>
<span class="s">============================    ========================================================================</span>

<span class="s">Note that CALLBACK_DSR is special in that it in most cases it will be called with arguments.  See the code for examples of how and when this happens.</span>

<span class="s">Also, in most cases it is unwise to override CALLBACK_MODE since this method is primarily meant for internal use within the Terminal class.</span>

<span class="s">Using Terminal</span>
<span class="s">--------------</span>
<span class="s">Gate One makes extensive use of the Terminal class and its callbacks.  So that&#39;s</span>
<span class="s">a great place to look for specific examples (gateone.py and termio.py,</span>
<span class="s">specifically).  Having said that, implementing Terminal is pretty</span>
<span class="s">straightforward::</span>

<span class="s">    &gt;&gt;&gt; import terminal</span>
<span class="s">    &gt;&gt;&gt; term = terminal.Terminal(24, 80)</span>
<span class="s">    &gt;&gt;&gt; term.write(&quot;This text will be written to the terminal screen.&quot;)</span>
<span class="s">    &gt;&gt;&gt; term.dump()</span>
<span class="s">    [u&#39;This text will be written to the terminal screen.                               &#39;,</span>
<span class="s">    &lt;snip&gt;</span>
<span class="s">    u&#39;                                                                                &#39;]</span>

<span class="s">Here&#39;s an example with some basic callbacks:</span>

<span class="s">    &gt;&gt;&gt; def mycallback():</span>
<span class="s">    ...     &quot;This will be called whenever the screen changes.&quot;</span>
<span class="s">    ...     print(&quot;Screen update! Perfect time to dump the terminal screen.&quot;)</span>
<span class="s">    ...     print(term.dump()[0]) # Only need to see the top line for this demo =)</span>
<span class="s">    ...     print(&quot;Just dumped the screen.&quot;)</span>
<span class="s">    &gt;&gt;&gt; import terminal</span>
<span class="s">    &gt;&gt;&gt; term = terminal.Terminal(24, 80)</span>
<span class="s">    &gt;&gt;&gt; term.callbacks[term.CALLBACK_CHANGED] = mycallback</span>
<span class="s">    &gt;&gt;&gt; term.write(&quot;This should result in mycallback() being called&quot;)</span>
<span class="s">    Screen update! Perfect time to dump the terminal screen.</span>
<span class="s">    This should result in mycallback() being called</span>
<span class="s">    Just dumped the screen.</span>

<span class="s">.. note:: In testing Gate One it was determined that it is faster to perform the conversion of a terminal screen to HTML on the server side than it is on the client side (via JavaScript anyway).</span>

<span class="s">About The Scrollback Bufffer</span>
<span class="s">----------------------------</span>
<span class="s">The Terminal class implements a scrollback buffer.  Here&#39;s how it works:</span>
<span class="s">Whenever a scroll_up() event occurs, the line (or lines) that will be removed</span>
<span class="s">from the top of the screen will be placed into Terminal.scrollback_buf.  Then,</span>
<span class="s">whenever dump_html() is called, the scrollback buffer will be returned along</span>
<span class="s">with the screen output and reset to an empty state.</span>

<span class="s">Why do this?  In the event that a very large write() occurs (e.g. &#39;ps aux&#39;), it</span>
<span class="s">gives the controlling program the ability to capture what went past the screen</span>
<span class="s">without some fancy tracking logic surrounding Terminal.write().</span>

<span class="s">More information about how this works can be had by looking at the dump_html()</span>
<span class="s">function itself.</span>

<span class="s">.. note:: There&#39;s more than one function that empties Terminal.scrollback_buf when called.  You&#39;ll just have to have a look around =)</span>

<span class="s">Class Docstrings</span>
<span class="s">================</span>
<span class="s">&quot;&quot;&quot;</span>

<span class="c"># Import stdlib stuff</span>
<span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">logging</span><span class="o">,</span> <span class="nn">base64</span><span class="o">,</span> <span class="nn">copy</span><span class="o">,</span> <span class="nn">StringIO</span><span class="o">,</span> <span class="nn">codecs</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">imap</span><span class="p">,</span> <span class="n">izip</span>

<span class="c"># Import our own stuff</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">get_translation</span>

<span class="c"># Import 3rd party stuff</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c"># We need PIL to detect image types and get their dimensions.  Without the</span>
    <span class="c"># dimenions, the browser will render the terminal screen much slower than</span>
    <span class="c"># normal.  Without PIL images will be displayed simply as:</span>
    <span class="c">#   &lt;i&gt;Image file&lt;/i&gt;</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">Image</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
        <span class="s">&quot;Could not import the Python Imaging Library (PIL) &quot;</span>
        <span class="s">&quot;so images will not be displayed in the terminal&quot;</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">get_translation</span><span class="p">()</span>

<span class="c"># Globals</span>
<span class="n">CALLBACK_SCROLL_UP</span> <span class="o">=</span> <span class="mi">1</span>    <span class="c"># Called after a scroll up event (new line)</span>
<span class="n">CALLBACK_CHANGED</span> <span class="o">=</span> <span class="mi">2</span>      <span class="c"># Called after the screen is updated</span>
<span class="n">CALLBACK_CURSOR_POS</span> <span class="o">=</span> <span class="mi">3</span>   <span class="c"># Called after the cursor position is updated</span>
<span class="c"># &lt;waives hand in air&gt; You are not concerned with the number 4</span>
<span class="n">CALLBACK_DSR</span> <span class="o">=</span> <span class="mi">5</span>          <span class="c"># Called when a DSR requires a response</span>
<span class="c"># NOTE: CALLBACK_DSR must accept &#39;response&#39; as either the first argument or</span>
<span class="c">#       as a keyword argument.</span>
<span class="n">CALLBACK_TITLE</span> <span class="o">=</span> <span class="mi">6</span>        <span class="c"># Called when the terminal sets the window title</span>
<span class="n">CALLBACK_BELL</span> <span class="o">=</span> <span class="mi">7</span>         <span class="c"># Called after ASCII_BEL is encountered.</span>
<span class="n">CALLBACK_OPT</span> <span class="o">=</span> <span class="mi">8</span> <span class="c"># Called when we encounter the optional ESC sequence</span>
<span class="c"># NOTE: CALLBACK_OPT must accept &#39;chars&#39; as either the first argument or as</span>
<span class="c">#       a keyword argument.</span>
<span class="n">CALLBACK_MODE</span> <span class="o">=</span> <span class="mi">9</span> <span class="c"># Called when the terminal mode changes (e.g. DECCKM)</span>
<span class="n">CALLBACK_RESET</span> <span class="o">=</span> <span class="mi">10</span> <span class="c"># Called when a terminal reset (^[[!p) is encountered</span>
<span class="n">CALLBACK_LEDS</span> <span class="o">=</span> <span class="mi">11</span> <span class="c"># Called when the state of the LEDs changes</span>

<span class="c"># These are for HTML output:</span>
<span class="n">RENDITION_CLASSES</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="p">{</span>
    <span class="mi">0</span><span class="p">:</span> <span class="s">&#39;reset&#39;</span><span class="p">,</span> <span class="c"># Special: Return everything to defaults</span>
    <span class="mi">1</span><span class="p">:</span> <span class="s">&#39;bold&#39;</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">:</span> <span class="s">&#39;dim&#39;</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">:</span> <span class="s">&#39;italic&#39;</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">:</span> <span class="s">&#39;underline&#39;</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">:</span> <span class="s">&#39;blink&#39;</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">:</span> <span class="s">&#39;fastblink&#39;</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">:</span> <span class="s">&#39;reverse&#39;</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">:</span> <span class="s">&#39;hidden&#39;</span><span class="p">,</span>
    <span class="mi">9</span><span class="p">:</span> <span class="s">&#39;strikethrough&#39;</span><span class="p">,</span>
    <span class="mi">10</span><span class="p">:</span> <span class="s">&#39;resetfont&#39;</span><span class="p">,</span> <span class="c"># NOTE: The font renditions don&#39;t do anything right now</span>
    <span class="mi">11</span><span class="p">:</span> <span class="s">&#39;font11&#39;</span><span class="p">,</span> <span class="c"># Mostly because I have no idea what they are supposed to look</span>
    <span class="mi">12</span><span class="p">:</span> <span class="s">&#39;font12&#39;</span><span class="p">,</span> <span class="c"># like.</span>
    <span class="mi">13</span><span class="p">:</span> <span class="s">&#39;font13&#39;</span><span class="p">,</span>
    <span class="mi">14</span><span class="p">:</span> <span class="s">&#39;font14&#39;</span><span class="p">,</span>
    <span class="mi">15</span><span class="p">:</span> <span class="s">&#39;font15&#39;</span><span class="p">,</span>
    <span class="mi">16</span><span class="p">:</span> <span class="s">&#39;font16&#39;</span><span class="p">,</span>
    <span class="mi">17</span><span class="p">:</span> <span class="s">&#39;font17&#39;</span><span class="p">,</span>
    <span class="mi">18</span><span class="p">:</span> <span class="s">&#39;font18&#39;</span><span class="p">,</span>
    <span class="mi">19</span><span class="p">:</span> <span class="s">&#39;font19&#39;</span><span class="p">,</span>
    <span class="mi">20</span><span class="p">:</span> <span class="s">&#39;fraktur&#39;</span><span class="p">,</span>
    <span class="mi">21</span><span class="p">:</span> <span class="s">&#39;boldreset&#39;</span><span class="p">,</span>
    <span class="mi">22</span><span class="p">:</span> <span class="s">&#39;dimreset&#39;</span><span class="p">,</span>
    <span class="mi">23</span><span class="p">:</span> <span class="s">&#39;italicreset&#39;</span><span class="p">,</span>
    <span class="mi">24</span><span class="p">:</span> <span class="s">&#39;underlinereset&#39;</span><span class="p">,</span>
    <span class="mi">27</span><span class="p">:</span> <span class="s">&#39;reversereset&#39;</span><span class="p">,</span>
    <span class="mi">28</span><span class="p">:</span> <span class="s">&#39;hiddenreset&#39;</span><span class="p">,</span>
    <span class="mi">29</span><span class="p">:</span> <span class="s">&#39;strikethroughreset&#39;</span><span class="p">,</span>
    <span class="c"># Foregrounds</span>
    <span class="mi">30</span><span class="p">:</span> <span class="s">&#39;f0&#39;</span><span class="p">,</span> <span class="c"># Black</span>
    <span class="mi">31</span><span class="p">:</span> <span class="s">&#39;f1&#39;</span><span class="p">,</span> <span class="c"># Red</span>
    <span class="mi">32</span><span class="p">:</span> <span class="s">&#39;f2&#39;</span><span class="p">,</span> <span class="c"># Green</span>
    <span class="mi">33</span><span class="p">:</span> <span class="s">&#39;f3&#39;</span><span class="p">,</span> <span class="c"># Yellow</span>
    <span class="mi">34</span><span class="p">:</span> <span class="s">&#39;f4&#39;</span><span class="p">,</span> <span class="c"># Blue</span>
    <span class="mi">35</span><span class="p">:</span> <span class="s">&#39;f5&#39;</span><span class="p">,</span> <span class="c"># Magenta</span>
    <span class="mi">36</span><span class="p">:</span> <span class="s">&#39;f6&#39;</span><span class="p">,</span> <span class="c"># Cyan</span>
    <span class="mi">37</span><span class="p">:</span> <span class="s">&#39;f7&#39;</span><span class="p">,</span> <span class="c"># White</span>
    <span class="mi">38</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># 256-color support uses this like so: \x1b[38;5;&lt;color num&gt;sm</span>
    <span class="c"># Backgrounds</span>
    <span class="mi">40</span><span class="p">:</span> <span class="s">&#39;b0&#39;</span><span class="p">,</span> <span class="c"># Black</span>
    <span class="mi">41</span><span class="p">:</span> <span class="s">&#39;b1&#39;</span><span class="p">,</span> <span class="c"># Red</span>
    <span class="mi">42</span><span class="p">:</span> <span class="s">&#39;b2&#39;</span><span class="p">,</span> <span class="c"># Green</span>
    <span class="mi">43</span><span class="p">:</span> <span class="s">&#39;b3&#39;</span><span class="p">,</span> <span class="c"># Yellow</span>
    <span class="mi">44</span><span class="p">:</span> <span class="s">&#39;b4&#39;</span><span class="p">,</span> <span class="c"># Blue</span>
    <span class="mi">45</span><span class="p">:</span> <span class="s">&#39;b5&#39;</span><span class="p">,</span> <span class="c"># Magenta</span>
    <span class="mi">46</span><span class="p">:</span> <span class="s">&#39;b6&#39;</span><span class="p">,</span> <span class="c"># Cyan</span>
    <span class="mi">47</span><span class="p">:</span> <span class="s">&#39;b7&#39;</span><span class="p">,</span> <span class="c"># White</span>
    <span class="mi">48</span><span class="p">:</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="c"># 256-color support uses this like so: \x1b[48;5;&lt;color num&gt;sm</span>
    <span class="mi">49</span><span class="p">:</span> <span class="s">&#39;backgroundreset&#39;</span><span class="p">,</span> <span class="c"># Special: Set BG to default</span>
    <span class="mi">51</span><span class="p">:</span> <span class="s">&#39;frame&#39;</span><span class="p">,</span>
    <span class="mi">52</span><span class="p">:</span> <span class="s">&#39;encircle&#39;</span><span class="p">,</span>
    <span class="mi">53</span><span class="p">:</span> <span class="s">&#39;overline&#39;</span><span class="p">,</span>
    <span class="mi">60</span><span class="p">:</span> <span class="s">&#39;rightline&#39;</span><span class="p">,</span>
    <span class="mi">61</span><span class="p">:</span> <span class="s">&#39;rightdoubleline&#39;</span><span class="p">,</span>
    <span class="mi">62</span><span class="p">:</span> <span class="s">&#39;leftline&#39;</span><span class="p">,</span>
    <span class="mi">63</span><span class="p">:</span> <span class="s">&#39;leftdoubleline&#39;</span><span class="p">,</span>
    <span class="c"># aixterm colors (aka &#39;16 color support&#39;).  They&#39;re supposed to be &#39;bright&#39;</span>
    <span class="c"># versions of the first 8 colors (hence the &#39;b&#39;).</span>
    <span class="c"># &#39;Bright&#39; Foregrounds</span>
    <span class="mi">90</span><span class="p">:</span> <span class="s">&#39;bf0&#39;</span><span class="p">,</span> <span class="c"># Bright black (whatever that is =)</span>
    <span class="mi">91</span><span class="p">:</span> <span class="s">&#39;bf1&#39;</span><span class="p">,</span> <span class="c"># Bright red</span>
    <span class="mi">92</span><span class="p">:</span> <span class="s">&#39;bf2&#39;</span><span class="p">,</span> <span class="c"># Bright green</span>
    <span class="mi">93</span><span class="p">:</span> <span class="s">&#39;bf3&#39;</span><span class="p">,</span> <span class="c"># Bright yellow</span>
    <span class="mi">94</span><span class="p">:</span> <span class="s">&#39;bf4&#39;</span><span class="p">,</span> <span class="c"># Bright blue</span>
    <span class="mi">95</span><span class="p">:</span> <span class="s">&#39;bf5&#39;</span><span class="p">,</span> <span class="c"># Bright magenta</span>
    <span class="mi">96</span><span class="p">:</span> <span class="s">&#39;bf6&#39;</span><span class="p">,</span> <span class="c"># Bright cyan</span>
    <span class="mi">97</span><span class="p">:</span> <span class="s">&#39;bf7&#39;</span><span class="p">,</span> <span class="c"># Bright white</span>
    <span class="c"># &#39;Bright&#39; Backgrounds</span>
    <span class="mi">100</span><span class="p">:</span> <span class="s">&#39;bb0&#39;</span><span class="p">,</span> <span class="c"># Bright black</span>
    <span class="mi">101</span><span class="p">:</span> <span class="s">&#39;bb1&#39;</span><span class="p">,</span> <span class="c"># Bright red</span>
    <span class="mi">102</span><span class="p">:</span> <span class="s">&#39;bb2&#39;</span><span class="p">,</span> <span class="c"># Bright green</span>
    <span class="mi">103</span><span class="p">:</span> <span class="s">&#39;bb3&#39;</span><span class="p">,</span> <span class="c"># Bright yellow</span>
    <span class="mi">104</span><span class="p">:</span> <span class="s">&#39;bb4&#39;</span><span class="p">,</span> <span class="c"># Bright blue</span>
    <span class="mi">105</span><span class="p">:</span> <span class="s">&#39;bb5&#39;</span><span class="p">,</span> <span class="c"># Bright magenta</span>
    <span class="mi">106</span><span class="p">:</span> <span class="s">&#39;bb6&#39;</span><span class="p">,</span> <span class="c"># Bright cyan</span>
    <span class="mi">107</span><span class="p">:</span> <span class="s">&#39;bb7&#39;</span> <span class="c"># Bright white</span>
<span class="p">})</span>
<span class="c"># Generate the dict of 256-color (xterm) foregrounds and backgrounds</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
    <span class="n">RENDITION_CLASSES</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1000</span><span class="p">)]</span> <span class="o">=</span> <span class="s">&quot;fx</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span>
    <span class="n">RENDITION_CLASSES</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">10000</span><span class="p">)]</span> <span class="o">=</span> <span class="s">&quot;bx</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span>
<span class="k">del</span> <span class="n">i</span> <span class="c"># Cleanup</span>

<div class="viewcode-block" id="handle_special"><a class="viewcode-back" href="../Developer/terminal.html#terminal.handle_special">[docs]</a><span class="k">def</span> <span class="nf">handle_special</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in conjunction with codecs.register_error, will replace special ascii</span>
<span class="sd">    characters such as 0xDA and 0xc4 (which are used by ncurses) with their</span>
<span class="sd">    Unicode equivalents.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># TODO: Get this using curses special characters when appropriate</span>
    <span class="n">curses_specials</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c"># NOTE: When $TERM is set to &quot;Linux&quot; these end up getting used by things</span>
        <span class="c">#       like ncurses-based apps.  In other words, it makes a whole lot</span>
        <span class="c">#       of ugly look pretty again.</span>
        <span class="mh">0xda</span><span class="p">:</span> <span class="s">u&#39;┌&#39;</span><span class="p">,</span> <span class="c"># ACS_ULCORNER</span>
        <span class="mh">0xc0</span><span class="p">:</span> <span class="s">u&#39;└&#39;</span><span class="p">,</span> <span class="c"># ACS_LLCORNER</span>
        <span class="mh">0xbf</span><span class="p">:</span> <span class="s">u&#39;┐&#39;</span><span class="p">,</span> <span class="c"># ACS_URCORNER</span>
        <span class="mh">0xd9</span><span class="p">:</span> <span class="s">u&#39;┘&#39;</span><span class="p">,</span> <span class="c"># ACS_LRCORNER</span>
        <span class="mh">0xb4</span><span class="p">:</span> <span class="s">u&#39;├&#39;</span><span class="p">,</span> <span class="c"># ACS_RTEE</span>
        <span class="mh">0xc3</span><span class="p">:</span> <span class="s">u&#39;┤&#39;</span><span class="p">,</span> <span class="c"># ACS_LTEE</span>
        <span class="mh">0xc1</span><span class="p">:</span> <span class="s">u&#39;┴&#39;</span><span class="p">,</span> <span class="c"># ACS_BTEE</span>
        <span class="mh">0xc2</span><span class="p">:</span> <span class="s">u&#39;┬&#39;</span><span class="p">,</span> <span class="c"># ACS_TTEE</span>
        <span class="mh">0xc4</span><span class="p">:</span> <span class="s">u&#39;─&#39;</span><span class="p">,</span> <span class="c"># ACS_HLINE</span>
        <span class="mh">0xb3</span><span class="p">:</span> <span class="s">u&#39;│&#39;</span><span class="p">,</span> <span class="c"># ACS_VLINE</span>
        <span class="mh">0xc5</span><span class="p">:</span> <span class="s">u&#39;┼&#39;</span><span class="p">,</span> <span class="c"># ACS_PLUS</span>
        <span class="mh">0x2d</span><span class="p">:</span> <span class="s">u&#39;&#39;</span><span class="p">,</span> <span class="c"># ACS_S1</span>
        <span class="mh">0x5f</span><span class="p">:</span> <span class="s">u&#39;&#39;</span><span class="p">,</span> <span class="c"># ACS_S9</span>
        <span class="mh">0x60</span><span class="p">:</span> <span class="s">u&#39;◆&#39;</span><span class="p">,</span> <span class="c"># ACS_DIAMOND</span>
        <span class="mh">0xb2</span><span class="p">:</span> <span class="s">u&#39;▒&#39;</span><span class="p">,</span> <span class="c"># ACS_CKBOARD</span>
        <span class="mh">0xf8</span><span class="p">:</span> <span class="s">u&#39;°&#39;</span><span class="p">,</span> <span class="c"># ACS_DEGREE</span>
        <span class="mh">0xf1</span><span class="p">:</span> <span class="s">u&#39;±&#39;</span><span class="p">,</span> <span class="c"># ACS_PLMINUS</span>
        <span class="mh">0xf9</span><span class="p">:</span> <span class="s">u&#39;•&#39;</span><span class="p">,</span> <span class="c"># ACS_BULLET</span>
        <span class="mh">0x3c</span><span class="p">:</span> <span class="s">u&#39;←&#39;</span><span class="p">,</span> <span class="c"># ACS_LARROW</span>
        <span class="mh">0x3e</span><span class="p">:</span> <span class="s">u&#39;→&#39;</span><span class="p">,</span> <span class="c"># ACS_RARROW</span>
        <span class="mh">0x76</span><span class="p">:</span> <span class="s">u&#39;↓&#39;</span><span class="p">,</span> <span class="c"># ACS_DARROW</span>
        <span class="mh">0x5e</span><span class="p">:</span> <span class="s">u&#39;↑&#39;</span><span class="p">,</span> <span class="c"># ACS_UARROW</span>
        <span class="mh">0xb0</span><span class="p">:</span> <span class="s">u&#39;⊞&#39;</span><span class="p">,</span> <span class="c"># ACS_BOARD</span>
        <span class="mh">0x0f</span><span class="p">:</span> <span class="s">u&#39;⨂&#39;</span><span class="p">,</span> <span class="c"># ACS_LANTERN</span>
        <span class="mh">0xdb</span><span class="p">:</span> <span class="s">u&#39;█&#39;</span><span class="p">,</span> <span class="c"># ACS_BLOCK</span>
    <span class="p">}</span>
    <span class="n">specials</span> <span class="o">=</span> <span class="p">{</span>
<span class="c"># Note to self:  Why did I bother with these overly descriptive comments?  Ugh</span>
<span class="c"># I&#39;ve been staring at obscure symbols far too much lately ⨀_⨀</span>
        <span class="mi">128</span><span class="p">:</span> <span class="s">u&#39;€&#39;</span><span class="p">,</span> <span class="c"># Euro sign</span>
        <span class="mi">129</span><span class="p">:</span> <span class="s">u&#39; &#39;</span><span class="p">,</span> <span class="c"># Unknown (Using non-breaking spaces for all unknowns)</span>
        <span class="mi">130</span><span class="p">:</span> <span class="s">u&#39;‚&#39;</span><span class="p">,</span> <span class="c"># Single low-9 quotation mark</span>
        <span class="mi">131</span><span class="p">:</span> <span class="s">u&#39;ƒ&#39;</span><span class="p">,</span> <span class="c"># Latin small letter f with hook</span>
        <span class="mi">132</span><span class="p">:</span> <span class="s">u&#39;„&#39;</span><span class="p">,</span> <span class="c"># Double low-9 quotation mark</span>
        <span class="mi">133</span><span class="p">:</span> <span class="s">u&#39;…&#39;</span><span class="p">,</span> <span class="c"># Horizontal ellipsis</span>
        <span class="mi">134</span><span class="p">:</span> <span class="s">u&#39;†&#39;</span><span class="p">,</span> <span class="c"># Dagger</span>
        <span class="mi">135</span><span class="p">:</span> <span class="s">u&#39;‡&#39;</span><span class="p">,</span> <span class="c"># Double dagger</span>
        <span class="mi">136</span><span class="p">:</span> <span class="s">u&#39;ˆ&#39;</span><span class="p">,</span> <span class="c"># Modifier letter circumflex accent</span>
        <span class="mi">137</span><span class="p">:</span> <span class="s">u&#39;‰&#39;</span><span class="p">,</span> <span class="c"># Per mille sign</span>
        <span class="mi">138</span><span class="p">:</span> <span class="s">u&#39;Š&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter S with caron</span>
        <span class="mi">139</span><span class="p">:</span> <span class="s">u&#39;‹&#39;</span><span class="p">,</span> <span class="c"># Single left-pointing angle quotation</span>
        <span class="mi">140</span><span class="p">:</span> <span class="s">u&#39;Œ&#39;</span><span class="p">,</span> <span class="c"># Latin capital ligature OE</span>
        <span class="mi">141</span><span class="p">:</span> <span class="s">u&#39; &#39;</span><span class="p">,</span> <span class="c"># Unknown</span>
        <span class="mi">142</span><span class="p">:</span> <span class="s">u&#39;Ž&#39;</span><span class="p">,</span> <span class="c">#  Latin captial letter Z with caron</span>
        <span class="mi">143</span><span class="p">:</span> <span class="s">u&#39; &#39;</span><span class="p">,</span> <span class="c"># Unknown</span>
        <span class="mi">144</span><span class="p">:</span> <span class="s">u&#39; &#39;</span><span class="p">,</span> <span class="c"># Unknown</span>
        <span class="mi">145</span><span class="p">:</span> <span class="s">u&#39;‘&#39;</span><span class="p">,</span> <span class="c"># Left single quotation mark</span>
        <span class="mi">146</span><span class="p">:</span> <span class="s">u&#39;’&#39;</span><span class="p">,</span> <span class="c"># Right single quotation mark</span>
        <span class="mi">147</span><span class="p">:</span> <span class="s">u&#39;“&#39;</span><span class="p">,</span> <span class="c"># Left double quotation mark</span>
        <span class="mi">148</span><span class="p">:</span> <span class="s">u&#39;”&#39;</span><span class="p">,</span> <span class="c"># Right double quotation mark</span>
        <span class="mi">149</span><span class="p">:</span> <span class="s">u&#39;•&#39;</span><span class="p">,</span> <span class="c"># Bullet</span>
        <span class="mi">150</span><span class="p">:</span> <span class="s">u&#39;–&#39;</span><span class="p">,</span> <span class="c"># En dash</span>
        <span class="mi">151</span><span class="p">:</span> <span class="s">u&#39;—&#39;</span><span class="p">,</span> <span class="c"># Em dash</span>
        <span class="mi">152</span><span class="p">:</span> <span class="s">u&#39;˜&#39;</span><span class="p">,</span> <span class="c"># Small tilde</span>
        <span class="mi">153</span><span class="p">:</span> <span class="s">u&#39;™&#39;</span><span class="p">,</span> <span class="c"># Trade mark sign</span>
        <span class="mi">154</span><span class="p">:</span> <span class="s">u&#39;š&#39;</span><span class="p">,</span> <span class="c"># Latin small letter S with caron</span>
        <span class="mi">155</span><span class="p">:</span> <span class="s">u&#39;›&#39;</span><span class="p">,</span> <span class="c">#  Single right-pointing angle quotation mark</span>
        <span class="mi">156</span><span class="p">:</span> <span class="s">u&#39;œ&#39;</span><span class="p">,</span> <span class="c"># Latin small ligature oe</span>
        <span class="mi">157</span><span class="p">:</span> <span class="s">u&#39;Ø&#39;</span><span class="p">,</span> <span class="c"># Upper-case slashed zero--using same as empty set (216)</span>
        <span class="mi">158</span><span class="p">:</span> <span class="s">u&#39;ž&#39;</span><span class="p">,</span> <span class="c"># Latin small letter z with caron</span>
        <span class="mi">159</span><span class="p">:</span> <span class="s">u&#39;Ÿ&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter Y with diaeresis</span>
        <span class="mi">160</span><span class="p">:</span> <span class="s">u&#39; &#39;</span><span class="p">,</span> <span class="c"># Non-breaking space</span>
        <span class="mi">161</span><span class="p">:</span> <span class="s">u&#39;¡&#39;</span><span class="p">,</span> <span class="c"># Inverted exclamation mark</span>
        <span class="mi">162</span><span class="p">:</span> <span class="s">u&#39;¢&#39;</span><span class="p">,</span> <span class="c"># Cent sign</span>
        <span class="mi">163</span><span class="p">:</span> <span class="s">u&#39;£&#39;</span><span class="p">,</span> <span class="c"># Pound sign</span>
        <span class="mi">164</span><span class="p">:</span> <span class="s">u&#39;¤&#39;</span><span class="p">,</span> <span class="c"># Currency sign</span>
        <span class="mi">165</span><span class="p">:</span> <span class="s">u&#39;¥&#39;</span><span class="p">,</span> <span class="c"># Yen sign</span>
        <span class="mi">166</span><span class="p">:</span> <span class="s">u&#39;¦&#39;</span><span class="p">,</span> <span class="c"># Pipe, Broken vertical bar</span>
        <span class="mi">167</span><span class="p">:</span> <span class="s">u&#39;§&#39;</span><span class="p">,</span> <span class="c"># Section sign</span>
        <span class="mi">168</span><span class="p">:</span> <span class="s">u&#39;¨&#39;</span><span class="p">,</span> <span class="c"># Spacing diaeresis - umlaut</span>
        <span class="mi">169</span><span class="p">:</span> <span class="s">u&#39;©&#39;</span><span class="p">,</span> <span class="c"># Copyright sign</span>
        <span class="mi">170</span><span class="p">:</span> <span class="s">u&#39;ª&#39;</span><span class="p">,</span> <span class="c"># Feminine ordinal indicator</span>
        <span class="mi">171</span><span class="p">:</span> <span class="s">u&#39;«&#39;</span><span class="p">,</span> <span class="c"># Left double angle quotes</span>
        <span class="mi">172</span><span class="p">:</span> <span class="s">u&#39;¬&#39;</span><span class="p">,</span> <span class="c"># Not sign</span>
        <span class="mi">173</span><span class="p">:</span> <span class="s">u&quot;</span><span class="se">\u00AD</span><span class="s">&quot;</span><span class="p">,</span> <span class="c"># Soft hyphen</span>
        <span class="mi">174</span><span class="p">:</span> <span class="s">u&#39;®&#39;</span><span class="p">,</span> <span class="c"># Registered trade mark sign</span>
        <span class="mi">175</span><span class="p">:</span> <span class="s">u&#39;¯&#39;</span><span class="p">,</span> <span class="c"># Spacing macron - overline</span>
        <span class="mi">176</span><span class="p">:</span> <span class="s">u&#39;°&#39;</span><span class="p">,</span> <span class="c"># Degree sign</span>
        <span class="mi">177</span><span class="p">:</span> <span class="s">u&#39;±&#39;</span><span class="p">,</span> <span class="c"># Plus-or-minus sign</span>
        <span class="mi">178</span><span class="p">:</span> <span class="s">u&#39;²&#39;</span><span class="p">,</span> <span class="c"># Superscript two - squared</span>
        <span class="mi">179</span><span class="p">:</span> <span class="s">u&#39;³&#39;</span><span class="p">,</span> <span class="c"># Superscript three - cubed</span>
        <span class="mi">180</span><span class="p">:</span> <span class="s">u&#39;´&#39;</span><span class="p">,</span> <span class="c"># Acute accent - spacing acute</span>
        <span class="mi">181</span><span class="p">:</span> <span class="s">u&#39;µ&#39;</span><span class="p">,</span> <span class="c"># Micro sign</span>
        <span class="mi">182</span><span class="p">:</span> <span class="s">u&#39;¶&#39;</span><span class="p">,</span> <span class="c"># Pilcrow sign - paragraph sign</span>
        <span class="mi">183</span><span class="p">:</span> <span class="s">u&#39;·&#39;</span><span class="p">,</span> <span class="c"># Middle dot - Georgian comma</span>
        <span class="mi">184</span><span class="p">:</span> <span class="s">u&#39;¸&#39;</span><span class="p">,</span> <span class="c"># Spacing cedilla</span>
        <span class="mi">185</span><span class="p">:</span> <span class="s">u&#39;¹&#39;</span><span class="p">,</span> <span class="c"># Superscript one</span>
        <span class="mi">186</span><span class="p">:</span> <span class="s">u&#39;º&#39;</span><span class="p">,</span> <span class="c"># Masculine ordinal indicator</span>
        <span class="mi">187</span><span class="p">:</span> <span class="s">u&#39;»&#39;</span><span class="p">,</span> <span class="c"># Right double angle quotes</span>
        <span class="mi">188</span><span class="p">:</span> <span class="s">u&#39;¼&#39;</span><span class="p">,</span> <span class="c"># Fraction one quarter</span>
        <span class="mi">189</span><span class="p">:</span> <span class="s">u&#39;½&#39;</span><span class="p">,</span> <span class="c"># Fraction one half</span>
        <span class="mi">190</span><span class="p">:</span> <span class="s">u&#39;¾&#39;</span><span class="p">,</span> <span class="c"># Fraction three quarters</span>
        <span class="mi">191</span><span class="p">:</span> <span class="s">u&#39;¿&#39;</span><span class="p">,</span> <span class="c"># Inverted question mark</span>
        <span class="mi">192</span><span class="p">:</span> <span class="s">u&#39;À&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter A with grave</span>
        <span class="mi">193</span><span class="p">:</span> <span class="s">u&#39;Á&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter A with acute</span>
        <span class="mi">194</span><span class="p">:</span> <span class="s">u&#39;Â&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter A with circumflex</span>
        <span class="mi">195</span><span class="p">:</span> <span class="s">u&#39;Ã&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter A with tilde</span>
        <span class="mi">196</span><span class="p">:</span> <span class="s">u&#39;Ä&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter A with diaeresis</span>
        <span class="mi">197</span><span class="p">:</span> <span class="s">u&#39;Å&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter A with ring above</span>
        <span class="mi">198</span><span class="p">:</span> <span class="s">u&#39;Æ&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter AE</span>
        <span class="mi">199</span><span class="p">:</span> <span class="s">u&#39;Ç&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter C with cedilla</span>
        <span class="mi">200</span><span class="p">:</span> <span class="s">u&#39;È&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter E with grave</span>
        <span class="mi">201</span><span class="p">:</span> <span class="s">u&#39;É&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter E with acute</span>
        <span class="mi">202</span><span class="p">:</span> <span class="s">u&#39;Ê&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter E with circumflex</span>
        <span class="mi">203</span><span class="p">:</span> <span class="s">u&#39;Ë&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter E with diaeresis</span>
        <span class="mi">204</span><span class="p">:</span> <span class="s">u&#39;Ì&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter I with grave</span>
        <span class="mi">205</span><span class="p">:</span> <span class="s">u&#39;Í&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter I with acute</span>
        <span class="mi">206</span><span class="p">:</span> <span class="s">u&#39;Î&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter I with circumflex</span>
        <span class="mi">207</span><span class="p">:</span> <span class="s">u&#39;Ï&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter I with diaeresis</span>
        <span class="mi">208</span><span class="p">:</span> <span class="s">u&#39;Ð&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter ETH</span>
        <span class="mi">209</span><span class="p">:</span> <span class="s">u&#39;Ñ&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter N with tilde</span>
        <span class="mi">210</span><span class="p">:</span> <span class="s">u&#39;Ò&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter O with grave</span>
        <span class="mi">211</span><span class="p">:</span> <span class="s">u&#39;Ó&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter O with acute</span>
        <span class="mi">212</span><span class="p">:</span> <span class="s">u&#39;Ô&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter O with circumflex</span>
        <span class="mi">213</span><span class="p">:</span> <span class="s">u&#39;Õ&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter O with tilde</span>
        <span class="mi">214</span><span class="p">:</span> <span class="s">u&#39;Ö&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter O with diaeresis</span>
        <span class="mi">215</span><span class="p">:</span> <span class="s">u&#39;×&#39;</span><span class="p">,</span> <span class="c"># Multiplication sign</span>
        <span class="mi">216</span><span class="p">:</span> <span class="s">u&#39;Ø&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter O with slash (aka &quot;empty set&quot;)</span>
        <span class="mi">217</span><span class="p">:</span> <span class="s">u&#39;Ù&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter U with grave</span>
        <span class="mi">218</span><span class="p">:</span> <span class="s">u&#39;Ú&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter U with acute</span>
        <span class="mi">219</span><span class="p">:</span> <span class="s">u&#39;Û&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter U with circumflex</span>
        <span class="mi">220</span><span class="p">:</span> <span class="s">u&#39;Ü&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter U with diaeresis</span>
        <span class="mi">221</span><span class="p">:</span> <span class="s">u&#39;Ý&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter Y with acute</span>
        <span class="mi">222</span><span class="p">:</span> <span class="s">u&#39;Þ&#39;</span><span class="p">,</span> <span class="c"># Latin capital letter THORN</span>
        <span class="mi">223</span><span class="p">:</span> <span class="s">u&#39;ß&#39;</span><span class="p">,</span> <span class="c"># Latin small letter sharp s - ess-zed</span>
        <span class="mi">224</span><span class="p">:</span> <span class="s">u&#39;à&#39;</span><span class="p">,</span> <span class="c"># Latin small letter a with grave</span>
        <span class="mi">225</span><span class="p">:</span> <span class="s">u&#39;á&#39;</span><span class="p">,</span> <span class="c"># Latin small letter a with acute</span>
        <span class="mi">226</span><span class="p">:</span> <span class="s">u&#39;â&#39;</span><span class="p">,</span> <span class="c"># Latin small letter a with circumflex</span>
        <span class="mi">227</span><span class="p">:</span> <span class="s">u&#39;ã&#39;</span><span class="p">,</span> <span class="c"># Latin small letter a with tilde</span>
        <span class="mi">228</span><span class="p">:</span> <span class="s">u&#39;ä&#39;</span><span class="p">,</span> <span class="c"># Latin small letter a with diaeresis</span>
        <span class="mi">229</span><span class="p">:</span> <span class="s">u&#39;å&#39;</span><span class="p">,</span> <span class="c"># Latin small letter a with ring above</span>
        <span class="mi">230</span><span class="p">:</span> <span class="s">u&#39;æ&#39;</span><span class="p">,</span> <span class="c"># Latin small letter ae</span>
        <span class="mi">231</span><span class="p">:</span> <span class="s">u&#39;ç&#39;</span><span class="p">,</span> <span class="c"># Latin small letter c with cedilla</span>
        <span class="mi">232</span><span class="p">:</span> <span class="s">u&#39;è&#39;</span><span class="p">,</span> <span class="c"># Latin small letter e with grave</span>
        <span class="mi">233</span><span class="p">:</span> <span class="s">u&#39;é&#39;</span><span class="p">,</span> <span class="c"># Latin small letter e with acute</span>
        <span class="mi">234</span><span class="p">:</span> <span class="s">u&#39;ê&#39;</span><span class="p">,</span> <span class="c"># Latin small letter e with circumflex</span>
        <span class="mi">235</span><span class="p">:</span> <span class="s">u&#39;ë&#39;</span><span class="p">,</span> <span class="c"># Latin small letter e with diaeresis</span>
        <span class="mi">236</span><span class="p">:</span> <span class="s">u&#39;ì&#39;</span><span class="p">,</span> <span class="c"># Latin small letter i with grave</span>
        <span class="mi">237</span><span class="p">:</span> <span class="s">u&#39;í&#39;</span><span class="p">,</span> <span class="c"># Latin small letter i with acute</span>
        <span class="mi">238</span><span class="p">:</span> <span class="s">u&#39;î&#39;</span><span class="p">,</span> <span class="c"># Latin small letter i with circumflex</span>
        <span class="mi">239</span><span class="p">:</span> <span class="s">u&#39;ï&#39;</span><span class="p">,</span> <span class="c"># Latin small letter i with diaeresis</span>
        <span class="mi">240</span><span class="p">:</span> <span class="s">u&#39;ð&#39;</span><span class="p">,</span> <span class="c"># Latin small letter eth</span>
        <span class="mi">241</span><span class="p">:</span> <span class="s">u&#39;ñ&#39;</span><span class="p">,</span> <span class="c"># Latin small letter n with tilde</span>
        <span class="mi">242</span><span class="p">:</span> <span class="s">u&#39;ò&#39;</span><span class="p">,</span> <span class="c"># Latin small letter o with grave</span>
        <span class="mi">243</span><span class="p">:</span> <span class="s">u&#39;ó&#39;</span><span class="p">,</span> <span class="c"># Latin small letter o with acute</span>
        <span class="mi">244</span><span class="p">:</span> <span class="s">u&#39;ô&#39;</span><span class="p">,</span> <span class="c"># Latin small letter o with circumflex</span>
        <span class="mi">245</span><span class="p">:</span> <span class="s">u&#39;õ&#39;</span><span class="p">,</span> <span class="c"># Latin small letter o with tilde</span>
        <span class="mi">246</span><span class="p">:</span> <span class="s">u&#39;ö&#39;</span><span class="p">,</span> <span class="c"># Latin small letter o with diaeresis</span>
        <span class="mi">247</span><span class="p">:</span> <span class="s">u&#39;÷&#39;</span><span class="p">,</span> <span class="c"># Division sign</span>
        <span class="mi">248</span><span class="p">:</span> <span class="s">u&#39;ø&#39;</span><span class="p">,</span> <span class="c"># Latin small letter o with slash</span>
        <span class="mi">249</span><span class="p">:</span> <span class="s">u&#39;ù&#39;</span><span class="p">,</span> <span class="c"># Latin small letter u with grave</span>
        <span class="mi">250</span><span class="p">:</span> <span class="s">u&#39;ú&#39;</span><span class="p">,</span> <span class="c"># Latin small letter u with acute</span>
        <span class="mi">251</span><span class="p">:</span> <span class="s">u&#39;û&#39;</span><span class="p">,</span> <span class="c"># Latin small letter u with circumflex</span>
        <span class="mi">252</span><span class="p">:</span> <span class="s">u&#39;ü&#39;</span><span class="p">,</span> <span class="c"># Latin small letter u with diaeresis</span>
        <span class="mi">253</span><span class="p">:</span> <span class="s">u&#39;ý&#39;</span><span class="p">,</span> <span class="c"># Latin small letter y with acute</span>
        <span class="mi">254</span><span class="p">:</span> <span class="s">u&#39;þ&#39;</span><span class="p">,</span> <span class="c"># Latin small letter thorn</span>
        <span class="mi">255</span><span class="p">:</span> <span class="s">u&#39;ÿ&#39;</span><span class="p">,</span> <span class="c"># Latin small letter y with diaeresis</span>
    <span class="p">}</span>
    <span class="c"># I left this in its odd state so I could differentiate between the two</span>
    <span class="c"># in the future.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="ne">UnicodeEncodeError</span><span class="p">,</span> <span class="ne">UnicodeTranslateError</span><span class="p">)):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">specials</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">object</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">e</span><span class="o">.</span><span class="n">end</span><span class="p">]]</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">e</span><span class="o">.</span><span class="n">end</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39;</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">specials</span><span class="p">[</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">object</span><span class="p">[</span><span class="n">e</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">e</span><span class="o">.</span><span class="n">end</span><span class="p">]]</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">e</span><span class="o">.</span><span class="n">end</span></div>
<span class="n">codecs</span><span class="o">.</span><span class="n">register_error</span><span class="p">(</span><span class="s">&#39;handle_special&#39;</span><span class="p">,</span> <span class="n">handle_special</span><span class="p">)</span>

<span class="c"># TODO List:</span>
<span class="c">#</span>
<span class="c">#   * We need unit tests!</span>

<span class="c"># Helper functions</span>
<div class="viewcode-block" id="_reduce_renditions"><a class="viewcode-back" href="../Developer/terminal.html#terminal._reduce_renditions">[docs]</a><span class="k">def</span> <span class="nf">_reduce_renditions</span><span class="p">(</span><span class="n">renditions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a list, *renditions*, and reduces it to its logical equivalent (as</span>
<span class="sd">    far as renditions go).  Example::</span>

<span class="sd">        [0, 32, 0, 34, 0, 32]</span>

<span class="sd">    Would become::</span>

<span class="sd">        [0, 32]</span>

<span class="sd">    Other Examples::</span>

<span class="sd">        [0, 1, 36, 36]      -&gt;  [0, 1, 36]</span>
<span class="sd">        [0, 30, 42, 30, 42] -&gt;  [0, 30, 42]</span>
<span class="sd">        [36, 32, 44, 42]    -&gt;  [32, 42]</span>
<span class="sd">        [36, 35]            -&gt;  [35]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_renditions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">foreground</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">background</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rend</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">renditions</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rend</span> <span class="o">&lt;</span> <span class="mi">29</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rend</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out_renditions</span><span class="p">:</span>
                <span class="n">out_renditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rend</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rend</span> <span class="o">&gt;</span> <span class="mi">29</span> <span class="ow">and</span> <span class="n">rend</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">:</span>
            <span class="c"># Regular 8-color foregrounds</span>
            <span class="n">foreground</span> <span class="o">=</span> <span class="n">rend</span>
        <span class="k">elif</span> <span class="n">rend</span> <span class="o">&gt;</span> <span class="mi">39</span> <span class="ow">and</span> <span class="n">rend</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
            <span class="c"># Regular 8-color backgrounds</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">rend</span>
        <span class="k">elif</span> <span class="n">rend</span> <span class="o">&gt;</span> <span class="mi">91</span> <span class="ow">and</span> <span class="n">rend</span> <span class="o">&lt;</span> <span class="mi">98</span><span class="p">:</span>
            <span class="c"># &#39;Bright&#39; (16-color) foregrounds</span>
            <span class="n">foreground</span> <span class="o">=</span> <span class="n">rend</span>
        <span class="k">elif</span> <span class="n">rend</span> <span class="o">&gt;</span> <span class="mi">99</span> <span class="ow">and</span> <span class="n">rend</span> <span class="o">&lt;</span> <span class="mi">108</span><span class="p">:</span>
            <span class="c"># &#39;Bright&#39; (16-color) backgrounds</span>
            <span class="n">background</span> <span class="o">=</span> <span class="n">rend</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_renditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rend</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">foreground</span><span class="p">:</span>
        <span class="n">out_renditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">foreground</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">background</span><span class="p">:</span>
        <span class="n">out_renditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">background</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_renditions</span>
</div>
<div class="viewcode-block" id="Terminal"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal">[docs]</a><span class="k">class</span> <span class="nc">Terminal</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Terminal controller class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ASCII_NUL</span> <span class="o">=</span> <span class="mi">0</span>     <span class="c"># Null</span>
    <span class="n">ASCII_BEL</span> <span class="o">=</span> <span class="mi">7</span>     <span class="c"># Bell (BEL)</span>
    <span class="n">ASCII_BS</span> <span class="o">=</span> <span class="mi">8</span>      <span class="c"># Backspace</span>
    <span class="n">ASCII_HT</span> <span class="o">=</span> <span class="mi">9</span>      <span class="c"># Horizontal Tab</span>
    <span class="n">ASCII_LF</span> <span class="o">=</span> <span class="mi">10</span>     <span class="c"># Line Feed</span>
    <span class="n">ASCII_VT</span> <span class="o">=</span> <span class="mi">11</span>     <span class="c"># Vertical Tab</span>
    <span class="n">ASCII_FF</span> <span class="o">=</span> <span class="mi">12</span>     <span class="c"># Form Feed</span>
    <span class="n">ASCII_CR</span> <span class="o">=</span> <span class="mi">13</span>     <span class="c"># Carriage Return</span>
    <span class="n">ASCII_SO</span> <span class="o">=</span> <span class="mi">14</span>     <span class="c"># Ctrl-N; Shift out (switches to the G0 charset)</span>
    <span class="n">ASCII_SI</span> <span class="o">=</span> <span class="mi">15</span>     <span class="c"># Ctrl-O; Shift in (switches to the G1 charset)</span>
    <span class="n">ASCII_XON</span> <span class="o">=</span> <span class="mi">17</span>    <span class="c"># Resume Transmission</span>
    <span class="n">ASCII_XOFF</span> <span class="o">=</span> <span class="mi">19</span>   <span class="c"># Stop Transmission or Ignore Characters</span>
    <span class="n">ASCII_CAN</span> <span class="o">=</span> <span class="mi">24</span>    <span class="c"># Cancel Escape Sequence</span>
    <span class="n">ASCII_SUB</span> <span class="o">=</span> <span class="mi">26</span>    <span class="c"># Substitute: Cancel Escape Sequence and replace with ?</span>
    <span class="n">ASCII_ESC</span> <span class="o">=</span> <span class="mi">27</span>    <span class="c"># Escape</span>
    <span class="n">ASCII_CSI</span> <span class="o">=</span> <span class="mi">155</span>   <span class="c"># Control Sequence Introducer (that nothing uses)</span>
    <span class="n">ASCII_HTS</span> <span class="o">=</span> <span class="mi">210</span>   <span class="c"># Horizontal Tab Stop (HTS)</span>

    <span class="n">charsets</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;B&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="c"># Default: USA</span>
        <span class="s">&#39;0&#39;</span><span class="p">:</span> <span class="p">{</span> <span class="c"># Line drawing mode</span>
            <span class="mi">95</span><span class="p">:</span> <span class="s">u&#39; &#39;</span><span class="p">,</span>
            <span class="mi">96</span><span class="p">:</span> <span class="s">u&#39;◆&#39;</span><span class="p">,</span>
            <span class="mi">97</span><span class="p">:</span> <span class="s">u&#39;▒&#39;</span><span class="p">,</span>
            <span class="mi">98</span><span class="p">:</span> <span class="s">u&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="mi">99</span><span class="p">:</span> <span class="s">u&#39;</span><span class="se">\x0c</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="mi">100</span><span class="p">:</span> <span class="s">u&#39;</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="mi">101</span><span class="p">:</span> <span class="s">u&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="mi">102</span><span class="p">:</span> <span class="s">u&#39;°&#39;</span><span class="p">,</span>
            <span class="mi">103</span><span class="p">:</span> <span class="s">u&#39;±&#39;</span><span class="p">,</span>
            <span class="mi">104</span><span class="p">:</span> <span class="s">u&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="mi">105</span><span class="p">:</span> <span class="s">u&#39;</span><span class="se">\x0b</span><span class="s">&#39;</span><span class="p">,</span>
            <span class="mi">106</span><span class="p">:</span> <span class="s">u&#39;┘&#39;</span><span class="p">,</span>
            <span class="mi">107</span><span class="p">:</span> <span class="s">u&#39;┐&#39;</span><span class="p">,</span>
            <span class="mi">108</span><span class="p">:</span> <span class="s">u&#39;┌&#39;</span><span class="p">,</span>
            <span class="mi">109</span><span class="p">:</span> <span class="s">u&#39;└&#39;</span><span class="p">,</span>
            <span class="mi">110</span><span class="p">:</span> <span class="s">u&#39;┼&#39;</span><span class="p">,</span>
            <span class="mi">111</span><span class="p">:</span> <span class="s">u&#39;⎺&#39;</span><span class="p">,</span> <span class="c"># All these bars and not a drink!</span>
            <span class="mi">112</span><span class="p">:</span> <span class="s">u&#39;⎻&#39;</span><span class="p">,</span>
            <span class="mi">113</span><span class="p">:</span> <span class="s">u&#39;─&#39;</span><span class="p">,</span>
            <span class="mi">114</span><span class="p">:</span> <span class="s">u&#39;⎼&#39;</span><span class="p">,</span>
            <span class="mi">115</span><span class="p">:</span> <span class="s">u&#39;⎽&#39;</span><span class="p">,</span>
            <span class="mi">116</span><span class="p">:</span> <span class="s">u&#39;├&#39;</span><span class="p">,</span>
            <span class="mi">117</span><span class="p">:</span> <span class="s">u&#39;┤&#39;</span><span class="p">,</span>
            <span class="mi">118</span><span class="p">:</span> <span class="s">u&#39;┴&#39;</span><span class="p">,</span>
            <span class="mi">119</span><span class="p">:</span> <span class="s">u&#39;┬&#39;</span><span class="p">,</span>
            <span class="mi">120</span><span class="p">:</span> <span class="s">u&#39;│&#39;</span><span class="p">,</span>
            <span class="mi">121</span><span class="p">:</span> <span class="s">u&#39;≤&#39;</span><span class="p">,</span>
            <span class="mi">122</span><span class="p">:</span> <span class="s">u&#39;≥&#39;</span><span class="p">,</span>
            <span class="mi">123</span><span class="p">:</span> <span class="s">u&#39;π&#39;</span><span class="p">,</span>
            <span class="mi">124</span><span class="p">:</span> <span class="s">u&#39;≠&#39;</span><span class="p">,</span>
            <span class="mi">125</span><span class="p">:</span> <span class="s">u&#39;£&#39;</span><span class="p">,</span>
            <span class="mi">126</span><span class="p">:</span> <span class="s">u&#39;·&#39;</span> <span class="c"># Centered dot--who comes up with this stuff?!?</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">RE_CSI_ESC_SEQ</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\x1B\[([?A-Za-z0-9;@:\!]*)([A-Za-z@_])&#39;</span><span class="p">)</span>
    <span class="n">RE_ESC_SEQ</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\x1b(.*\x1b</span><span class="se">\\</span><span class="s">|[ABCDEFGHIJKLMNOQRSTUVWXYZa-z0-9=&lt;&gt;]|[()# %*+].)&#39;</span><span class="p">)</span>
    <span class="n">RE_TITLE_SEQ</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\x1b\][0-2]\;(.*?)(\x07|\x1b</span><span class="se">\\</span><span class="s">)&#39;</span><span class="p">)</span>
    <span class="c"># The below regex is used to match our optional (non-standard) handler</span>
    <span class="n">RE_OPT_SEQ</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;\x1b\]_\;(.+?)(\x07|\x1b</span><span class="se">\\</span><span class="s">)&#39;</span><span class="p">)</span>
    <span class="n">RE_NUMBERS</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;\d*&#39;</span><span class="p">)</span> <span class="c"># Matches any number</span>

<div class="viewcode-block" id="Terminal.__init__"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the terminal by calling self.initialize(rows, cols).  This</span>
<span class="sd">        is so we can have an equivalent function in situations where __init__()</span>
<span class="sd">        gets overridden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Terminal.initialize"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">80</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_renditions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Gate One&quot;</span>
        <span class="c"># This variable can be referenced by programs implementing Terminal() to</span>
        <span class="c"># determine if anything has changed since the last dump*()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_echo</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># For holding escape sequences as they&#39;re typed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_cursor</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_rendition</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_screen</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_renditions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G0_charset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charsets</span><span class="p">[</span><span class="s">&#39;B&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G1_charset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charsets</span><span class="p">[</span><span class="s">&#39;B&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_charset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G0_charset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_G0_charset</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_G1_charset</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_g0_charset</span><span class="p">()</span>
        <span class="c"># Set the default window margins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">specials</span> <span class="o">=</span> <span class="p">{</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_NUL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_BEL</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bell</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_BS</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backspace</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_HT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_horizontal_tab</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_LF</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linefeed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_VT</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linefeed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_FF</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_linefeed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_CR</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_carriage_return</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_SO</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_g1_charset</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_SI</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_g0_charset</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_XON</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xon</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_CAN</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_esc_sequence</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_XOFF</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xoff</span><span class="p">,</span>
            <span class="c">#self.ASCII_ESC: self._sub_esc_sequence,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_ESC</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_escape</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ASCII_CSI</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csi</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esc_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c"># TODO: Make a different set of these for each respective emulation mode (VT-52, VT-100, VT-200, etc etc)</span>
            <span class="s">&#39;#&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_line_params</span><span class="p">,</span> <span class="c"># Varies</span>
            <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_string_terminator</span><span class="p">,</span> <span class="c"># ST</span>
            <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_screen</span><span class="p">,</span> <span class="c"># Reset terminal</span>
            <span class="s">&#39;D&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Move/scroll window up one line    IND</span>
            <span class="s">&#39;M&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_linefeed</span><span class="p">,</span> <span class="c"># Move/scroll window down one line RI</span>
            <span class="s">&#39;E&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_line</span><span class="p">,</span> <span class="c"># Move to next line NEL</span>
            <span class="s">&#39;F&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Enter Graphics Mode</span>
            <span class="s">&#39;G&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_next_line</span><span class="p">,</span> <span class="c"># Exit Graphics Mode</span>
            <span class="s">&#39;6&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dsr_get_cursor_position</span><span class="p">,</span> <span class="c"># Get cursor position   DSR</span>
            <span class="s">&#39;7&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_cursor_position</span><span class="p">,</span> <span class="c"># Save cursor position and attributes   DECSC</span>
            <span class="s">&#39;8&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_cursor_position</span><span class="p">,</span> <span class="c"># Restore cursor position and attributes   DECSC</span>
            <span class="s">&#39;H&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_tabstop</span><span class="p">,</span> <span class="c"># Set a tab at the current column   HTS</span>
            <span class="s">&#39;I&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_linefeed</span><span class="p">,</span>
            <span class="s">&#39;(&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_G0_charset</span><span class="p">,</span> <span class="c"># Designate G0 Character Set</span>
            <span class="s">&#39;)&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_G1_charset</span><span class="p">,</span> <span class="c"># Designate G1 Character Set</span>
            <span class="s">&#39;N&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Set single shift 2    SS2</span>
            <span class="s">&#39;O&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Set single shift 3    SS3</span>
            <span class="s">&#39;5&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_device_status_report</span><span class="p">,</span> <span class="c"># Request: Device status report DSR</span>
            <span class="s">&#39;0&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Response: terminal is OK  DSR</span>
            <span class="s">&#39;P&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dcs_handler</span><span class="p">,</span> <span class="c"># Device Control String  DCS</span>
            <span class="c"># NOTE: = and &gt; are ignored because the user can override/control</span>
            <span class="c"># them via the numlock key on their keyboard.  To do otherwise would</span>
            <span class="c"># just confuse people.</span>
            <span class="s">&#39;=&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Application Keypad  DECPAM</span>
            <span class="s">&#39;&gt;&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Exit alternate keypad mode</span>
            <span class="s">&#39;&lt;&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Exit VT-52 mode</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csi_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;A&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_up</span><span class="p">,</span>
            <span class="s">&#39;B&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_down</span><span class="p">,</span>
            <span class="s">&#39;C&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_right</span><span class="p">,</span>
            <span class="s">&#39;D&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_left</span><span class="p">,</span>
            <span class="s">&#39;E&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_next_line</span><span class="p">,</span>
            <span class="s">&#39;F&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_previous_line</span><span class="p">,</span>
            <span class="s">&#39;G&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_horizontal_absolute</span><span class="p">,</span>
            <span class="s">&#39;H&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_position</span><span class="p">,</span>
            <span class="s">&#39;L&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_line</span><span class="p">,</span>
            <span class="s">&#39;M&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_line</span><span class="p">,</span>
            <span class="c">#&#39;b&#39;: self.repeat_last_char, # TODO</span>
            <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csi_device_status_report</span><span class="p">,</span> <span class="c"># Device status report (DSR)</span>
            <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># TODO: Tab clear</span>
            <span class="s">&#39;h&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_expanded_mode</span><span class="p">,</span>
            <span class="s">&#39;l&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_expanded_mode</span><span class="p">,</span>
            <span class="s">&#39;f&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_position</span><span class="p">,</span>
            <span class="s">&#39;d&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_position_vertical</span><span class="p">,</span> <span class="c"># Vertical Line Position Absolute (VPA)</span>
            <span class="c">#&#39;e&#39;: self.cursor_position_vertical_relative, # VPR TODO</span>
            <span class="s">&#39;J&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_screen_from_cursor</span><span class="p">,</span>
            <span class="s">&#39;K&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_line_from_cursor</span><span class="p">,</span>
            <span class="s">&#39;S&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scroll_up</span><span class="p">,</span>
            <span class="s">&#39;T&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scroll_down</span><span class="p">,</span>
            <span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_cursor_position</span><span class="p">,</span>
            <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">restore_cursor_position</span><span class="p">,</span>
            <span class="s">&#39;m&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_rendition</span><span class="p">,</span>
            <span class="s">&#39;n&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># &lt;ESC&gt;[6n is the only one I know of (request cursor position)</span>
            <span class="c">#&#39;m&#39;: self.__ignore, # For testing how much CPU we save when not processing CSI</span>
            <span class="s">&#39;p&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_reset</span><span class="p">,</span> <span class="c"># TODO: &quot;!p&quot; is &quot;Soft terminal reset&quot;.  Also, &quot;Set conformance level&quot; (VT100, VT200, or VT300)</span>
            <span class="s">&#39;r&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_top_bottom</span><span class="p">,</span> <span class="c"># DECSTBM (used by many apps)</span>
            <span class="s">&#39;q&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_led_state</span><span class="p">,</span> <span class="c"># Seems a bit silly but you never know</span>
            <span class="s">&#39;P&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete_characters</span><span class="p">,</span> <span class="c"># DCH Deletes the specified number of chars</span>
            <span class="s">&#39;X&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_erase_characters</span><span class="p">,</span> <span class="c"># ECH Same as DCH but also deletes renditions</span>
            <span class="s">&#39;Z&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_characters</span><span class="p">,</span> <span class="c"># Inserts the specified number of chars</span>
            <span class="s">&#39;@&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">insert_characters</span><span class="p">,</span> <span class="c"># Inserts the specified number of chars</span>
            <span class="c">#&#39;`&#39;: self._char_position_row, # Position cursor (row only)</span>
            <span class="c">#&#39;t&#39;: self.window_manipulation, # TODO</span>
            <span class="c">#&#39;z&#39;: self.locator, # TODO: DECELR &quot;Enable locator reporting&quot;</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expanded_modes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c"># Expanded modes take a True/False argument for set/reset</span>
            <span class="s">&#39;1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">application_mode</span><span class="p">,</span>
            <span class="s">&#39;2&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># DECANM and set VT100 mode</span>
            <span class="s">&#39;3&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># 132 Column Mode (DECCOLM)</span>
            <span class="s">&#39;4&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Smooth (Slow) Scroll (DECSCLM)</span>
            <span class="s">&#39;5&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Reverse video (might support in future)</span>
            <span class="s">&#39;6&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Origin Mode (DECOM)</span>
            <span class="s">&#39;7&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Wraparound Mode (DECAWM)</span>
            <span class="s">&#39;8&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Auto-repeat Keys (DECARM)</span>
            <span class="s">&#39;9&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Send Mouse X &amp; Y on button press (maybe)</span>
            <span class="s">&#39;12&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_receive_mode</span><span class="p">,</span> <span class="c"># SRM</span>
            <span class="s">&#39;18&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Print form feed (DECPFF)</span>
            <span class="s">&#39;19&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Set print extent to full screen (DECPEX)</span>
            <span class="s">&#39;25&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_hide_cursor</span><span class="p">,</span>
            <span class="s">&#39;38&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Enter Tektronix Mode (DECTEK)</span>
            <span class="s">&#39;41&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># more(1) fix (whatever that is)</span>
            <span class="s">&#39;42&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Enable Nation Replacement Character sets (DECNRCM)</span>
            <span class="s">&#39;44&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Turn On Margin Bell</span>
            <span class="s">&#39;45&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Reverse-wraparound Mode</span>
            <span class="s">&#39;46&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Start Logging (Hmmm)</span>
            <span class="s">&#39;47&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alternate_screen_buffer</span><span class="p">,</span> <span class="c"># Use Alternate Screen Buffer</span>
            <span class="s">&#39;66&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Application keypad (DECNKM)</span>
            <span class="s">&#39;67&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Backarrow key sends delete (DECBKM)</span>
            <span class="s">&#39;1000&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Send Mouse X/Y on button press and release</span>
            <span class="s">&#39;1001&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Use Hilite Mouse Tracking</span>
            <span class="s">&#39;1002&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Use Cell Motion Mouse Tracking</span>
            <span class="s">&#39;1003&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Use All Motion Mouse Tracking</span>
            <span class="s">&#39;1010&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Scroll to bottom on tty output</span>
            <span class="s">&#39;1011&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Scroll to bottom on key press</span>
            <span class="s">&#39;1035&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Enable special modifiers for Alt and NumLock keys</span>
            <span class="s">&#39;1036&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Send ESC when Meta modifies a key</span>
            <span class="s">&#39;1037&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Send DEL from the editing-keypad Delete key</span>
            <span class="s">&#39;1047&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Use Alternate Screen Buffer</span>
            <span class="s">&#39;1048&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Save cursor as in DECSC</span>
            <span class="s">&#39;1049&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">alternate_screen_buffer_cursor</span><span class="p">,</span> <span class="c"># Save cursor as in DECSC and use Alternate Screen Buffer, clearing it first</span>
            <span class="s">&#39;1051&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Set Sun function-key mode</span>
            <span class="s">&#39;1052&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Set HP function-key mode</span>
            <span class="s">&#39;1060&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Set legacy keyboard emulation (X11R6)</span>
            <span class="s">&#39;1061&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__ignore</span><span class="p">,</span> <span class="c"># Set Sun/PC keyboard emulation of VT220 keyboard</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">CALLBACK_SCROLL_UP</span><span class="p">:</span> <span class="p">{},</span>
            <span class="n">CALLBACK_CHANGED</span><span class="p">:</span> <span class="p">{},</span>
            <span class="n">CALLBACK_CURSOR_POS</span><span class="p">:</span> <span class="p">{},</span>
            <span class="n">CALLBACK_DSR</span><span class="p">:</span> <span class="p">{},</span>
            <span class="n">CALLBACK_TITLE</span><span class="p">:</span> <span class="p">{},</span>
            <span class="n">CALLBACK_BELL</span><span class="p">:</span> <span class="p">{},</span>
            <span class="n">CALLBACK_OPT</span><span class="p">:</span> <span class="p">{},</span>
            <span class="n">CALLBACK_MODE</span><span class="p">:</span> <span class="p">{},</span>
            <span class="n">CALLBACK_RESET</span><span class="p">:</span> <span class="p">{},</span>
            <span class="n">CALLBACK_LEDS</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leds</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>
        <span class="n">png_header</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;.*</span><span class="se">\x89</span><span class="s">PNG</span><span class="se">\r</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">png_whole</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x89</span><span class="s">PNG</span><span class="se">\r</span><span class="s">.+IEND</span><span class="se">\xae</span><span class="s">B`</span><span class="se">\x82</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="c"># NOTE: Only matching JFIF and Exif JPEGs because &quot;\xff\xd8&quot; is too</span>
        <span class="c"># ambiguous.</span>
        <span class="n">jpeg_header</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&#39;.*</span><span class="se">\xff\xd8\xff</span><span class="s">.+JFIF</span><span class="se">\x00</span><span class="s">|.*</span><span class="se">\xff\xd8\xff</span><span class="s">.+Exif</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="n">jpeg_whole</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="s">&#39;</span><span class="se">\xff\xd8\xff</span><span class="s">.+JFIF</span><span class="se">\x00</span><span class="s">.+</span><span class="se">\xff\xd9</span><span class="s">(?!</span><span class="se">\xff</span><span class="s">)|</span><span class="se">\xff\xd8\xff</span><span class="s">.+Exif</span><span class="se">\x00</span><span class="s">.+</span><span class="se">\xff\xd9</span><span class="s">(?!</span><span class="se">\xff</span><span class="s">)&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magic</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c"># Dict for magic &quot;numbers&quot; so we can tell when a particular type of</span>
            <span class="c"># file begins and ends (so we can capture it in binary form and</span>
            <span class="c"># later dump it out via dump_html())</span>
            <span class="c"># The format is &#39;beginning&#39;: &#39;whole&#39;</span>
            <span class="n">png_header</span><span class="p">:</span> <span class="n">png_whole</span><span class="p">,</span>
            <span class="n">jpeg_header</span><span class="p">:</span> <span class="n">jpeg_whole</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">matched_header</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># These are for saving self.screen and self.renditions so we can support</span>
        <span class="c"># an &quot;alternate buffer&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_screen</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_renditions</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_rendition</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application_keys</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Terminal.init_screen"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.init_screen">[docs]</a>    <span class="k">def</span> <span class="nf">init_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fills self.screen with empty lines of (unicode) spaces using self.cols</span>
<span class="sd">        and self.rows for the dimensions.</span>

<span class="sd">        NOTE: Just because each line starts out with a uniform length does not</span>
<span class="sd">        mean it will stay that way.  Processing of escape sequences is handled</span>
<span class="sd">        when an output function is called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="c"># Tabstops</span>
        <span class="n">tabs</span><span class="p">,</span> <span class="n">remainder</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="c"># Default is every 8 chars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabstops</span> <span class="o">=</span> <span class="p">[(</span><span class="n">a</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">tabs</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tabstops</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># Fix the first tabstop (which will be -1)</span>
        <span class="c"># Base cursor position</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="Terminal.init_renditions"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.init_renditions">[docs]</a>    <span class="k">def</span> <span class="nf">init_renditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fills self.renditions with lists of None using self.cols and self.rows</span>
<span class="sd">        for the dimenions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span>
        <span class="p">]</span>
</div>
<div class="viewcode-block" id="Terminal.init_scrollback"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.init_scrollback">[docs]</a>    <span class="k">def</span> <span class="nf">init_scrollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Empties out the scrollback buffers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_renditions</span> <span class="o">=</span> <span class="p">[]</span>
</div>
<div class="viewcode-block" id="Terminal.add_callback"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.add_callback">[docs]</a>    <span class="k">def</span> <span class="nf">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">identifier</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Attaches the given *callback* to the given *event*.  If given,</span>
<span class="sd">        *identifier* can be used to reference this callback leter (e.g. when you</span>
<span class="sd">        want to remove it).  Otherwise an identifier will be generated</span>
<span class="sd">        automatically.  If the given *identifier* is already attached to a</span>
<span class="sd">        callback at the given event, that callback will be replaced with</span>
<span class="sd">        *callback*.</span>

<span class="sd">        *event* - The numeric ID of the event you&#39;re attaching *callback* to.</span>
<span class="sd">        *callback* - The function you&#39;re attaching to the *event*.</span>
<span class="sd">        *identifier* - A string or number to be used as a reference point should you wish to remove or update this callback later.</span>

<span class="sd">        Returns the identifier of the callback.  to Example:</span>

<span class="sd">            &gt;&gt;&gt; term = Terminal()</span>
<span class="sd">            &gt;&gt;&gt; def somefunc(): pass</span>
<span class="sd">            &gt;&gt;&gt; id = &quot;myref&quot;</span>
<span class="sd">            &gt;&gt;&gt; ref = term.add_callback(CALLBACK_BELL, somefunc, id)</span>

<span class="sd">        NOTE: This allows the controlling program to have multiple callbacks for</span>
<span class="sd">        the same event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">identifier</span><span class="p">:</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">__hash__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">event</span><span class="p">][</span><span class="n">identifier</span><span class="p">]</span> <span class="o">=</span> <span class="n">callback</span>
        <span class="k">return</span> <span class="n">identifier</span>
</div>
<div class="viewcode-block" id="Terminal.remove_callback"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.remove_callback">[docs]</a>    <span class="k">def</span> <span class="nf">remove_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes the callback referenced by *identifier* that is attached to the</span>
<span class="sd">        given *event*.  Example:</span>

<span class="sd">            &gt;&gt;&gt; term.remove_callback(CALLBACK_BELL, &quot;myref&quot;)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">event</span><span class="p">][</span><span class="n">identifier</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Terminal.remove_all_callbacks"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.remove_all_callbacks">[docs]</a>    <span class="k">def</span> <span class="nf">remove_all_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes all callbacks associated with *identifier*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">event</span><span class="p">,</span> <span class="n">identifiers</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">event</span><span class="p">][</span><span class="n">identifier</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span> <span class="c"># No match, no biggie</span>
</div>
<div class="viewcode-block" id="Terminal.terminal_reset"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.terminal_reset">[docs]</a>    <span class="k">def</span> <span class="nf">terminal_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resets the terminal back to an empty screen with all defaults.  Calls</span>
<span class="sd">        self.callbacks[CALLBACK_RESET]() when finished.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;terminal_reset(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">leds</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">1</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="mi">3</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="mi">4</span><span class="p">:</span> <span class="bp">False</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_echo</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Gate One&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_cursor</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G0_charset</span> <span class="o">=</span> <span class="s">&#39;B&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_charset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charsets</span><span class="p">[</span><span class="s">&#39;B&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_screen</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_renditions</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorY</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_rendition</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application_keys</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_screen</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_renditions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_scrollback</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_RESET</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
    <span class="k">def</span> <span class="nf">__ignore</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do nothing&quot;&quot;&quot;</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="Terminal.resize"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.resize">[docs]</a>    <span class="k">def</span> <span class="nf">resize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resizes the terminal window, adding or removing rows or columns as</span>
<span class="sd">        needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;resize(</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">rows</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span> <span class="c"># Remove rows from the top</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="n">rows</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">rows</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span> <span class="c"># Add rows at the bottom</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">rows</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">cols</span><span class="p">)]</span>
                <span class="n">renditions</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">renditions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c"># Fix the cursor location:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">cols</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">:</span> <span class="c"># Remove cols to the right</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="n">cols</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="n">cols</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">cols</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">:</span> <span class="c"># Add cols to the right</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">cols</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">u&#39; &#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="n">cols</span>

        <span class="c"># Fix the cursor location:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rendition_set</span> <span class="o">=</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="Terminal._set_top_bottom"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._set_top_bottom">[docs]</a>    <span class="k">def</span> <span class="nf">_set_top_bottom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">settings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DECSTBM - Sets self.top_margin and self.bottom_margin using the provided</span>
<span class="sd">        settings in the form of &#39;&lt;top_margin&gt;;&lt;bottom_margin&gt;&#39;.</span>

<span class="sd">        NOTE: This also handles restore/set &quot;DEC Private Mode Values&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># NOTE: Used by screen and vi so this needs to work and work well!</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">settings</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">):</span>
                <span class="c"># This is a set/restore DEC PMV sequence</span>
                <span class="k">return</span> <span class="c"># Ignore (until I figure out what this should do)</span>
            <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">top</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="c"># These are 0-based like self.cursor[XY]</span>
            <span class="k">if</span> <span class="n">bottom</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">bottom</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Reset to defaults (full screen margins)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="Terminal.get_cursor_position"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.get_cursor_position">[docs]</a>    <span class="k">def</span> <span class="nf">get_cursor_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the current cursor positition as a tuple, (row, col)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Terminal.set_title"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.set_title">[docs]</a>    <span class="k">def</span> <span class="nf">set_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets self.title to *title* and executes</span>
<span class="sd">        self.callbacks[CALLBACK_TITLE]()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_TITLE</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Got TypeError on CALLBACK_TITLE...&quot;</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_TITLE</span><span class="p">]))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Terminal.get_title"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.get_title">[docs]</a>    <span class="k">def</span> <span class="nf">get_title</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns self.title&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">title</span>

<span class="c"># TODO: put some logic in these save/restore functions to walk the current</span>
<span class="c"># rendition line to come up with a logical rendition for that exact spot.</span></div>
<div class="viewcode-block" id="Terminal.save_cursor_position"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.save_cursor_position">[docs]</a>    <span class="k">def</span> <span class="nf">save_cursor_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the cursor position and current rendition settings to</span>
<span class="sd">        self.saved_cursorX, self.saved_cursorY, and self.saved_rendition</span>

<span class="sd">        NOTE: Also handles the set/restore &quot;Private Mode Settings&quot; sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span><span class="p">:</span> <span class="c"># Set DEC private mode</span>
            <span class="c"># TODO: Need some logic here to save the current expanded mode</span>
            <span class="c">#       so we can restore it in _set_top_bottom().</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_expanded_mode</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
        <span class="c"># NOTE: args and kwargs are here to make sure we don&#39;t get an exception</span>
        <span class="c">#       when we&#39;re called via escape sequences.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved_rendition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Terminal.restore_cursor_position"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.restore_cursor_position">[docs]</a>    <span class="k">def</span> <span class="nf">restore_cursor_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restores the cursor position and rendition settings from</span>
<span class="sd">        self.saved_cursorX, self.saved_cursorY, and self.saved_rendition (if</span>
<span class="sd">        they&#39;re set).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorX</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorY</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorX</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_cursorY</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved_rendition</span>
</div>
<div class="viewcode-block" id="Terminal._dsr_get_cursor_position"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._dsr_get_cursor_position">[docs]</a>    <span class="k">def</span> <span class="nf">_dsr_get_cursor_position</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the current cursor positition as a DSR response in the form of:</span>
<span class="sd">        &#39;\x1b&lt;self.cursorY&gt;;&lt;self.cursorX&gt;R&#39;.  Also executes CALLBACK_DSR with</span>
<span class="sd">        the same output as the first argument.  Example:</span>

<span class="sd">            self.callbacks[CALLBACK_DSR](&#39;\x1b20;123R&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">esc_cursor_pos</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\x1b</span><span class="si">%s</span><span class="s">;</span><span class="si">%s</span><span class="s">R&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_DSR</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">esc_cursor_pos</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">esc_cursor_pos</span>
</div>
<div class="viewcode-block" id="Terminal._dcs_handler"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._dcs_handler">[docs]</a>    <span class="k">def</span> <span class="nf">_dcs_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles Device Control String sequences.  Still haven&#39;t figured out if</span>
<span class="sd">        these really need to be implemented (they might not make sense for</span>
<span class="sd">        Gate One).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
        <span class="c">#print(&quot;TODO: Handle this DCS: %s&quot; % string)</span>
</div>
<div class="viewcode-block" id="Terminal._set_line_params"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._set_line_params">[docs]</a>    <span class="k">def</span> <span class="nf">_set_line_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function handles the control sequences that set double and single</span>
<span class="sd">        line heights and widths.  It also handles the &quot;screen alignment test&quot; (</span>
<span class="sd">        fill the screen with Es).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">param</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t handle escape sequence #</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">param</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
            <span class="c"># Screen alignment test</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_renditions</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="s">u&#39;E&#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="c"># TODO: Get this handling double line height stuff</span>
</div>
<div class="viewcode-block" id="Terminal.set_G0_charset"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.set_G0_charset">[docs]</a>    <span class="k">def</span> <span class="nf">set_G0_charset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the terminal&#39;s G0 (default) charset to the type specified by *char*</span>

<span class="sd">        Here&#39;s the possibilities:</span>
<span class="sd">            0    DEC Special Character and Line Drawing Set</span>
<span class="sd">            A    United Kingdom (UK)</span>
<span class="sd">            B    United States (USASCII)</span>
<span class="sd">            4    Dutch</span>
<span class="sd">            C    Finnish</span>
<span class="sd">            5    Finnish</span>
<span class="sd">            R    French</span>
<span class="sd">            Q    French Canadian</span>
<span class="sd">            K    German</span>
<span class="sd">            Y    Italian</span>
<span class="sd">            E    Norwegian/Danish</span>
<span class="sd">            6    Norwegian/Danish</span>
<span class="sd">            Z    Spanish</span>
<span class="sd">            H    Swedish</span>
<span class="sd">            7    Swedish</span>
<span class="sd">            =    Swiss</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#logging.debug(&quot;Setting G0 charset to %s&quot; % repr(char))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G0_charset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charsets</span><span class="p">[</span><span class="n">char</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G0_charset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charsets</span><span class="p">[</span><span class="s">&#39;B&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_charset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G0_charset</span>
</div>
<div class="viewcode-block" id="Terminal.set_G1_charset"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.set_G1_charset">[docs]</a>    <span class="k">def</span> <span class="nf">set_G1_charset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the terminal&#39;s G1 (alt) charset to the type specified by *char*</span>

<span class="sd">        Here&#39;s the possibilities:</span>
<span class="sd">            0    DEC Special Character and Line Drawing Set</span>
<span class="sd">            A    United Kingdom (UK)</span>
<span class="sd">            B    United States (USASCII)</span>
<span class="sd">            4    Dutch</span>
<span class="sd">            C    Finnish</span>
<span class="sd">            5    Finnish</span>
<span class="sd">            R    French</span>
<span class="sd">            Q    French Canadian</span>
<span class="sd">            K    German</span>
<span class="sd">            Y    Italian</span>
<span class="sd">            E    Norwegian/Danish</span>
<span class="sd">            6    Norwegian/Danish</span>
<span class="sd">            Z    Spanish</span>
<span class="sd">            H    Swedish</span>
<span class="sd">            7    Swedish</span>
<span class="sd">            =    Swiss</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#logging.debug(&quot;Setting G1 charset to %s&quot; % repr(char))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G1_charset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charsets</span><span class="p">[</span><span class="n">char</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G1_charset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charsets</span><span class="p">[</span><span class="s">&#39;B&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_charset</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">charset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G1_charset</span>
</div>
<div class="viewcode-block" id="Terminal.use_g0_charset"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.use_g0_charset">[docs]</a>    <span class="k">def</span> <span class="nf">use_g0_charset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the current charset to G0.  This should get called when ASCII_SO</span>
<span class="sd">        is encountered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#logging.debug(</span>
            <span class="c">#&quot;Switching to G0 charset (which is %s)&quot; % repr(self.G0_charset))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_charset</span> <span class="o">=</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="Terminal.use_g1_charset"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.use_g1_charset">[docs]</a>    <span class="k">def</span> <span class="nf">use_g1_charset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the current charset to G1.  This should get called when ASCII_SI</span>
<span class="sd">        is encountered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#logging.debug(</span>
            <span class="c">#&quot;Switching to G1 charset (which is %s)&quot; % repr(self.G1_charset))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_charset</span> <span class="o">=</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="Terminal.write"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="p">,</span> <span class="n">special_checks</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write *chars* to the terminal at the current cursor position advancing</span>
<span class="sd">        the cursor as it does so.  If *chars* is not unicode, it will be</span>
<span class="sd">        converted to unicode before being stored in self.screen.</span>

<span class="sd">        if *special_checks* is True (default), Gate One will perform checks for</span>
<span class="sd">        special things like image files coming in via *chars*.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># NOTE: This is the slowest function in all of Gate One.  All</span>
        <span class="c"># suggestions on how to speed it up are welcome!</span>

        <span class="c"># Speedups (don&#39;t want dots in loops if they can be avoided)</span>
        <span class="n">specials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specials</span>
        <span class="n">esc_handlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">esc_handlers</span>
        <span class="n">csi_handlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">csi_handlers</span>
        <span class="n">RE_ESC_SEQ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RE_ESC_SEQ</span>
        <span class="n">RE_CSI_ESC_SEQ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RE_CSI_ESC_SEQ</span>
        <span class="n">cursor_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursor_right</span>
        <span class="n">magic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">magic</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="c">#logging.debug(&#39;handling chars: %s&#39; % `chars`)</span>
        <span class="k">if</span> <span class="n">special_checks</span><span class="p">:</span>
            <span class="c"># NOTE: Special checks are limited to PNGs and JPEGs right now</span>
            <span class="n">before_chars</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="n">after_chars</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">magic_header</span> <span class="ow">in</span> <span class="n">magic</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">magic_header</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">chars</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">matched_header</span> <span class="o">=</span> <span class="n">magic_header</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">matched_header</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">magic</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">matched_header</span><span class="p">]</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Matched image format.  Capturing...&quot;</span><span class="p">)</span>
                    <span class="n">before_chars</span><span class="p">,</span> <span class="n">after_chars</span> <span class="o">=</span> <span class="n">magic</span><span class="p">[</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">matched_header</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
                    <span class="c"># Eliminate anything before the match</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_capture_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">image</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span> <span class="c"># Empty it out</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">matched_header</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Ditto</span>
                <span class="k">if</span> <span class="n">before_chars</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">before_chars</span><span class="p">,</span> <span class="n">special_checks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">after_chars</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">after_chars</span><span class="p">,</span> <span class="n">special_checks</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="c"># Have to convert to unicode</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">chars</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">chars</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s">&quot;handle_special&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
            <span class="c"># Just in case</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">chars</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">chars</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s">&quot;ignore&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">UnicodeEncodeError</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s">&quot;Double UnicodeEncodeError in Terminal.terminal.&quot;</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">:</span>
            <span class="n">charnum</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">charnum</span> <span class="ow">in</span> <span class="n">specials</span><span class="p">:</span>
                <span class="n">specials</span><span class="p">[</span><span class="n">charnum</span><span class="p">]()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Now handle the regular characters and escape sequences</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span><span class="p">:</span> <span class="c"># We&#39;ve got an escape sequence going on...</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">+=</span> <span class="n">char</span>
                        <span class="c"># First try to handle non-CSI ESC sequences (the basics)</span>
                        <span class="n">match_obj</span> <span class="o">=</span> <span class="n">RE_ESC_SEQ</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">match_obj</span><span class="p">:</span>
                            <span class="n">seq_type</span> <span class="o">=</span> <span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c"># &#39;\x1bA&#39; -&gt; &#39;A&#39;</span>
                            <span class="c"># Call the matching ESC handler</span>
                            <span class="c">#logging.debug(&#39;ESC seq: %s&#39; % seq_type)</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq_type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># Single-character sequnces</span>
                                <span class="n">esc_handlers</span><span class="p">[</span><span class="n">seq_type</span><span class="p">]()</span>
                            <span class="k">else</span><span class="p">:</span> <span class="c"># Multi-character stuff like &#39;\x1b)B&#39;</span>
                                <span class="n">esc_handlers</span><span class="p">[</span><span class="n">seq_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]](</span><span class="n">seq_type</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="c"># All done with this one</span>
                            <span class="k">continue</span>
                        <span class="c"># Next try to handle CSI ESC sequences</span>
                        <span class="n">match_obj</span> <span class="o">=</span> <span class="n">RE_CSI_ESC_SEQ</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">match_obj</span><span class="p">:</span>
                            <span class="n">csi_values</span> <span class="o">=</span> <span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c"># e.g. &#39;0;1;37&#39;</span>
                            <span class="n">csi_type</span> <span class="o">=</span> <span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c"># e.g. &#39;m&#39;</span>
                            <span class="c">#logging.debug(</span>
                                <span class="c">#&#39;CSI: %s, %s&#39; % (csi_type, csi_values))</span>
                            <span class="c"># Call the matching CSI handler</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">csi_handlers</span><span class="p">[</span><span class="n">csi_type</span><span class="p">](</span><span class="n">csi_values</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="c"># Commented this out because it can be super noisy</span>
                                <span class="c">#logging.error(_(</span>
                                    <span class="c">#&quot;CSI Handler Error: Type: %s, Values: %s&quot; %</span>
                                    <span class="c">#(csi_type, csi_values)</span>
                                <span class="c">#))</span>
                                <span class="k">pass</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                            <span class="k">continue</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="c"># No handler for this, try some alternatives</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x1b\\</span><span class="s">&#39;</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_osc_handler</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c"># Commented this out because it can be super noisy</span>
                            <span class="c">#logging.warning(_(</span>
                                <span class="c">#&quot;Warning: No ESC sequence handler for %s&quot;</span>
                                <span class="c">#% `self.esc_buffer`</span>
                            <span class="c">#))</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="k">continue</span> <span class="c"># We&#39;re done here</span>
<span class="c"># TODO: Figure out a way to write characters past the edge of the screen so that users can copy &amp; paste without having newlines in the middle of everything.</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">:</span>
                    <span class="c"># Start a newline but NOTE: Not really the best way to</span>
                    <span class="c"># handle this because it means copying and pasting lines</span>
                    <span class="c"># will end up broken into pieces of size=self.cols</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_newline</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c"># This actually works but until I figure out a way to</span>
                    <span class="c"># get the browser to properly wrap the line without</span>
                    <span class="c"># freaking out whenever someone clicks on the page it</span>
                    <span class="c"># will have to stay commented.  NOTE: This might be a</span>
                    <span class="c"># browser bug.</span>
                    <span class="c">#self.screen[self.cursorY].append(unicode(char))</span>
                    <span class="c">#self.renditions[self.cursorY].append([])</span>
                    <span class="c"># To try it just uncomment the above two lines and</span>
                    <span class="c"># comment out the self._newline() and self.cusorX lines</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_rendition</span>
                    <span class="k">if</span> <span class="n">charnum</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">:</span>
                        <span class="n">char</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">[</span><span class="n">charnum</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">=</span> <span class="n">char</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># Use plain ASCII if the char wasn&#39;t found (means it</span>
                        <span class="c"># isn&#39;t a special line drawing character).</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">=</span> <span class="n">char</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="c"># This can happen when escape sequences go haywire</span>
                    <span class="k">pass</span>
                <span class="n">cursor_right</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c"># Execute our callbacks</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CHANGED</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">callback</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">callback</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.flush"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.flush">[docs]</a>    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Only here to make Terminal compatible with programs that want to use</span>
<span class="sd">        file-like methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.scroll_up"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.scroll_up">[docs]</a>    <span class="k">def</span> <span class="nf">scroll_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scrolls up the terminal screen by *n* lines (default: 1). The callbacks</span>
<span class="sd">        CALLBACK_CHANGED and CALLBACK_SCROLL_UP are called after scrolling the</span>
<span class="sd">        screen.</span>

<span class="sd">        NOTE: This will only scroll up the region within self.top_margin and</span>
<span class="sd">        self.bottom_margin (if set).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span><span class="p">)</span> <span class="c"># Remove the top line</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="c"># Add it to the scrollback buffer</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="c"># 1000 lines ought to be enough for anybody</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_scrollback</span><span class="p">()</span>
                <span class="c"># NOTE:  This would only be if 1000 lines piled up before the</span>
                <span class="c"># next dump_html() or dump().</span>
            <span class="n">empty_line</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="c"># Line full of spaces</span>
            <span class="c"># Add it to the bottom of the window:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">,</span> <span class="n">empty_line</span><span class="p">)</span>
            <span class="c"># Remove top line&#39;s style information</span>
            <span class="n">style</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_renditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">style</span><span class="p">)</span>
            <span class="c"># Insert a new empty rendition as well:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)])</span>
        <span class="c"># Execute our callback indicating lines have been updated</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CHANGED</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="c"># Execute our callback to scroll up the screen</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_SCROLL_UP</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.scroll_down"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.scroll_down">[docs]</a>    <span class="k">def</span> <span class="nf">scroll_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scrolls down the terminal screen by *n* lines (default: 1). The</span>
<span class="sd">        callbacks CALLBACK_CHANGED and CALLBACK_SCROLL_DOWN are called after</span>
<span class="sd">        scrolling the screen.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">)</span> <span class="c"># Remove the bottom line</span>
            <span class="n">empty_line</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="c"># Line full of spaces</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span><span class="p">,</span> <span class="n">empty_line</span><span class="p">)</span> <span class="c"># Add it to the top</span>
            <span class="c"># Remove bottom line&#39;s style information:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">)</span>
            <span class="c"># Insert a new empty one:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)])</span>
        <span class="c"># Execute our callback indicating lines have been updated</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CHANGED</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c"># Execute our callback to scroll up the screen</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_SCROLL_UP</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.insert_line"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.insert_line">[docs]</a>    <span class="k">def</span> <span class="nf">insert_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inserts *n* lines at the current cursor position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#logging.debug(&quot;insert_line(%s)&quot; % n)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span> <span class="c"># Takes care of an empty string</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">)</span> <span class="c"># Remove the bottom line</span>
            <span class="c"># Remove bottom line&#39;s style information as well:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">)</span>
            <span class="n">empty_line</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="c"># Line full of spaces</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">,</span> <span class="n">empty_line</span><span class="p">)</span> <span class="c"># Insert at cursor</span>
            <span class="c"># Insert a new empty rendition as well:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)])</span>
</div>
<div class="viewcode-block" id="Terminal.delete_line"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.delete_line">[docs]</a>    <span class="k">def</span> <span class="nf">delete_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes *n* lines at the current cursor position.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#logging.debug(&quot;delete_line(%s)&quot; % n)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span> <span class="c"># Takes care of an empty string</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">)</span> <span class="c"># Remove the line at the cursor</span>
            <span class="c"># Remove the line&#39;s style information as well:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">)</span>
            <span class="c"># Now add an empty line and empty set of renditions to the bottom of the</span>
            <span class="c"># view</span>
            <span class="n">empty_line</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="c"># Line full of spaces</span>
            <span class="c"># Add it to the bottom of the view:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">,</span> <span class="n">empty_line</span><span class="p">)</span> <span class="c"># Insert at bottom</span>
            <span class="c"># Insert a new empty rendition as well:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)])</span>
</div>
<div class="viewcode-block" id="Terminal._backspace"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._backspace">[docs]</a>    <span class="k">def</span> <span class="nf">_backspace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute a backspace (\x08)&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">pass</span> <span class="c"># At the edge, no biggie</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursor_left</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Terminal._horizontal_tab"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._horizontal_tab">[docs]</a>    <span class="k">def</span> <span class="nf">_horizontal_tab</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute horizontal tab (\x09)&quot;&quot;&quot;</span>
        <span class="n">next_tabstop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">tabstop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabstops</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tabstop</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:</span>
                <span class="n">next_tabstop</span> <span class="o">=</span> <span class="n">tabstop</span>
                <span class="k">break</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="n">next_tabstop</span>
</div>
<div class="viewcode-block" id="Terminal._set_tabstop"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._set_tabstop">[docs]</a>    <span class="k">def</span> <span class="nf">_set_tabstop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets a tabstop at the current position of self.cursorX.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabstops</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tabstop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tabstops</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">&gt;</span> <span class="n">tabstop</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tabstops</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tabstops</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="c"># Put them in order :)</span>
                    <span class="k">break</span>
</div>
<div class="viewcode-block" id="Terminal._linefeed"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._linefeed">[docs]</a>    <span class="k">def</span> <span class="nf">_linefeed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute line feed&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_newline</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Terminal._next_line"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._next_line">[docs]</a>    <span class="k">def</span> <span class="nf">_next_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Moves cursor down one line&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">+=</span> <span class="mi">1</span>
</div>
    <span class="k">def</span> <span class="nf">_reverse_linefeed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scroll_down</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_margin</span>

<div class="viewcode-block" id="Terminal._newline"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._newline">[docs]</a>    <span class="k">def</span> <span class="nf">_newline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new line to self.screen and sets self.cursorX to 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scroll_up</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bottom_margin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_line</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Terminal._carriage_return"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._carriage_return">[docs]</a>    <span class="k">def</span> <span class="nf">_carriage_return</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute carriage return (set self.cursorX to 0)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="Terminal._xon"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._xon">[docs]</a>    <span class="k">def</span> <span class="nf">_xon</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle XON character (stop ignoring)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;_xon()&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_echo</span> <span class="o">=</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="Terminal._xoff"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._xoff">[docs]</a>    <span class="k">def</span> <span class="nf">_xoff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle XOFF character (start ignoring)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&#39;_xoff()&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_echo</span> <span class="o">=</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="Terminal._cancel_esc_sequence"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._cancel_esc_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">_cancel_esc_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Cancels any escape sequence currently in progress.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</div>
<div class="viewcode-block" id="Terminal._sub_esc_sequence"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._sub_esc_sequence">[docs]</a>    <span class="k">def</span> <span class="nf">_sub_esc_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cancels any escape sequence currently in progress and substitutes it</span>
<span class="sd">        with single question mark (?).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;?&#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Terminal._escape"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._escape">[docs]</a>    <span class="k">def</span> <span class="nf">_escape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle escape character as well as escape sequences.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span>
        <span class="k">if</span> <span class="n">buf</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x1b</span><span class="s">P&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">buf</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x1b</span><span class="s">]&#39;</span><span class="p">):</span>
            <span class="c"># CSRs and OSCs are special</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\x1b</span><span class="s">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Get rid of whatever&#39;s there since we obviously didn&#39;t know what to</span>
            <span class="c"># do with it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\x1b</span><span class="s">&#39;</span>
</div>
<div class="viewcode-block" id="Terminal._csi"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._csi">[docs]</a>    <span class="k">def</span> <span class="nf">_csi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts a CSI sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\x1b</span><span class="s">[&#39;</span>
</div>
<div class="viewcode-block" id="Terminal._capture_image"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._capture_image">[docs]</a>    <span class="k">def</span> <span class="nf">_capture_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts looking at the intput to see if this is a PNG file.  If it is,</span>
<span class="sd">        sets self.image to &#39;Ë&#39; which will tell self.write() to put all characters</span>
<span class="sd">        into a bufer until the &#39;IEND\xaeB`\x82&#39; sequence is encountered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;_capture_image() len(self.image): </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_data</span><span class="p">))</span>
        <span class="c"># Remove the extra \r&#39;s that the terminal adds:</span>
        <span class="n">image_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span> <span class="o">-</span> <span class="mi">1</span> <span class="c"># Move to the end of the screen</span>
        <span class="c"># NOTE: If we don&#39;t move to the end of the screen the image can end up</span>
        <span class="c"># partially above the visible screen (since it will rest on the current</span>
        <span class="c"># row).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_newline</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_newline</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Terminal._string_terminator"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._string_terminator">[docs]</a>    <span class="k">def</span> <span class="nf">_string_terminator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle the string terminator.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: This.</span>
        <span class="c"># NOTE: Might this just call _cancel_esc_sequence?  I need to double-check.</span>
        <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal._osc_handler"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._osc_handler">[docs]</a>    <span class="k">def</span> <span class="nf">_osc_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handles Operating System Command (OSC) escape sequences which need</span>
<span class="sd">        special care since they are of indeterminiate length and end with either</span>
<span class="sd">        a bell (\x07) or a sequence terminator (\x9c aka ST).  This will usually</span>
<span class="sd">        called from self._bell() to set the title of the terminal (just like an</span>
<span class="sd">        xterm) but it is also possible to be called directly whenever an ST is</span>
<span class="sd">        encountered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Try the title sequence first</span>
        <span class="n">match_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RE_TITLE_SEQ</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match_obj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="c"># Sets self.title</span>
            <span class="k">return</span>
        <span class="c"># Next try our special optional handler sequence</span>
        <span class="n">match_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RE_OPT_SEQ</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match_obj</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">match_obj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__opt_handler</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c"># At this point we&#39;ve encountered something unusual</span>
        <span class="c">#logging.warning(_(&quot;Warning: No ESC sequence handler for %s&quot; %</span>
            <span class="c">#`self.esc_buffer`))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
</div>
<div class="viewcode-block" id="Terminal._bell"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._bell">[docs]</a>    <span class="k">def</span> <span class="nf">_bell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Handle bell character and execute self.callbacks[CALLBACK_BELL]() if we</span>
<span class="sd">        are not in the middle of an escape sequence.  If we *are* in the middle</span>
<span class="sd">        of an escape sequence, call self._osc_handler() since we can be nearly</span>
<span class="sd">        certain that we&#39;re simply terminating an OSC sequence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># NOTE: A little explanation is in order: The bell character (\x07) by</span>
        <span class="c">#       itself should play a bell (pretty straighforward).  However, if</span>
        <span class="c">#       the bell character is at the tail end of a particular escape</span>
        <span class="c">#       sequence (string starting with \x1b]0;) this indicates an xterm</span>
        <span class="c">#       title (everything between \x1b]0;...\x07).</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span><span class="p">:</span> <span class="c"># We&#39;re not in the middle of an esc sequence</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_BELL</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">callback</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># We&#39;re (likely) setting a title</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">esc_buffer</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\x07</span><span class="s">&#39;</span> <span class="c"># Add the bell char so we don&#39;t lose it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_osc_handler</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Terminal._device_status_report"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._device_status_report">[docs]</a>    <span class="k">def</span> <span class="nf">_device_status_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns &#39;\x1b[0n&#39; (terminal OK) and executes</span>
<span class="sd">        self.callbacks[CALLBACK_DSR](&quot;\x1b[0n&quot;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x1b</span><span class="s">[0n&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_DSR</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">response</span>
</div>
<div class="viewcode-block" id="Terminal._csi_device_status_report"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._csi_device_status_report">[docs]</a>    <span class="k">def</span> <span class="nf">_csi_device_status_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns &#39;\x1b[1;2c&#39; (Meaning: I&#39;m a vt220 terminal, version 1.0) and</span>
<span class="sd">        executes self.callbacks[self.CALLBACK_DSR](&quot;\x1b[1;2c&quot;).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x1b</span><span class="s">[1;2c&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_DSR</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">response</span>
</div>
<div class="viewcode-block" id="Terminal._set_expanded_mode"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._set_expanded_mode">[docs]</a>    <span class="k">def</span> <span class="nf">_set_expanded_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Accepts &quot;standard mode&quot; settings.  Typically &#39;\x1b[?25h&#39; to hide cursor.</span>

<span class="sd">        Notes on modes::</span>
<span class="sd">            &#39;?1h&#39; - Application Cursor Keys</span>
<span class="sd">            &#39;?5h&#39; - DECSCNM (default off): Set reverse-video mode.</span>
<span class="sd">            &#39;?12h&#39; - Local echo (SRM or Send Receive Mode)</span>
<span class="sd">            &#39;?25h&#39; - Hide cursor</span>
<span class="sd">            &#39;?1049h&#39; - Save cursor and screen</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: Add support for the following:</span>
        <span class="c"># * 3: 132 column mode (might be &quot;or greater&quot;)</span>
        <span class="c"># * 4: Smooth scroll (for animations and also makes things less choppy)</span>
        <span class="c"># * 5: Reverse video (should be easy: just need some extra CSS)</span>
        <span class="c"># * 6: Origin mode</span>
        <span class="c"># * 7: Wraparound mode</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="n">setting</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c"># Don&#39;t need the ?</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">setting</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expanded_modes</span><span class="p">[</span><span class="n">setting</span><span class="p">](</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">pass</span> <span class="c"># Unsupported expanded mode</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_MODE</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">setting</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal._reset_expanded_mode"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._reset_expanded_mode">[docs]</a>    <span class="k">def</span> <span class="nf">_reset_expanded_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setting</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Accepts &quot;standard mode&quot; settings.  Typically &#39;\x1b[?25l&#39; to show cursor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">setting</span> <span class="o">=</span> <span class="n">setting</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="c"># Don&#39;t need the ?</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">setting</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">setting</span> <span class="ow">in</span> <span class="n">settings</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">expanded_modes</span><span class="p">[</span><span class="n">setting</span><span class="p">](</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">pass</span> <span class="c"># Unsupported expanded mode</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_MODE</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">setting</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.application_mode"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.application_mode">[docs]</a>    <span class="k">def</span> <span class="nf">application_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boolean</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;self.application_keys = *boolean*&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">application_keys</span> <span class="o">=</span> <span class="n">boolean</span>
</div>
<div class="viewcode-block" id="Terminal.alternate_screen_buffer"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.alternate_screen_buffer">[docs]</a>    <span class="k">def</span> <span class="nf">alternate_screen_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If *alt* is True, copy the current screen and renditions to</span>
<span class="sd">        self.alt_screen and self.alt_renditions then re-init self.screen and</span>
<span class="sd">        self.renditions.</span>
<span class="sd">        If *alt* is False, restore the saved screen buffer and renditions then</span>
<span class="sd">        nullify self.alt_screen and self.alt_renditions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">alt</span><span class="p">:</span>
            <span class="c"># Save the existing screen and renditions</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alt_screen</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alt_renditions</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">)</span>
            <span class="c"># Make a fresh one</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_screen</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Restore the screen</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_screen</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_renditions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_screen</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_renditions</span>
            <span class="c"># Empty out the alternate buffer (to save memory)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alt_screen</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alt_renditions</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Terminal.alternate_screen_buffer_cursor"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.alternate_screen_buffer_cursor">[docs]</a>    <span class="k">def</span> <span class="nf">alternate_screen_buffer_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as self.alternate_screen_buffer but saves/restores the cursor</span>
<span class="sd">        location.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">alt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorX</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alt_cursorY</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alternate_screen_buffer</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Terminal.show_hide_cursor"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.show_hide_cursor">[docs]</a>    <span class="k">def</span> <span class="nf">show_hide_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boolean</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;self.show_cursor = boolean&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">show_cursor</span> <span class="o">=</span> <span class="n">boolean</span>
</div>
<div class="viewcode-block" id="Terminal.send_receive_mode"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.send_receive_mode">[docs]</a>    <span class="k">def</span> <span class="nf">send_receive_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onoff</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turns on or off local echo dependong on the value of *onoff*</span>

<span class="sd">        self.local_echo = *onoff*</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;send_receive_mode(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">onoff</span><span class="p">))</span>
        <span class="c"># This has been disabled because it might only be meant for the</span>
        <span class="c"># underlying program and not the terminal emulator.  Needs research.</span>
        <span class="c">#if onoff:</span>
            <span class="c">#self.local_echo = False</span>
        <span class="c">#else:</span>
            <span class="c">#self.local_echo = True</span>
</div>
<div class="viewcode-block" id="Terminal.insert_characters"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.insert_characters">[docs]</a>    <span class="k">def</span> <span class="nf">insert_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Inserts the specified number of characters at the cursor position&quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="c"># Take one down, pass it around</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">,</span> <span class="s">u&#39; &#39;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Terminal.delete_characters"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.delete_characters">[docs]</a>    <span class="k">def</span> <span class="nf">delete_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DCH - Deletes (to the left) the specified number of characters at the</span>
<span class="sd">        cursor position.  As characters are deleted, the remaining characters</span>
<span class="sd">        between the cursor and right margin move to the left. Character</span>
<span class="sd">        attributes (renditions) move with the characters.  The terminal adds</span>
<span class="sd">        blank spaces with no visual character attributes at the right margin.</span>
<span class="sd">        DCH has no effect outside the scrolling margins.</span>

<span class="sd">        NOTE: Deletes renditions too.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span> <span class="c"># e.g. n == &#39;&#39;</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">u&#39; &#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c"># At edge of screen, ignore</span>
                <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal._erase_characters"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._erase_characters">[docs]</a>    <span class="k">def</span> <span class="nf">_erase_characters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Erases (to the right) the specified number of characters at the cursor</span>
<span class="sd">        position.  NOTE: Deletes renditions too.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span> <span class="c"># e.g. n == &#39;&#39;</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">distance</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="s">u&#39; &#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="Terminal.cursor_left"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_left">[docs]</a>    <span class="k">def</span> <span class="nf">cursor_left</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ESCnD CUB (Cursor Back)&quot;&quot;&quot;</span>
        <span class="c"># Commented out to save CPU (and the others below too)</span>
        <span class="c">#logging.debug(&#39;cursor_left(%s)&#39; % n)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.cursor_right"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_right">[docs]</a>    <span class="k">def</span> <span class="nf">cursor_right</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ESCnC CUF (Cursor Forward)&quot;&quot;&quot;</span>
        <span class="c">#logging.debug(&#39;cursor_right(%s)&#39; % n)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">+=</span> <span class="n">n</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.cursor_up"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_up">[docs]</a>    <span class="k">def</span> <span class="nf">cursor_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ESCnA CUU (Cursor Up)&quot;&quot;&quot;</span>
        <span class="c">#logging.debug(&#39;cursor_up(%s)&#39; % n)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.cursor_down"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_down">[docs]</a>    <span class="k">def</span> <span class="nf">cursor_down</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ESCnB CUD (Cursor Down)&quot;&quot;&quot;</span>
        <span class="c">#logging.debug(&#39;cursor_down(%s)&#39; % n)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.cursor_next_line"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_next_line">[docs]</a>    <span class="k">def</span> <span class="nf">cursor_next_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ESCnE CNL (Cursor Next Line)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.cursor_previous_line"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_previous_line">[docs]</a>    <span class="k">def</span> <span class="nf">cursor_previous_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ESCnF CPL (Cursor Previous Line)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.cursor_horizontal_absolute"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_horizontal_absolute">[docs]</a>    <span class="k">def</span> <span class="nf">cursor_horizontal_absolute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ESCnG CHA (Cursor Horizontal Absolute)&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="c"># -1 because cols is 0-based</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.cursor_position"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_position">[docs]</a>    <span class="k">def</span> <span class="nf">cursor_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ESCnH CUP (Cursor Position).  Move the cursor to the given coordinates.</span>

<span class="sd">        *coordinates*: Should be something like, &#39;row;col&#39; (1-based) but,</span>
<span class="sd">        &#39;row&#39;, &#39;row;&#39;, and &#39;;col&#39; are also valid (assumes 1 on missing value).</span>

<span class="sd">        If coordinates is &#39;&#39;, the cursor will be moved to the top left (1;1).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># NOTE: Since this is 1-based we have to subtract 1 from everything to</span>
        <span class="c">#       match how we store these values internally.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">coordinates</span><span class="p">:</span>
            <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="s">&#39;;&#39;</span> <span class="ow">in</span> <span class="n">coordinates</span><span class="p">:</span>
            <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">coordinates</span>
            <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># These ensure a positive integer while reducing row and col by 1:</span>
        <span class="n">row</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">row</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">col</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="n">row</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="n">col</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.cursor_position_vertical"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.cursor_position_vertical">[docs]</a>    <span class="k">def</span> <span class="nf">cursor_position_vertical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Vertical Line Position Absolute (VPA) - Moves the cursor to given line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span>
</div>
<div class="viewcode-block" id="Terminal.clear_screen"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_screen">[docs]</a>    <span class="k">def</span> <span class="nf">clear_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the screen.  Also used to emulate a terminal reset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_screen</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_renditions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="Terminal.clear_screen_from_cursor_down"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_screen_from_cursor_down">[docs]</a>    <span class="k">def</span> <span class="nf">clear_screen_from_cursor_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the screen from the cursor down (ESC[J or ESC[0J).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
           <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">:]</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
           <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">:]</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="Terminal.clear_screen_from_cursor_up"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_screen_from_cursor_up">[docs]</a>    <span class="k">def</span> <span class="nf">clear_screen_from_cursor_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the screen from the cursor up (Esc[1J).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
           <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
           <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span> <span class="o">=</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="Terminal.clear_screen_from_cursor"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_screen_from_cursor">[docs]</a>    <span class="k">def</span> <span class="nf">clear_screen_from_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CSI*n*J ED (Erase Data).  This escape sequence uses the following rules:</span>

<span class="sd">            ======  =============================   ===</span>
<span class="sd">            Esc[J   Clear screen from cursor down   ED0</span>
<span class="sd">            Esc[0J  Clear screen from cursor down   ED0</span>
<span class="sd">            Esc[1J  Clear screen from cursor up     ED1</span>
<span class="sd">            Esc[2J  Clear entire screen             ED2</span>
<span class="sd">            ======  =============================   ===</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c"># Esc[J</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">clear_types</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_screen_from_cursor_down</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_screen_from_cursor_up</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_screen</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clear_types</span><span class="p">[</span><span class="n">n</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;Error: Unsupported number for escape sequence J&quot;</span><span class="p">))</span>
        <span class="c"># Execute our callbacks</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CHANGED</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.clear_line_from_cursor_right"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_line_from_cursor_right">[docs]</a>    <span class="k">def</span> <span class="nf">clear_line_from_cursor_right</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the screen from the cursor right (Esc[K or Esc[0K).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:]]</span>
        <span class="c"># Reset the cursor position&#39;s rendition to the end of the line</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_rendition</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:]]</span>
</div>
<div class="viewcode-block" id="Terminal.clear_line_from_cursor_left"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_line_from_cursor_left">[docs]</a>    <span class="k">def</span> <span class="nf">clear_line_from_cursor_left</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the screen from the cursor left (Esc[1K).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">saved</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:]</span>
        <span class="n">saved_renditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][:</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">saved</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">][:</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">+</span> <span class="n">saved_renditions</span>
</div>
<div class="viewcode-block" id="Terminal.clear_line"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_line">[docs]</a>    <span class="k">def</span> <span class="nf">clear_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the entire line (Esc[2K).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">u&#39; &#39;</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span> <span class="o">=</span> <span class="mi">0</span>
</div>
<div class="viewcode-block" id="Terminal.clear_line_from_cursor"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.clear_line_from_cursor">[docs]</a>    <span class="k">def</span> <span class="nf">clear_line_from_cursor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CSI*n*K EL (Erase in Line).  This escape sequence uses the following</span>
<span class="sd">        rules::</span>

<span class="sd">            Esc[K   Clear screen from cursor right  EL0</span>
<span class="sd">            Esc[0K  Clear screen from cursor right  EL0</span>
<span class="sd">            Esc[1K  Clear screen from cursor left   EL1</span>
<span class="sd">            Esc[2K  Clear entire line               ED2</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span> <span class="c"># Esc[J</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">clear_types</span> <span class="o">=</span> <span class="p">{</span>
            <span class="mi">0</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_line_from_cursor_right</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_line_from_cursor_left</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_line</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">clear_types</span><span class="p">[</span><span class="n">n</span><span class="p">]()</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;Error: Unsupported number for CSI escape sequence K&quot;</span><span class="p">))</span>
        <span class="c"># Execute our callbacks</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CHANGED</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_CURSOR_POS</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal.set_led_state"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.set_led_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_led_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the values the dict, self.leds depending on *n* using the following</span>
<span class="sd">        rules:</span>

<span class="sd">            Esc[0q  Turn off all four leds  DECLL0</span>
<span class="sd">            Esc[1q  Turn on LED #1          DECLL1</span>
<span class="sd">            Esc[2q  Turn on LED #2          DECLL2</span>
<span class="sd">            Esc[3q  Turn on LED #3          DECLL3</span>
<span class="sd">            Esc[4q  Turn on LED #4          DECLL4</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">states</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">states</span><span class="p">:</span>
            <span class="n">state</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">leds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">leds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">leds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">leds</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">leds</span><span class="p">[</span><span class="n">state</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_LEDS</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">pass</span>
</div>
<div class="viewcode-block" id="Terminal._set_rendition"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal._set_rendition">[docs]</a>    <span class="k">def</span> <span class="nf">_set_rendition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets self.renditions[self.cursorY][self.cursorX] equal to n.split(&#39;;&#39;).</span>
<span class="sd">        *n* is expected to be a string of ECMA-48 rendition numbers separated by</span>
<span class="sd">        semicolons.  Example::</span>

<span class="sd">            &#39;0;1;31&#39;</span>

<span class="sd">        ...will result in::</span>

<span class="sd">            [0, 1, 31]</span>

<span class="sd">        Note that the numbers were converted to integers and the order was</span>
<span class="sd">        preserved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># TODO: Make this whole thing faster (or prove it isn&#39;t possible).</span>
        <span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span>
        <span class="n">cursorX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span>
        <span class="c">#logging.debug(&quot;Setting rendition: %s at %s, %s&quot; % (n, cursorY, cursorX))</span>
        <span class="k">if</span> <span class="n">cursorX</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">:</span> <span class="c"># We&#39;re at the end of the row</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">cursorY</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">cursorX</span><span class="p">:</span>
                <span class="c"># Make it all longer</span>
                <span class="c">#logging.debug(&quot;Making line %s longer&quot; % self.cursorY)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">[</span><span class="n">cursorY</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span> <span class="c"># Make it longer</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">[</span><span class="n">cursorY</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\x00</span><span class="s">&#39;</span><span class="p">)</span> <span class="c"># This needs to match</span>
        <span class="k">if</span> <span class="n">cursorY</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
            <span class="c"># This should never happen</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span>
                <span class="s">&quot;cursorY &gt;= self.rows! This should not happen! Bug!&quot;</span><span class="p">))</span>
            <span class="k">return</span> <span class="c"># Don&#39;t bother setting renditions past the bottom</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span> <span class="c"># or \x1b[m (reset)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_rendition</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="c"># No need for further processing; save some CPU</span>
        <span class="c"># Convert the string (e.g. &#39;0;1;32&#39;) to a list (e.g. [0,1,32]</span>
        <span class="n">new_renditions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">]</span>
        <span class="n">found_256</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">foreground</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">background</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rend</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_renditions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">rend</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">38</span><span class="p">,</span><span class="mi">48</span><span class="p">]:</span>
                <span class="n">found_256</span> <span class="o">=</span> <span class="n">i</span>
                <span class="k">if</span> <span class="n">rend</span> <span class="o">==</span> <span class="mi">38</span><span class="p">:</span>
                    <span class="n">foreground</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">elif</span> <span class="n">rend</span> <span class="o">==</span> <span class="mi">48</span><span class="p">:</span>
                    <span class="n">background</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">found_256</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Pop out the 38/48 and the subsequent 5</span>
            <span class="n">new_renditions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">found_256</span><span class="p">)</span>
            <span class="n">new_renditions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">found_256</span><span class="p">)</span>
            <span class="c"># Now increase the actual color by 1000 so it doesn&#39;t conflict</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">foreground</span><span class="p">:</span>
                    <span class="n">new_renditions</span><span class="p">[</span><span class="n">found_256</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1000</span>
                <span class="k">elif</span> <span class="n">background</span><span class="p">:</span>
                    <span class="n">new_renditions</span><span class="p">[</span><span class="n">found_256</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">10000</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c"># NOTE: This exception check is temporary!  I got an IndexError</span>
                <span class="c"># here a few times when testing but I can&#39;t seem to reproduce it</span>
                <span class="c"># now that I&#39;m watching for it (figures!).  Hopefully I&#39;ll find</span>
                <span class="c"># whatever bug is causing this and then I can get rid of this</span>
                <span class="c"># silly check.</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s">&quot;WFT?  new_renditions: </span><span class="si">%s</span><span class="s">, found_256: </span><span class="si">%s</span><span class="s">&quot;</span>
                    <span class="o">%</span> <span class="p">(</span><span class="n">new_renditions</span><span class="p">,</span> <span class="n">found_256</span><span class="p">)))</span>
        <span class="n">out_renditions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rend</span> <span class="ow">in</span> <span class="n">new_renditions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rend</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">out_renditions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c"># A 0 indicates reset so we don&#39;t want the last rendition to be</span>
                <span class="c"># combined with this new one.  By setting the last rendition to</span>
                <span class="c"># just [0] we&#39;re ensuring that _reduce_renditions() returns just</span>
                <span class="c"># this rendition and not the previous one + this one.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_rendition</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">out_renditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rend</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out_renditions</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_rendition</span> <span class="o">=</span> <span class="n">out_renditions</span>
            <span class="k">return</span>
        <span class="n">new_renditions</span> <span class="o">=</span> <span class="n">out_renditions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_rendition</span> <span class="o">=</span> <span class="n">_reduce_renditions</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_rendition</span> <span class="o">+</span> <span class="n">new_renditions</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__opt_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chars</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Optional special escape sequence handler for sequences matching</span>
<span class="sd">        RE_OPT_SEQ.  If CALLBACK_OPT is defined it will be called like so::</span>

<span class="sd">            self.callbacks[CALLBACK_OPT](chars)</span>

<span class="sd">        Applications can use this escape sequence to define whatever special</span>
<span class="sd">        handlers they like.  It works like this: If an escape sequence is</span>
<span class="sd">        encountered matching RE_OPT_SEQ this method will be called with the</span>
<span class="sd">        inbetween *chars* (e.g. \x1b]_;&lt;chars&gt;\x07) as the argument.</span>

<span class="sd">        Applications can then do what they wish with *chars*.</span>

<span class="sd">        NOTE: I added this functionality so that plugin authors would have a</span>
<span class="sd">        mechanism to communicate with terminal applications.  See the SSH plugin</span>
<span class="sd">        for an example of how this can be done (there&#39;s channels of</span>
<span class="sd">        communication amongst ssh_connect.py, ssh.js, and ssh.py).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">CALLBACK_OPT</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">callback</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># High likelyhood that nothing is defined.  No biggie.</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__spanify_screen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Iterates over the lines in *screen* and *renditions*, applying HTML</span>
<span class="sd">        markup (span tags) where appropriate and returns the result as a list of</span>
<span class="sd">        lines. It also marks the cursor position via a &lt;span&gt; tag at the</span>
<span class="sd">        appropriate location.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">rendition_classes</span> <span class="o">=</span> <span class="n">RENDITION_CLASSES</span>
        <span class="n">screen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span>
        <span class="n">renditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span>
        <span class="n">cursorX</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span>
        <span class="n">cursorY</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span>
        <span class="n">spancount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_classes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev_rendition</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">foregrounds</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;f0&#39;</span><span class="p">,</span><span class="s">&#39;f1&#39;</span><span class="p">,</span><span class="s">&#39;f2&#39;</span><span class="p">,</span><span class="s">&#39;f3&#39;</span><span class="p">,</span><span class="s">&#39;f4&#39;</span><span class="p">,</span><span class="s">&#39;f5&#39;</span><span class="p">,</span><span class="s">&#39;f6&#39;</span><span class="p">,</span><span class="s">&#39;f7&#39;</span><span class="p">)</span>
        <span class="n">backgrounds</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;b0&#39;</span><span class="p">,</span><span class="s">&#39;b1&#39;</span><span class="p">,</span><span class="s">&#39;b2&#39;</span><span class="p">,</span><span class="s">&#39;b3&#39;</span><span class="p">,</span><span class="s">&#39;b4&#39;</span><span class="p">,</span><span class="s">&#39;b5&#39;</span><span class="p">,</span><span class="s">&#39;b6&#39;</span><span class="p">,</span><span class="s">&#39;b7&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">linecount</span><span class="p">,</span> <span class="n">line_rendition</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">izip</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">renditions</span><span class="p">)):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line_rendition</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rendition</span> <span class="o">=</span> <span class="n">line_rendition</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">outline</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="n">charcount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">char</span><span class="p">,</span> <span class="n">rend</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">rendition</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">char</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># Special stuff =)</span>
                    <span class="c"># Obviously, not really a single character</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">Image</span><span class="p">:</span> <span class="c"># Can&#39;t use images in the terminal</span>
                        <span class="n">outline</span> <span class="o">+=</span> <span class="s">&quot;&lt;i&gt;Image file&lt;/i&gt;&quot;</span>
                        <span class="k">continue</span> <span class="c"># Can&#39;t do anything else</span>
                    <span class="n">image_data</span> <span class="o">=</span> <span class="n">char</span>
                    <span class="c"># PIL likes file objects</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                        <span class="c"># i.e. PIL couldn&#39;t identify the file</span>
                        <span class="n">outline</span> <span class="o">+=</span> <span class="s">&quot;&lt;i&gt;Image file&lt;/i&gt;&quot;</span>
                        <span class="k">continue</span> <span class="c"># Can&#39;t do anything else</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50000</span><span class="p">:</span> <span class="c"># TODO: Make this adjustable</span>
                        <span class="c"># Probably too big to send to browser as a data URI.</span>
                        <span class="k">if</span> <span class="n">im</span><span class="p">:</span> <span class="c"># Resize it...</span>
                            <span class="c"># 640x480 should come in &lt;32k for most stuff</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">im</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">((</span><span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
                                <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
                                <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                                <span class="c"># Convert back to bytearray</span>
                                <span class="n">image_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                                <span class="c"># Sometimes PIL will throw this if it can&#39;t read</span>
                                <span class="c"># the image.</span>
                                <span class="n">outline</span> <span class="o">+=</span> <span class="s">&quot;&lt;i&gt;Problem displaying this image&lt;/i&gt;&quot;</span>
                                <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c"># Generic error</span>
                            <span class="n">outline</span> <span class="o">+=</span> <span class="s">&quot;&lt;i&gt;Problem displaying this image&lt;/i&gt;&quot;</span>
                            <span class="k">continue</span>
                    <span class="c"># Need to encode base64 to create a data URI</span>
                    <span class="c"># Python 2.6 doesn&#39;t like passing bytearrays to b64encode:</span>
                    <span class="n">image_data</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span> <span class="c"># This isn&#39;t necessary in 2.7</span>
                    <span class="n">encoded</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">data_uri</span> <span class="o">=</span> <span class="s">&quot;data:image/</span><span class="si">%s</span><span class="s">;base64,</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">im</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">encoded</span><span class="p">)</span>
                    <span class="n">outline</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&lt;img src=&quot;</span><span class="si">%s</span><span class="s">&quot; width=&quot;</span><span class="si">%s</span><span class="s">&quot; height=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">data_uri</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">continue</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="s">&quot;&amp;&lt;&gt;&quot;</span><span class="p">:</span>
                    <span class="c"># Have to convert ampersands and lt/gt to HTML entities</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;amp;&#39;</span><span class="p">)</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;lt;&#39;</span><span class="p">)</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;gt;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rend</span> <span class="o">==</span> <span class="n">prev_rendition</span><span class="p">:</span>
                    <span class="c"># Shortcut...  So we can skip all the logic below</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prev_rendition</span> <span class="o">=</span> <span class="n">rend</span>
                <span class="k">if</span> <span class="n">changed</span> <span class="ow">and</span> <span class="n">rend</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">classes</span> <span class="o">=</span> <span class="n">imap</span><span class="p">(</span><span class="n">rendition_classes</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">rend</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_class</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">_class</span> <span class="ow">and</span> <span class="n">_class</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_classes</span><span class="p">:</span>
                            <span class="c"># Something changed...  Start a new span</span>
                            <span class="k">if</span> <span class="n">spancount</span><span class="p">:</span>
                                <span class="n">outline</span> <span class="o">+=</span> <span class="s">&quot;&lt;/span&gt;&quot;</span>
                                <span class="n">spancount</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="s">&#39;reset&#39;</span> <span class="ow">in</span> <span class="n">_class</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">_class</span> <span class="o">==</span> <span class="s">&#39;reset&#39;</span><span class="p">:</span>
                                    <span class="n">current_classes</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">reset_class</span> <span class="o">=</span> <span class="n">_class</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;reset&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="n">reset_class</span> <span class="o">==</span> <span class="s">&#39;foreground&#39;</span><span class="p">:</span>
                                        <span class="c"># Remove any foreground classes</span>
                                        <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                        <span class="n">foregrounds</span>
                                        <span class="p">]</span>
                                    <span class="k">elif</span> <span class="n">reset_class</span> <span class="o">==</span> <span class="s">&#39;background&#39;</span><span class="p">:</span>
                                        <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                        <span class="n">backgrounds</span>
                                        <span class="p">]</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">current_classes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">reset_class</span><span class="p">)</span>
                                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                            <span class="c"># Trying to reset something that was</span>
                                            <span class="c"># never set.  Ignore</span>
                                            <span class="k">pass</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">_class</span> <span class="ow">in</span> <span class="n">foregrounds</span><span class="p">:</span>
                                    <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                    <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                    <span class="n">foregrounds</span>
                                    <span class="p">]</span>
                                <span class="k">elif</span> <span class="n">_class</span> <span class="ow">in</span> <span class="n">backgrounds</span><span class="p">:</span>
                                    <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                    <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                    <span class="n">backgrounds</span>
                                    <span class="p">]</span>
                                <span class="n">current_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_class</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_classes</span><span class="p">:</span>
                        <span class="n">outline</span> <span class="o">+=</span> <span class="s">&#39;&lt;span class=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;&#39;</span> <span class="o">%</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span>
                        <span class="n">spancount</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">linecount</span> <span class="o">==</span> <span class="n">cursorY</span> <span class="ow">and</span> <span class="n">charcount</span> <span class="o">==</span> <span class="n">cursorX</span><span class="p">:</span> <span class="c"># Cursor position</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_cursor</span><span class="p">:</span>
                        <span class="n">outline</span> <span class="o">+=</span> <span class="s">&#39;&lt;span class=&quot;cursor&quot;&gt;</span><span class="si">%s</span><span class="s">&lt;/span&gt;&#39;</span> <span class="o">%</span> <span class="n">char</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">outline</span> <span class="o">+=</span> <span class="n">char</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outline</span> <span class="o">+=</span> <span class="n">char</span>
                <span class="n">charcount</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">outline</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outline</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span> <span class="c"># &#39;null&#39; is shorter than &gt; 4 spaces</span>
            <span class="c"># NOTE: The client has been programmed to treat None (aka null in</span>
            <span class="c">#       JavaScript) as blank lines.</span>
        <span class="k">for</span> <span class="n">whatever</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">spancount</span><span class="p">):</span> <span class="c"># Bit of cleanup to be safe</span>
            <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&quot;&lt;/span&gt;&quot;</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">__spanify_scrollback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Spanifies everything inside *screen* using *renditions*.  This differs</span>
<span class="sd">        from __spanify_screen() in that it doesn&#39;t apply any logic to detect the</span>
<span class="sd">        location of the cursor (to make it just a tiny bit faster).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># NOTE: See the comments in __spanify_screen() for details on this logic</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">screen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span>
        <span class="n">renditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_renditions</span>
        <span class="n">rendition_classes</span> <span class="o">=</span> <span class="n">RENDITION_CLASSES</span>
        <span class="n">spancount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">current_classes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">prev_rendition</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">foregrounds</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;f0&#39;</span><span class="p">,</span><span class="s">&#39;f1&#39;</span><span class="p">,</span><span class="s">&#39;f2&#39;</span><span class="p">,</span><span class="s">&#39;f3&#39;</span><span class="p">,</span><span class="s">&#39;f4&#39;</span><span class="p">,</span><span class="s">&#39;f5&#39;</span><span class="p">,</span><span class="s">&#39;f6&#39;</span><span class="p">,</span><span class="s">&#39;f7&#39;</span><span class="p">)</span>
        <span class="n">backgrounds</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;b0&#39;</span><span class="p">,</span><span class="s">&#39;b1&#39;</span><span class="p">,</span><span class="s">&#39;b2&#39;</span><span class="p">,</span><span class="s">&#39;b3&#39;</span><span class="p">,</span><span class="s">&#39;b4&#39;</span><span class="p">,</span><span class="s">&#39;b5&#39;</span><span class="p">,</span><span class="s">&#39;b6&#39;</span><span class="p">,</span><span class="s">&#39;b7&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">rendition</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">screen</span><span class="p">,</span> <span class="n">renditions</span><span class="p">):</span>
            <span class="n">outline</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">char</span><span class="p">,</span> <span class="n">rend</span> <span class="ow">in</span> <span class="n">izip</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">rendition</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">char</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c"># Special stuff =)</span>
                    <span class="c"># Obviously, not really a single character</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">Image</span><span class="p">:</span> <span class="c"># Can&#39;t use images in the terminal</span>
                        <span class="n">outline</span> <span class="o">+=</span> <span class="s">&quot;&lt;i&gt;Image file&lt;/i&gt;&quot;</span>
                        <span class="k">continue</span> <span class="c"># Can&#39;t do anything else</span>
                    <span class="n">image_data</span> <span class="o">=</span> <span class="n">char</span>
                    <span class="c"># PIL likes file objects</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                        <span class="c"># i.e. PIL couldn&#39;t identify the file</span>
                        <span class="n">outline</span> <span class="o">+=</span> <span class="s">&quot;&lt;i&gt;Image file&lt;/i&gt;&quot;</span>
                        <span class="k">continue</span> <span class="c"># Can&#39;t do anything else</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">50000</span><span class="p">:</span> <span class="c"># TODO: Make this adjustable</span>
                        <span class="c"># Probably too big to send to browser as a data URI.</span>
                        <span class="k">if</span> <span class="n">im</span><span class="p">:</span> <span class="c"># Resize it...</span>
                            <span class="c"># 640x480 should come in &lt;32k for most stuff</span>
                            <span class="n">im</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">((</span><span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">),</span> <span class="n">Image</span><span class="o">.</span><span class="n">ANTIALIAS</span><span class="p">)</span>
                            <span class="n">f</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
                            <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">format</span><span class="p">)</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="c"># Convert back to bytearray</span>
                            <span class="n">image_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                        <span class="k">else</span><span class="p">:</span> <span class="c"># Generic error</span>
                            <span class="n">outline</span> <span class="o">+=</span> <span class="s">&quot;&lt;i&gt;Problem displaying this image&lt;/i&gt;&quot;</span>
                            <span class="k">continue</span>
                    <span class="c"># Need to encode base64 to create a data URI</span>
                    <span class="n">encoded</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">image_data</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">data_uri</span> <span class="o">=</span> <span class="s">&quot;data:image/</span><span class="si">%s</span><span class="s">;base64,</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">im</span><span class="o">.</span><span class="n">format</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">encoded</span><span class="p">)</span>
                    <span class="n">outline</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&lt;img src=&quot;</span><span class="si">%s</span><span class="s">&quot; width=&quot;</span><span class="si">%s</span><span class="s">&quot; height=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">data_uri</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">continue</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="s">&quot;&amp;&lt;&gt;&quot;</span><span class="p">:</span>
                    <span class="c"># Have to convert ampersands and lt/gt to HTML entities</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&amp;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;amp;&#39;</span><span class="p">)</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;lt;&#39;</span><span class="p">)</span>
                    <span class="n">char</span> <span class="o">=</span> <span class="n">char</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&amp;gt;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rend</span> <span class="o">==</span> <span class="n">prev_rendition</span><span class="p">:</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prev_rendition</span> <span class="o">=</span> <span class="n">rend</span>
                <span class="k">if</span> <span class="n">changed</span> <span class="ow">and</span> <span class="n">rend</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">classes</span> <span class="o">=</span> <span class="n">imap</span><span class="p">(</span><span class="n">rendition_classes</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">rend</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">_class</span> <span class="ow">in</span> <span class="n">classes</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">_class</span> <span class="ow">and</span> <span class="n">_class</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_classes</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">spancount</span><span class="p">:</span>
                                <span class="n">outline</span> <span class="o">+=</span> <span class="s">&quot;&lt;/span&gt;&quot;</span>
                                <span class="n">spancount</span> <span class="o">-=</span> <span class="mi">1</span>
                            <span class="k">if</span> <span class="s">&#39;reset&#39;</span> <span class="ow">in</span> <span class="n">_class</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">_class</span> <span class="o">==</span> <span class="s">&#39;reset&#39;</span><span class="p">:</span>
                                    <span class="n">current_classes</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">reset_class</span> <span class="o">=</span> <span class="n">_class</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;reset&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="n">reset_class</span> <span class="o">==</span> <span class="s">&#39;foreground&#39;</span><span class="p">:</span>
                                        <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                        <span class="n">foregrounds</span>
                                        <span class="p">]</span>
                                    <span class="k">elif</span> <span class="n">reset_class</span> <span class="o">==</span> <span class="s">&#39;background&#39;</span><span class="p">:</span>
                                        <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                        <span class="n">backgrounds</span>
                                        <span class="p">]</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">current_classes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">reset_class</span><span class="p">)</span>
                                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                            <span class="k">pass</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">_class</span> <span class="ow">in</span> <span class="n">foregrounds</span><span class="p">:</span>
                                    <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                    <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                    <span class="n">foregrounds</span>
                                    <span class="p">]</span>
                                <span class="k">elif</span> <span class="n">_class</span> <span class="ow">in</span> <span class="n">backgrounds</span><span class="p">:</span>
                                    <span class="p">[</span><span class="n">current_classes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span>
                                    <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span>
                                    <span class="n">backgrounds</span>
                                    <span class="p">]</span>
                                <span class="n">current_classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_class</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_classes</span><span class="p">:</span>
                        <span class="n">outline</span> <span class="o">+=</span> <span class="s">&#39;&lt;span class=&quot;</span><span class="si">%s</span><span class="s">&quot;&gt;&#39;</span> <span class="o">%</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_classes</span><span class="p">)</span>
                        <span class="n">spancount</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">outline</span> <span class="o">+=</span> <span class="n">char</span>
            <span class="k">if</span> <span class="n">outline</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outline</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">whatever</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">spancount</span><span class="p">):</span> <span class="c"># Bit of cleanup to be safe</span>
            <span class="n">results</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&quot;&lt;/span&gt;&quot;</span>
        <span class="k">return</span> <span class="n">results</span>

<div class="viewcode-block" id="Terminal.dump_html"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.dump_html">[docs]</a>    <span class="k">def</span> <span class="nf">dump_html</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dumps the terminal screen as a list of HTML-formatted lines.</span>

<span class="sd">        Note: This places &lt;span class=&quot;cursor&quot;&gt;(current character)&lt;/span&gt; around</span>
<span class="sd">        the cursor location.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># NOTE: On my laptop this function will take about 30ms to complete</span>
        <span class="c"># a full-screen &#39;top&#39; refresh on a 57x209 screen.</span>
        <span class="c"># In other words, it is pretty fast...  Not much optimization necessary</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__spanify_screen</span><span class="p">()</span>
        <span class="n">scrollback</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span><span class="p">:</span>
            <span class="n">scrollback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__spanify_scrollback</span><span class="p">()</span>
        <span class="c"># Empty the scrollback buffer:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_scrollback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">scrollback</span><span class="p">,</span> <span class="n">results</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Terminal.dump_plain"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.dump_plain">[docs]</a>    <span class="k">def</span> <span class="nf">dump_plain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dumps the screen and the scrollback buffer as-is then empties the</span>
<span class="sd">        scrollback buffer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">screen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span>
        <span class="n">scrollback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span>
        <span class="c"># Empty the scrollback buffer:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_scrollback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">scrollback</span><span class="p">,</span> <span class="n">screen</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Terminal.dump_components"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.dump_components">[docs]</a>    <span class="k">def</span> <span class="nf">dump_components</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dumps the screen and renditions as-is, the scrollback buffer as HTML,</span>
<span class="sd">        and the current cursor coordinates.  Also, empties the scrollback buffer</span>

<span class="sd">        NOTE: Was used in some performance-related experiments but might be</span>
<span class="sd">        useful for other patterns in the future so I&#39;ve left it here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">screen</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">tounicode</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">]</span>
        <span class="n">scrollback</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span><span class="p">:</span>
            <span class="c"># Process the scrollback buffer into HTML</span>
            <span class="n">scrollback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__spanify_scrollback</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_buf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scrollback_renditions</span><span class="p">)</span>
        <span class="c"># Empty the scrollback buffer:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_scrollback</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">scrollback</span><span class="p">,</span> <span class="n">screen</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">renditions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorY</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cursorX</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Terminal.dump"><a class="viewcode-back" href="../Developer/terminal.html#terminal.Terminal.dump">[docs]</a>    <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns self.screen as a list of strings with no formatting.</span>
<span class="sd">        No scrollback buffer.  No renditions.  It is meant to be used to get a</span>
<span class="sd">        quick glance of what is being displayed (when debugging).</span>

<span class="sd">        .. note:: This method does not empty the scrollback buffer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="n">out</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/ls_logo_1inch_300dpi.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../index.html">Gate One Documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Liftoff Software Corporation.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>